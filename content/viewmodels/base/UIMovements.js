/**
 @preserve
 Copyright (c) 2001-2020 by Wincor Nixdorf International GmbH,
 Heinz-Nixdorf-Ring 1, 33106 Paderborn, Germany

 This software is the confidential and proprietary information
 of Diebold Nixdorf.
 You shall not disclose such Confidential Information and shall
 use it only in accordance with the terms of the license agreement
 you entered into with Diebold Nixdorf.

 @module ObjectManager

$MOD$ UIMovements.js 4.3.1-201130-21-086c3328-1a04bc7d
 */
define(["jquery","knockout","ui-content","lib/hammer.min","extensions","config/Config","vm-util/UICommanding","lib/jquery.transit.min"],(function(t,i,e,n,s,o,r){"use strict";const l=Wincor.UI.Service.Provider.LogProvider;let a=null,h=200;const c={Pan:{events:["pan","panstart","panmove","panend","pancancel","panleft","panright","panup","pandown"],defaultEvents:["panstart","panmove","panend"]},Pinch:{events:["pinch","pinchstart","pinchmove","pinchend","pinchcancel","pinchin","pinchout"],defaultEvents:["pinch"]},Press:{events:["press","pressup"],defaultEvents:["press","pressup"]},Rotate:{events:["rotate","rotatestart","rotatemove","rotateend","rotatecancel"],defaultEvents:["rotate"]},Swipe:{events:["swipe","swipeleft","swiperight","swipeup","swipedown"],defaultEvents:["swipe"]},Tap:{events:["tap"],defaultEvents:["tap"]}},g="panmove panstart panend";let d=function(){this.trigger=i.observable(Date.now()),this.triggerUpdate=function(){let t=Date.now();t===this.trigger()&&(t+=1),this.trigger(t)},this.mobs=[],this.containerIds=new Set,this.grids={},this.getElementById=function(t){let i,e;for(i=0;i<this.mobs.length;i++)if(e=this.mobs[i],e.element.id===t)return e;return null},this.designMode=e.designMode,this._touchedNotified=!1,this.touched=function(){this._touchedNotified||this.designMode||!this.mobs||0===this.mobs.length||this._touchedNotified||(this._touchedNotified=!0,Wincor.UI.Service.Provider.ViewService.refreshTimeout(),window.setTimeout((()=>{this._touchedNotified=!1}),1e3))},this.getElementOrder=function(i,e){let n={order:[],prominent:[]};return i=i||Object.keys(this.grids).filter((function(t){return"window"!==t}))[0],e=e||"prominentItem",this.getElementsByContainer(i).sort((function(t,i){let e=t.getLogicalPosition(),n=i.getLogicalPosition();return Math.pow(2,e.x+1)+e.y+1-(Math.pow(2,n.x+1)+n.y+1)})).map((function(i){if(i.grid){let s=i.element.id;n.order.push(s),t("#"+i.element.id).children().first("div").hasClass(e)&&n.prominent.push(s+"="+e)}})),n},this.getContainerIds=function(){return Array.from(this.containerIds)},this.reCalculateObjects=async function(t=[]){l.LOG_DETAIL&&l.log(l.LOG_DETAIL,`> ObjectManager::reCalculateObjects(${t})`),"string"==typeof t&&(t=[t]);let i=t.length>0?t:this.getContainerIds();i.forEach((t=>{this.grids[t]=void 0,this.getElementsByContainer(t).forEach((t=>{t.lastPosition=void 0,t.jElement.css({x:0,y:0},0,"linear"),t.calculateDimensions(),t.containment&&t.containment.element&&(t.containment=this.calculateContainmentByElement({element:t.containment.element,useScrollWidth:!0})),t.grid&&t.grid.element&&(t.grid=this.calculateGridByElement(t.grid.element)),t.x=0,t.y=0,t.calculateLogicalPositions(),t.scrollbar&&t.calculateScrollbar()}))})),await s.Promises.serializeProcessing(i,this.snapAllToGrid.bind(this)),await s.Promises.serializeProcessing(i,this.pack.bind(this)),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< ObjectManager::reCalculateObjects")},this.initialized={},this.calculateLogicalPositions=function(){l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> ObjectManager::calculateLogicalPositions()"),this.mobs.forEach((t=>{t.calculateLogicalPositions()})),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< ObjectManager::calculateLogicalPositions")},this.add=function(i){let n=new E(i);n.objectManager=this,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"* ObjectManager::add for element "+n.element.id),this.mobs.push(n),n.containerId&&this.containerIds.add(n.containerId),n.grid&&(n.calculateLogicalPositions(),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"* ObjectManager::add triggering initial notification "+n.element.id),n.getNearestGrid(n.getPosition())),n.calculateScrollbar(),n.options&&!1!==n.options.initialSnap&&e.ViewModelContainer.whenActivated().then(function(i){return i.snapToGrid(void 0,void 0,"easeInOutSine").then((()=>i.containerId in this.initialized&&void 0!==this.initialized[i.containerId]?s.Promises.Promise.resolve():(this.initialized[i.containerId]=!0,this.pack(i.containerId)))).then((function(){if(i.options&&!1!==i.options.initialMove){let e=200,n="easeInOutSine",s=20;i.canMoveHorizontally&&i.canMoveVertically?t(i.element).transition({x:-s},e,n).transition({y:s},e,n).transition({x:0},e,n).transition({y:0},e,n):i.canMoveHorizontally?t(i.element).transition({x:-s},e,n).transition({x:0},e,n):i.canMoveVertically&&t(i.element).transition({y:s},e,n).transition({y:0},e,n)}}))}.bind(this,n))},this.clear=function(){let t=s.Promises.Promise.resolve();Object.keys(r.commands).length>0&&(t=s.Promises.serializeProcessing(this.mobs.filter((function(t){return t.grid&&(t.elementWidthGreaterThanContainment||t.elementHeightGreaterThanContainment)})),(function(t){return t.moveToLogicalPosition(0,0,-1,void 0,!0)}))),0===this.mobs.length&&t.then((()=>{this.remove(),this.grids={},this.mobs=[],this.initialized={},this._touchedNotified=!1}))},this.remove=function(t){l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> ObjectManager::remove("+t+")");let i=!t;for(let e=this.mobs.length-1;e>=0;e--){let n=this.mobs[e];if(i||n.boundToElement===t){let t=n.containerId;n.dispose(),this.mobs.splice(e,1),0===this.getElementsByContainer(t).length&&this.grids[t]&&(this.grids[t]=void 0,this.initialized[t]=void 0)}}l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< ObjectManager::remove")},this.getElementsByContainer=function(t){let i=[];for(let e=0;e<this.mobs.length;e++){let n=this.mobs[e];n.containerId===t&&i.push(n)}return i},this.getParentContainer=function(t){let i="";return this.mobs.forEach((function(e){e.element.id===t&&""===i&&(i=e.containerId)})),i},this.occupyGridPosition=function(t,i,e){if(!t.hasGrid()||t.elementWidthGreaterThanContainment||t.elementHeightGreaterThanContainment||this.getElementsByContainer(t.containerId).length<2)return void this.dumpScreen(t.containerId);let n=i||t.getPosition();e||l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ObjectManager::occupyGridPosition("+t.element.id+", "+JSON.stringify(i)+")");let s=t.containerId,o=this.grids[s],r=o.left.indexOf(n.left),a=o.top.indexOf(n.top);if(r<0||a<0)return void(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ObjectManager::occupyGridPosition ERROR: no position found for "+JSON.stringify(n)));let h=t.getLogicalDimensions();for(let i=0;i<h.width;i++)for(let n=0;n<h.height;n++)try{let s=o.logicalPositions2dArray[r+i][a+n];e?s&&s.splice(s.indexOf(t.element.id),1):s?s.push(t.element.id):o.logicalPositions2dArray[r+i][a+n]=[s]}catch(t){}this.dumpScreen(s)},this.freeGridPosition=function(t,i){if(!t.hasGrid())return;let e=i||t.getPosition();return l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ObjectManager::freeGridPosition("+t.element.id+", "+JSON.stringify(e)+")"),this.occupyGridPosition(t,e,!0)},this.clearGridPositions=function(t){this.mobs.filter((i=>i.containerId===t)).forEach((t=>{this.freeGridPosition(t)}))},this.enlargeGridWidth=function(t,i,e=!0){if(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> ObjectManager::enlargeGridWidth() for "+t.element.id),!this.grids[t.containerId])return s.Promises.Promise.resolve();this.dumpScreen(t.containerId);let n=this.grids[t.containerId].left.slice().sort(((t,i)=>i-t))[0];this.grids[t.containerId].left.push(n+t.grid.width),this.grids[t.containerId].logicalPositions2dArray.push([[],[]]);let o=i.slice().sort(((t,i)=>this.getLogicalPosition(t).x-this.getLogicalPosition(i).x))[0],r=this.getElementsByContainer(t.containerId),a=t.getPosition(),c=o.getPosition(),g=a.left+a.width/2>c.left+c.width/2?t.grid.width:0,d=r.filter((i=>{let e=i.getPosition();return!(!e||i===t||i===t)&&e.left>=o.getPosition().left+g})).sort(((t,i)=>this.getLogicalPosition(t).x-this.getLogicalPosition(i).x));return s.Promises.serializeProcessing(d,(t=>t.moveRight())).then((()=>{if(e)return t.snapToGrid()})).delay(h).then((()=>{if(e)return this.pack(t.containerId)})).then((()=>{let i=this.getParentContainer(t.containerId);if("window"===i){let e=this.getElementsByContainer(i).find((i=>i.boundToElement&&i.boundToElement.id===t.containerId));e?(n=this.grids[i].left.slice().sort(((t,i)=>t-i))[0],this.grids[i].left.push(n-e.grid.width),this.grids[i].logicalPositions2dArray.push([[],[]]),this.dumpScreen(t.containerId),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< ObjectManager::enlargeGridWidth for "+t.element.id)):l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< ObjectManager::enlargeGridWidth could not find parent container for "+t.element.id)}}))},this.isColumnFree=function(t,i,e,n,s){l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> ObjectManager::isColumnFree(xStart="+t+", yStart="+i+", "+e+", "+n+")");let o=!0;void 0===s&&(s=0),i=i||0;const r=n?n[s]:void 0;let a,h;s++;const c=this.getGrid(e),g=c.top.length-i;if(g<=0)o=!1;else{const d=r?r.getLogicalDimensions().width:1,m=r?r.getLogicalDimensions().height:g,f=r?g-r.getLogicalDimensions().height:0;for(h=0;h<=f;h++){o||(o=!0);for(let e=t;e<t+d;e++)for(let t=h+i;t<m+h+i;t++)o=o&&(!c.logicalPositions2dArray[e][t]||0===c.logicalPositions2dArray[e][t].length)}o&&n&&s<n.length&&(a=h+i,o=this.isColumnFree(t,a,e,n,s)),o&&l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". | SPACE ObjectManager::isColumnFree "+t+"/"+i+" returns "+o)}return l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< ObjectManager::isColumnFree returns "+o),o},this.organizeAll=function(t){let i=0,e=0,n=this.getElementsByContainer(t).sort(((t,i)=>{let e=t.getLogicalPosition(),n=i.getLogicalPosition();return e&&n?Math.pow(2,e.x+1)+e.y+1-(Math.pow(2,n.x+1)+n.y+1):0}));if(n.length<2)return s.Promises.Promise.resolve();const o=this.getGrid(t).top.length;return s.Promises.serializeProcessing(n,(t=>{let n=t.getLogicalDimensions().height;e+n>o&&(i++,e=0);let s=t.moveToLogicalPosition(i,e);return e+=n,e>=o&&(i+=1,e=0),s}))},this.snapAllToGrid=function(t){return s.Promises.Promise.all(this.getElementsByContainer(t).map((t=>t.snapToGrid())))},this.packAll=function(){return s.Promises.serializeProcessing(this.getContainerIds(),(t=>this.pack(t)))},this.pack=function(i){return s.Promises.promise(((e,n)=>{l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> | SPACE ObjectManager::pack() for "+i);let o=this.grids[i],r=this.getElementsByContainer(i);o&&"window"!==i&&r.length>1&&void 0===r[0].listElementName?this.organizeAll(i).then((()=>{let t=[],e=!1;for(let n=o.left.length-1;n>=0;n--)this.isColumnFree(n,0,i)?e?t.push(n):(this.grids[i].left.splice(n,1),this.grids[i].logicalPositions2dArray.splice(n,1)):e=!0;return s.Promises.serializeProcessing(t,(t=>{let e=this.getElementsByContainer(i).filter((i=>this.getLogicalPosition(i).x>t)).sort(((t,i)=>this.getLogicalPosition(t).x-this.getLogicalPosition(i).x));return s.Promises.serializeProcessing(e,(t=>(t.moveLeft(h,"ease"),s.Promises.Promise.resolve())))}))})).then((()=>{l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< | SPACE ObjectManager::pack for "+i);let e=this.getElementsByContainer(i)[0],n=this.getParentContainer(i);if(n){let s=this.grids[i].left.length-Math.floor(t(window).width()/e.grid.width)+1,o=this.grids[n].left.length-s;return this.grids[n].left.splice(s,o),this.grids[n].logicalPositions2dArray.splice(s,o),this.getElementsByContainer(n)[0].snapToGrid()}})).then(e):(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< | SPACE ObjectManager::pack for "+i+" - no packing"),e())}))},this.getLogicalPosition=function(t,i=!1){if("string"==typeof t&&(t=this.getElementById(t)),t.gridPositions){let e,n,s=i?t.lastPosition:t.getPosition();if(e=t.gridPositions.left.indexOf(s.left),n=t.gridPositions.top.indexOf(s.top),isNaN(e)||isNaN(n)||e===1/0||n===1/0)throw new Error("UIMovements::getLogicalPosition("+t.element.id+") returns invalid values");if(-1!==e&&-1!==n)return{x:e,y:n}}return null},this.dumpScreen=function(t){if(!l.LOG_DETAIL)return;let i=this.grids[t],e="line1:";for(let t=0;t<i.logicalPositions2dArray[0].length;t++){for(let n=0;n<i.logicalPositions2dArray.length;n++)e+=JSON.stringify(i.logicalPositions2dArray[n][t])+"\t";l.LOG_DETAIL&&l.log(l.LOG_DETAIL,e),e="line"+(t+2)+":"}l.LOG_DETAIL&&l.log(l.LOG_DETAIL,e)},this.isGridPositionFree=function(t,i){if(i.elementWidthGreaterThanContainment||i.elementHeightGreaterThanContainment||this.getElementsByContainer(i.containerId).length<2)return!0;let e=i.containerId,n=this.grids[e];if(n){let e=void 0!==t.x?t.x:n.left.indexOf(t.left),s=void 0!==t.y?t.y:n.top.indexOf(t.top),o=!0,r=i.getLogicalDimensions(),l=!1;for(let t=r.width-1;t>=0&&!l;t--)for(let i=r.height-1;i>=0&&!l;i--){let r;try{if(!(n.logicalPositions2dArray.length>e+t&&n.logicalPositions2dArray[e+t].length>s+i))return!1;r=n.logicalPositions2dArray[e+t][s+i]}catch(t){return!0}if(void 0===r)return!0;o=o&&0===r.length}return o}return!0},this.collisionDetectionRunning=!1,this.handleCollisions=function(t,i,e){return this.collisionDetectionRunning?s.Promises.Promise.reject():s.Promises.promise(((n,o)=>{let r=i.minCoverage||40;l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> | SPACE ObjectManager::handleCollisions() for "+i.element.id);let a=[],h=this.getElementsByContainer(i.containerId),c=h.indexOf(i);-1!==c&&h.splice(c,1);let g,d,m,f,p,u,L,I,y=e;for(c=h.length-1;c>=0;c--){let t=h[c].getPosition();g=t.left,d=t.right,m=y.left,f=y.right,p=t.top,u=t.bottom,L=y.top,I=y.bottom;let e=0,n=0,s=0,o=g>m&&g<f,E=g<=m&&d>=f,O=g>=m&&d<=f,v=g<=m&&d>=m,G=p<=L&&u<=I,b=p<=L&&u>=I,T=p>=L&&u<=I,P=p<=I&&L<p;if(!h[c].moving&&(o||O||E||v)&&(P||T||b||G)){if((E||O)&&(b||T))s=100;else{o?(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: srcObject comes from left"),e=f-g):v?(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: srcObject comes from right"),e=d-m):e=d-g,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: verticalCoverage "+e),P?(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: srcObject comes from above"),n=I-p):G?(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: srcObject comes from below"),n=u-L):n=d-g,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: horizontalCoverage "+n);let t=e*n;l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: coverage "+t),s=100*t/((u-p)*(d-g)),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: coveragePercentage: "+s)}l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"coverage: "+s);let t=!1;h[c].coverage&&(t=h[c].coverage>s),h[c].coverage=s,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col dir: "+i.element.id+(t?" leaving ":" entering ")+h[c].element.id),!t&&s>r?(h[c].coverage=100,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: COLLISION DETECTED with "+h[c].element.id+"!"),h[c].collisionCounter++,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"colCount set: "+h[c].element.id+" -> "+h[c].collisionCounter),a.push(h[c])):h[c].collisionCounter=0}}if(a.length){let e=s.Promises.Promise.resolve();i.hasOwnProperty("collisionHandler")&&(e=i.collisionHandler(t,i,a,this),e.then||(e=s.Promises.Promise.resolve(e))),e.then((()=>{this.collisionDetectionRunning=!1,n(a.length)}))}else l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< | SPACE ObjectManager::handleCollisions for "+i.element.id+" no collisions"),this.collisionDetectionRunning=!1,n(a.length)}))},this.collisionHandler=function(t,i,e){return s.Promises.serializeProcessing(e,(t=>t.snapToGrid(void 0,void 0,void 0,!0))).then((t=>{if(t.indexOf(!1)>-1)return this.enlargeGridWidth(i,e,!1).then((()=>s.Promises.serializeProcessing(e,(function(t){return t.snapToGrid(void 0,void 0,void 0,!0)})))).finally((()=>{this.collisionDetectionRunning=!1}));this.collisionDetectionRunning=!1}))},this.calculateGridByElement=function(t){return this.calculateContainmentByElement(t,!0)},this.getGrid=function(t){return t in this.grids?this.grids[t]:null},this.calculateVisibleSize=function(i){let e,n,s,o,r,l,a,h,c,g,d,m,f,p,u=t(i),L=t(window);return l=L.scrollTop(),r=l+L.height(),n=u.offset().top,e=n+u.outerHeight(),h=n<l?l:n,a=e>r?r:e,c=a-h,g=L.scrollLeft(),d=g+L.width(),s=u.offset().left,o=s+u.outerWidth(),m=s<g?g:s,f=o>d?d:o,p=f-m,{top:h,bottom:a,height:c,left:m,right:f,width:p}},this.calculateContainmentByElement=function(i,e=!1){let n="";if("object"==typeof i){if(!i.element)return i;n=i.element}else"string"==typeof i&&(n=i);let s,o={};n.startsWith("#")||n.startsWith(".")?s=t(n):(s=t(`#${n}`)[0],s||(s=t(`.${n}`)[0]));let r=t(window);if(s||"window"===n)if("window"===n){let t=r.width(),i=r.height();o={left:0,width:t,right:t,top:0,height:i,bottom:i,element:n}}else{let r=t(s),a=r.css("margin");-1===a.indexOf("%")&&-1===a.indexOf("auto")&&-1===a.indexOf("inherit")||l.error("Calculating margins depends on pixel values but "+s.id+" uses relatives...");let h=a.split(" "),c={top:isNaN(parseInt(h[0]))?0:parseInt(h[0]),right:isNaN(parseInt(h[1]))?0:parseInt(h[1]),bottom:isNaN(parseInt(h[2]))?0:parseInt(h[2]),left:isNaN(parseInt(h[3]))?0:parseInt(h[3])},g=r.css("padding");-1===g.indexOf("%")&&-1===g.indexOf("auto")&&-1===g.indexOf("inherit")||l.error("Calculating padding depends on pixel values but "+s.id+" uses relatives..."),h=g.split(" ");let d={top:isNaN(parseInt(h[0]))?0:parseInt(h[0]),right:isNaN(parseInt(h[1]))?0:parseInt(h[1]),bottom:isNaN(parseInt(h[2]))?0:parseInt(h[2]),left:isNaN(parseInt(h[3]))?0:parseInt(h[3])},m=r.offset(),f=m.left-c.left+d.left,p=m.top-c.top+d.top;o.element=n,e?(o.left=f,o.width=r.outerWidth(!0),o.right=f+r.outerWidth(!0),o.top=p,o.height=r.outerHeight(!0),o.bottom=p+r.outerHeight(!0)):(t.extend(o,this.calculateVisibleSize(r)),o.left=f,o.top=p,!0===i.useScrollWidth&&(o.width=r[0].scrollWidth+(c.left+c.right)+(d.left+d.right),o.right=f+r[0].scrollWidth+c.right+d.right),!0===i.useScrollHeight&&(o.height=r[0].scrollHeight+(c.top+c.bottom)+(d.top+d.bottom),o.bottom=p+r[0].scrollHeight+c.bottom+d.bottom))}return o}};d=new d,e.ObjectManager=d,e.designMode&&(window.ObjectManager=d);const m="panstart",f="panend",p="press",u=function(t){return-1!==t.indexOf("panmove")},L=function(t){return-1!==t.indexOf("swipe")},I=function(t){return!!(t&n.DIRECTION_VERTICAL)},y=function(t){return!!(t&n.DIRECTION_HORIZONTAL)};let E=function(i){let o=e.designMode?"<n/a>":Wincor.UI.Service.Provider.ViewService.viewContext.viewKey,r=i.element,E=i.target,O=i.options,v=i.gestures,G=i.containment,b=i.containerId,T=i.listElementName;this.scrollbar={},this.notificationHandler=i.notificationHandler,this.collisionCounter=0,this.notify=function(t){if(this.notificationHandler)try{this.notificationHandler(t)}catch(t){l.error("Error in notification handler for gesture binding of element "+r.id+" -> "+t)}},this.containment=G||{left:0,right:1024,top:0,bottom:768,width:1024,height:768},this.elementWidthGreaterThanContainment=!1,this.elementHeightGreaterThanContainment=!1,this.calculateLogicalPositions=function(){if(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,`> GestureElement::calculateLogicalPositions() for ${this.element.id}`),this.grid&&this.containerId){if(!this.objectManager.grids[this.containerId]){this.objectManager.grids[this.containerId]=this.getGridPositions(),this.objectManager.grids[this.containerId].logicalPositions2dArray=[this.objectManager.grids[this.containerId].left.length];for(let t=0;t<this.objectManager.grids[this.containerId].left.length;t++){this.objectManager.grids[this.containerId].logicalPositions2dArray[t]=[this.objectManager.grids[this.containerId].top.length];for(let i=0;i<this.objectManager.grids[this.containerId].top.length;i++)this.objectManager.grids[this.containerId].logicalPositions2dArray[t][i]=[]}}this.gridPositions=this.objectManager.grids[this.containerId],l.LOG_DETAIL&&l.log(l.LOG_DETAIL,`. GestureElement::calculateLogicalPositions: ${JSON.stringify(this.gridPositions)}`)}else l.LOG_DETAIL&&l.log(l.LOG_DETAIL,`. GestureElement::calculateLogicalPositions no grid or containerId for ${this.element.id}`);l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< GestureElement::calculateLogicalPositions")},this.calculateDimensions=function(){l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> GestureElement::calculateDimensions()"),this.jElement=t(this.element),this.elementWidth=this.jElement[0].scrollWidth,this.elementHeight=this.jElement[0].scrollHeight,this.lastPosition||(this.lastPosition={x:0,y:0},this.xStart=this.jElement.offset().left,this.yStart=this.jElement.offset().top),this.elementWidthGreaterThanContainment=void 0!==O.overlayContainmentHorizontal?O.overlayContainmentHorizontal:this.elementWidth>this.containment.width,this.elementHeightGreaterThanContainment=void 0!==O.overlayContainmentVertical?O.overlayContainmentVertical:this.elementHeight>this.containment.height,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< GestureElement::calculateDimensions")},this.window={height:t(window).height(),width:t(window).width()},this.lastPosition=void 0,this.moving=!1,this.containerId=b,this.options=t.extend({initialMove:!0,initialSnap:!1,lockIfSpace:!0,notifyMovement:!0,processChildEvents:["tap","panstart","panmove","panend","swipe"],collisionHandler:d.collisionHandler.bind(d)},O),this.listElementName=T,this.element=E||r,this.options.processItemVisibility&&!this.listElementName&&l.error(`UIMovements - Invalid config: processItemVisibility has been configured without listElementName for '${this.element.id}' of '${o}'!`),this.recognizerOpts={},this.minCoverage=O.minCoverage,this.objectManager=null,this.bubbleEvent=!0,this.collisionHandler=this.options.collisionHandler,"function"!=typeof this.collisionHandler&&(l.error(`UIMovements - Invalid config: collisionHandler is not a function for '${this.element.id}' of '${o}'!`),this.collisionHandler=d.collisionHandler.bind(d)),this.notificationHandler&&"function"!=typeof this.notificationHandler&&(l.error(`UIMovements - Invalid config: notificationHandler is not a function for '${this.element.id}' of '${o}'!`),this.notificationHandler=null),this.grid=i.grid,this.gridPositions={},this.boundToElement=r,this.gestures=v||{},Object.keys(this.gestures).some((t=>t in c))||l.error(`UIMovements - Invalid config: No valid recognizer configured for '${this.element.id}' of '${o}'!`),this.canMoveHorizontally=!1,this.canMoveVertically=!1,this.x=0,this.y=0,this.xStart=void 0,this.yStart=void 0;const P=["element","target","options","gestures","containment","containerId","grid","listElementName","verticalScrollbarElementName","horizontalScrollbarElementName","notificationHandler"],D=["initialMove","initialSnap","lockIfSpace","notifyMovement","processChildEvents","collisionHandler","processItemVisibility","itemVisibilityTransitions","sendAutoMovementEvents","fadeOnDrag","overlayContainmentVertical","overlayContainmentHorizontal","minCoverage","minMove"];for(let t in i)P.includes(t)||l.error(`Invalid key '${t}' for GestureElement in '${r.id}' on viewKey ${o}`);for(let t in this.options)D.includes(t)||l.error(`Invalid key '${t}' for options of GestureElement in '${r.id}' on viewKey ${o}`);this.calculateDimensions(),this.calculateScrollbar=function(){if(i.verticalScrollbarElementName){let s=t("#"+i.verticalScrollbarElementName);if(0===s.length&&(s=t("."+i.verticalScrollbarElementName)),s.length>0||(t("#applicationHost>:first-child").append(`<div id="${i.verticalScrollbarElementName}" class="scrollbar-vertical"></div>`),s=t(`#${i.verticalScrollbarElementName}`)),this.scrollbar={vertical:{$element:s}},this.gridPositions&&this.gridPositions.top&&this.gridPositions.top.length>1){if(this.scrollbar&&this.scrollbar.vertical&&this.scrollbar.vertical.$element){const t=this.scrollbar.vertical,i=this.scrollbar.vertical.$element;let s=G.height/this.elementHeight,o=s*G.height;t.height=o,t.top=G.top,t.factor=s,t.y=0,t.x=0,t.yMin=0,t.yMax=G.height-o,i.css({display:"inline",position:"absolute",left:this.element.offsetLeft+this.element.offsetWidth,top:G.top,height:0}),i.transition({height:o}),this.scrollbar.vertical.mc=new n.Manager(i[0],{recognizers:[[n.Pan,{direction:n.DIRECTION_VERTICAL,enable:()=>!e.ViewModelContainer.isSuspended}]]}),this.scrollbar.vertical.mc.on(g,(e=>{if("panmove"===e.type){const n=t.y+e.deltaY;n>=0&&n<=this.containment.height-t.height&&(i.css({y:n}),e.fromScrollbar=!0,this.move(0,Math.round(-e.deltaY/s),e))}else"panend"===e.type&&(this.storeScrollbarPosition(),e.deltaY=-e.deltaY/s,e.fromScrollbar=!0,this.onGesture(e))}))}}else s.css({display:"none"})}if(i.horizontalScrollbarElementName){let s=t("#"+i.horizontalScrollbarElementName);if(0===s.length&&(s=t("."+i.horizontalScrollbarElementName)),s.length>0?(this.scrollbar||(this.scrollbar={}),this.scrollbar.horizontal={$element:s}):(t("#applicationHost>:first-child").append(`<div id="${i.horizontalScrollbarElementName}" class="scrollbar-horizontal"></div>`),s=t(`#${i.horizontalScrollbarElementName}`),this.scrollbar||(this.scrollbar={}),this.scrollbar.horizontal={$element:s}),this.gridPositions&&this.gridPositions.left&&this.gridPositions.left.length>1){if(this.scrollbar&&this.scrollbar.horizontal&&this.scrollbar.horizontal.$element){const t=this.scrollbar.horizontal,i=this.scrollbar.horizontal.$element;let s=G.width/this.elementWidth,o=s*G.width;t.width=o,t.left=G.left,t.factor=s,t.y=0,t.x=0,t.xMin=0,t.xMax=G.width-o,i.css({display:"inline",position:"fixed",left:G.left,top:this.element.offsetTop+this.element.offsetHeight,width:0}),i.transition({width:o}),this.scrollbar.horizontal.mc=new n.Manager(i[0],{recognizers:[[n.Pan,{direction:n.DIRECTION_HORIZONTAL,enable:()=>!e.ViewModelContainer.isSuspended}]]}),this.scrollbar.horizontal.mc.on(g,(e=>{if("panstart"===e.type);else if("panmove"===e.type){const n=t.x+e.deltaX;n>=0&&n<=this.containment.right-t.width&&(i.css({x:n}),e.fromScrollbar=!0,this.move(Math.round(-e.deltaX/s),0,e))}else"panend"===e.type&&(this.storeScrollbarPosition(),e.deltaX=-e.deltaX/s,e.fromScrollbar=!0,this.onGesture(e))}))}}else s.css({display:"none"})}},this.fadeOnDrag=!!this.options.fadeOnDrag,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,r.id+" pos: initial x="+this.xStart+" y="+this.yStart),this.scaled=!1,this.lastGesture={type:""},this.swipeVelocityFactor=4,this.swipeDefaultVelocity=1.2,this.bounceFunction="cubic-bezier(0.230, 1.000, 0.320, 1.000)",this.parent=void 0,this.processMoving=!0,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: elWidth: "+this.elementWidth+" - elementWidthGreaterThanContainment="+this.elementWidthGreaterThanContainment),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: elHeight: "+this.elementHeight+" - elementHeightGreaterThanContainment="+this.elementHeightGreaterThanContainment),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: containment = \n"+JSON.stringify(this.containment,null," ")),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: grid = \n"+JSON.stringify(this.grid,null," "));this.onGesture=function(t){if((a||(a=Wincor.UI.Content.ViewModelContainer))&&a.isSuspended)return;let i=t.type,e=!1;if(this.scaled&&(this.jElement.transition({scale:[1,1]},500,"ease"),this.scaled=!1,e=!0),L(i)){if(Math.abs(t.velocity)<this.swipeDefaultVelocity)return!1;let i,e,n=!1,s=!1;this.canMoveHorizontally&&y(t.direction)&&(n=!0,i=1,e=this.swipeVelocityFactor*i,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: swiped - this.x: x="+this.x+" factor: "+e),this.x=this.x+t.velocityX*t.deltaTime*e,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: swiped - estimated destination: x="+this.x)),this.canMoveVertically&&I(t.direction)&&(s=!0,i=-1,e=this.swipeVelocityFactor*i,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: swiped - this.y: y="+this.y+" factor: "+e),this.y=this.y+t.velocityY*t.deltaTime*e,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: swiped - estimated destination: y="+this.y));let o=n?this.x+this.xStart:this.jElement.offset().left,r=s?this.y+this.yStart:this.jElement.offset().top;l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: "+n+"/"+s),this.snapToGrid(void 0,this.getNearestGrid({left:o,top:r}),this.bounceFunction,void 0,400)}else u(i)?Math.abs(this.lastGesture.deltaX-t.deltaX)<50&&Math.abs(this.lastGesture.deltaY-t.deltaY)<50&&this.move(this.canMoveHorizontally?t.deltaX:this.x,this.canMoveVertically?t.deltaY:this.y,t):i===m?(this.objectManager.freeGridPosition(this),this.fadeOnDrag&&this.jElement.css({opacity:.5})):i===f&&(this.fadeOnDrag&&this.jElement.css({opacity:1}),L(this.lastGesture.type)||this.moveEnd(t));return i!==p||e||this.scaled||(this.jElement.transition({scale:[2,2]},500,"snap"),this.scaled=!0),!0},(e=>{l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> initializeHammerManager"),this.hammertime=new n.Manager(r,this.options),Object.keys(e).forEach((s=>{if(s in c){let a=e[s];this.recognizerOpts[s.toLowerCase()]=a;let h=a.events;Array.isArray(h)&&0!==h.length||(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,`. initializeHammerManager using default events '${c[s].defaultEvents}' for recognizer '${s}'`),h=c[s].defaultEvents.slice());let g=[];h.every((t=>{let i=c[s].events.includes(t);return i||g.push(t),i}))||l.error(`UIMovements - Invalid config: event(s) '${g}' of '${s}' unknown for '${this.element.id}' of '${o}'!`),"direction"in a&&(a.direction=n[a.direction],this.canMoveHorizontally=!!(a.direction&(n.DIRECTION_LEFT|n.DIRECTION_RIGHT)),this.canMoveVertically=!!(a.direction&(n.DIRECTION_UP|n.DIRECTION_DOWN)),!this.canMoveHorizontally&&this.grid&&(this.grid.left=void 0,this.grid.width=void 0),!this.canMoveVertically&&this.grid&&(this.grid.top=void 0,this.grid.height=void 0));let d=h.join(" ").toLowerCase();l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". initializeHammerManager options for gesture '"+s+"' on element id "+r.id+": "+JSON.stringify(a));let m=new n[s](a);a.css&&"object"==typeof a.css&&t(this.element).css(a.css),this.hammertime.add(m),this.hammertime.on(d,(t=>{this.objectManager.touched();const e=i.target?r:this.element;if(-1!==this.options.processChildEvents.indexOf(t.type)||t.target===e){if(a.handler)try{if(a.handler(t,this,this.objectManager)||a.disableDefaultHandler)return void(this.lastGesture=t)}catch(t){l.error("Error in handler function of '"+s+"' recognizer on element "+r.id+" -> "+t)}this.onGesture(t)&&(this.lastGesture=t)}else l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"event not for "+this.element.id+" - discarding")}))}else l.error(`UIMovements - Invalid config: unknown recognizer ${s} for '${this.element.id}' of '${o}'!\nUse one of ${JSON.stringify(c,null," ")}`)}));let s=this.hammertime.get("swipe"),a=this.hammertime.get("pan");s&&a&&s.recognizeWith(a),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< initializeHammerManager")})(v),this._moveCount=0,this.handlingCollisions=!1,this.move=function(t,i,e){if(this._moveCount++,!this.processMoving)return;this.handleScrollbars(t,i,e),this.processItemVisibility(this.x+t,this.y+i),this.options.notifyMovement&&this.grid&&(this.grid.width&&this._moveCount>this.grid.width/10||this.grid.height&&this._moveCount>this.grid.height/10)&&(this._moveCount=0,this.getNearestGrid({left:this.xStart+this.x+t,top:this.yStart+this.y+i})),this.handlingCollisions||this.objectManager.handleCollisions(e,this,this.getPosition(t,i)).then((()=>{this.handlingCollisions=!1}));let n=!0,s=!0,[o,r]=this.elementMovesContainer(t,i,e);n&=o,s&=r;let l=this.xStart+this.x+t,a=this.yStart+this.y+i;!this.hasGrid()&&this.hasContainment()&&((l<this.containment.left||l+this.elementWidth>this.containment.right)&&(n=!1),(a<this.containment.top||a+this.elementHeight>this.containment.bottom)&&(s=!1)),(n||s)&&(this.dxValid=n?t:this.dxValid,this.dyValid=s?i:this.dyValid,this.jElement.css({x:this.x+this.dxValid,y:this.y+this.dyValid}))},this.elementMovesContainer=function(t,i,e){let o=!0,r=!0,l=void 0!==this.parent?this.parent:this.objectManager.getParentContainer(this.containerId);if(!this.listElementName&&l){let a=this.objectManager.getElementsByContainer(l)[0];e.direction===n.DIRECTION_LEFT&&a.x<a.getHorizontalMaxPos()&&a.x+this.x+this.xStart+t<0?(o=!1,this.processMoving=!1,a.moveRight(h).then((()=>{this.x-=a.grid.width,this.jElement.transition({x:this.x+t,y:this.y+i},h,(()=>{s.Promises.Promise.resolve().delay(h).then((()=>{this.processMoving=!0}))}))}))):e.direction===n.DIRECTION_RIGHT&&a.x>a.getHorizontalMinPos()&&a.x+this.x+this.xStart+t>this.window.width-this.grid.width?(o=!1,this.processMoving=!1,a.moveLeft(h).then((()=>{this.x+=a.grid.width,this.jElement.transition({x:this.x+t,y:this.y+i},h,(()=>{s.Promises.Promise.resolve().delay(h).then((()=>{this.processMoving=!0}))}))}))):e.direction===n.DIRECTION_UP&&a.y<a.getVerticalMaxPos()&&a.y+this.y+this.yStart+i<0?(r=!1,this.processMoving=!1,a.moveDown(h).then((()=>{this.y+=a.grid.height,this.jElement.transition({x:this.x+t,y:this.y+i},h,(()=>{s.Promises.Promise.resolve().delay(h).then((()=>{this.processMoving=!0}))}))}))):e.direction===n.DIRECTION_DOWN&&a.y>a.getVerticalMinPos()&&a.y+this.y+this.yStart+i>this.window.height-this.grid.height&&(r=!1,this.processMoving=!1,a.moveUp(h).then((()=>{this.y+=a.grid.height,this.jElement.transition({x:this.x+t,y:this.y+i},h,(()=>{s.Promises.Promise.resolve().delay(h).then((()=>{this.processMoving=!0}))}))})))}return[o,r]},this.handleScrollbars=function(t,i,e){if(e&&e.fromScrollbar||!this.scrollbar||!e)return;const n=this.scrollbar.vertical,s=this.scrollbar.horizontal;if(n&&n.$element)if(e._doTransition){let t=-i*n.factor;t<n.yMin?t=n.yMin:t>n.yMax&&(t=n.yMax),n.$element.transition({y:t},(()=>{this.storeScrollbarPosition()}))}else{let t=n.y+Math.round(-i*n.factor);t>n.yMin&&t<n.yMax&&n.$element.css({y:t})}if(s&&s.$element)if(e._doTransition)s.$element.transition({x:-t*s.factor},(()=>{this.storeScrollbarPosition()}));else{let i=s.x+Math.round(-t*s.factor);i>s.xMin&&i<s.xMax&&s.$element.css({x:s.x+Math.round(-t*s.factor)})}},this.storeScrollbarPosition=function(){this.scrollbar&&(this.scrollbar.vertical&&this.scrollbar.vertical.$element&&(this.scrollbar.vertical.y=parseInt(this.scrollbar.vertical.$element.css("y"))),this.scrollbar.horizontal&&this.scrollbar.horizontal.$element&&(this.scrollbar.horizontal.x=parseInt(this.scrollbar.horizontal.$element.css("x"))))},this.getHorizontalMinPos=function(t=!1){if(this.grid){let i=this.gridPositions.left.length,e=this.gridPositions.left[0],n=this.gridPositions.left[i-1];return t?Math.max(e,n):Math.min(e,n)}},this.getHorizontalMaxPos=this.getHorizontalMinPos.bind(this,!0),this.getVerticalMinPos=function(t=!1){if(this.grid){let i=this.gridPositions.top.length,e=this.gridPositions.top[0],n=this.gridPositions.top[i-1];return t?Math.max(e,n):Math.min(e,n)}},this.getVerticalMaxPos=this.getVerticalMinPos.bind(this,!0),this.visibilityArrayX=[],this.visibilityArrayY=[],this.itemVisibilityTransition=void 0;let A=-1,M=0,_=0;this.processItemVisibility=function(i,e){if(!this.options||!this.options.processItemVisibility||!this.listElementName)return;if(-1===A&&(A=this.options.minMove||1),Math.abs(M-i)<A&&Math.abs(_-e)<A)return;let s;M=i,_=e;let o=["scale","opacity","visibility","rotateX","rotateY","move"],r="opacity",l=this.options.itemVisibilityTransitions||r;if(this.itemVisibilityTransition||("string"==typeof l?o.indexOf(l)>=0?this.itemVisibilityTransition=l:this.itemVisibilityTransition=r:"object"==typeof l&&l.in&&l.out&&(this.itemVisibilityTransition="custom")),0===this.visibilityArrayX.length){s=this.objectManager.getGrid(this.containerId).left.length;for(let t=0;t<s;t++)this.visibilityArrayX.push(!0)}if(0===this.visibilityArrayY.length){s=this.objectManager.getGrid(this.containerId).top.length;for(let t=0;t<s;t++)this.visibilityArrayY.push(!0)}let a=this.xStart+i-this.containment.left-this.grid.width+1,h=this.yStart+e-this.containment.top-this.grid.height+1,c=n[this.options.processItemVisibility],g=-1*parseInt(Math.round(parseInt(h/this.grid.height))),d=1*parseInt(Math.round(this.containment.height/this.grid.height))+g-1,m=-1*parseInt(Math.round(parseInt(a/this.grid.width))),f=1*parseInt(Math.round(this.containment.width/this.grid.width))+m-1,p=t("."+this.listElementName);0===p.length&&(p=t("#"+this.listElementName)),p.each(((s,o)=>{let r;r=c===n.DIRECTION_VERTICAL||c===n.DIRECTION_ALL?s>=g&&s<=d:c===n.DIRECTION_HORIZONTAL?s>=m&&s<=f:c===n.DIRECTION_UP?s>=g:c===n.DIRECTION_DOWN?s<=d:c===n.DIRECTION_LEFT?s>=m:c===n.DIRECTION_RIGHT?s<=f:s>=g&&s<=d;let a=c===n.DIRECTION_HORIZONTAL?-this.grid.width*s:-this.grid.height*s,h=c===n.DIRECTION_HORIZONTAL?1-Math.min(Math.max(100*(a-i)/this.grid.width*1.2/100,0),1):1-Math.min(Math.max(100*(a-e)/this.grid.height*1.2/100,0),1);switch(this.itemVisibilityTransition){case"scale":t(o).css({scale:[h,h]});break;case"opacity":t(o).css({opacity:h});break;case"visibility":t(o).css({visibility:r?"visible":"hidden"});break;case"rotateX":h=90*(1-h),t(o).css({transformOrigin:"50% 100%"}).css({perspective:"100px",rotateX:h+"deg"});break;case"rotateY":h=90*(1-h),t(o).css({transformOrigin:"50% 100%"}).css({perspective:"100px",rotateY:h+"deg"});break;case"move":h=1-h,t(o).css({x:-this.elementWidth*h,y:0});break;case"custom":t(o).transition(r?l.in:l.out,l.duration||250)}this.visibilityArrayY[s]=r}))},this.moveEnd=function(t){const i=this;function e(){i.objectManager.handleCollisions(t,i,i.getPosition()).then((t=>{t>0?i.snapToGrid().then((function(t){if(t)return i.pack();e()})):i.objectManager.enlargeGridWidth(i,[i]).then(i.pack.bind(i))}))}try{this.canMoveHorizontally&&(this.x+=this.dxValid,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: moveEnd storing x: "+this.x)),this.canMoveVertically&&(this.y+=this.dyValid,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: moveEnd storing y: "+this.y)),this.snapToGrid().then((t=>{if(i.storeScrollbarPosition(),t)return i.pack();e()}))}catch(t){l.error(t)}},this.pack=function(){return this.objectManager.pack(this.containerId)},this.getGridPositions=function(){l.LOG_DETAIL&&l.log(l.LOG_DETAIL,`> ObjectManager::getGridPositions for ${this.element.id} within ${this.containerId}`);let t={top:[],left:[]},i=this.containment.width,e=this.containment.height,n=this.jElement[0].scrollWidth,s=this.jElement[0].scrollHeight,o=0,r=0;if(this.canMoveHorizontally)if(this.elementWidthGreaterThanContainment){let t=this.jElement.offset().left+n,i=this.containment.right,e=1e3;for(o=1;this.grid.width>0&&t>i;){if(e--,e<1){l.error("Calculating validGridPositionsCountX stopped due to abnormal size...");break}t-=this.grid.width,o++}}else this.grid.width>0&&(o=Math.floor(i/this.grid.width));l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: VALID GRID POSITIONS x ="+o),0===o&&t.left.push(this.jElement.offset().left);for(let i=0;i<o;i++){let e;if(this.elementWidthGreaterThanContainment)e=this.jElement.offset().left-this.grid.width*i;else{if(this.options.lockIfSpace){this.options.initialMove=!1,this.options.initialSnap=!1,t.left.push(this.jElement.offset().left),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: lockIfSpace applies horizontally... locking @ x: "+this.jElement.offset().left);break}e=this.containment.left+this.grid.left+this.grid.width*i}t.left.push(e)}if(this.canMoveVertically)if(this.elementHeightGreaterThanContainment){let t=this.jElement.offset().top+s,i=this.containment.bottom,e=1e3;for(r=1;this.grid.height>0&&t>i;){if(e--,e<1){l.error("Calculating validGridPositionsCountY stopped due to abnormal size...");break}t-=this.grid.height,r++}}else this.grid.height>0&&(r=Math.floor(e/this.grid.height));l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: VALID GRID POSITIONS y ="+r),0===r&&t.top.push(this.jElement.offset().top);for(let i=0;i<r;i++){let e;if(this.elementHeightGreaterThanContainment)e=this.jElement.offset().top-this.grid.height*i;else{if(this.options.lockIfSpace){this.options.initialMove=!1,this.options.initialSnap=!1,t.top.push(this.jElement.offset().top),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"col: lockIfSpace applies vertically... locking @ y: "+this.jElement.offset().top);break}e=this.containment.top+this.grid.top+this.grid.height*i}t.top.push(e)}return this.options.lockIfSpace&&(1===t.left.length&&this.canMoveHorizontally&&!this.canMoveVertically||1===t.top.length&&!this.canMoveHorizontally&&this.canMoveVertically||1===t.top.length&&1===t.left.length?("pan"in this.recognizerOpts&&!("enable"in this.recognizerOpts.pan)&&(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ObjectManager::getGridPositions locking pan gesture due to 'lockIfSpace'"),this.hammertime.get("pan").set({enable:!1})),"swipe"in this.recognizerOpts&&!("enable"in this.recognizerOpts.swipe)&&(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ObjectManager::getGridPositions locking swipe gesture due to 'lockIfSpace'"),this.hammertime.get("swipe").set({enable:!1}))):(t.left.length>1&&this.canMoveHorizontally&&!this.canMoveVertically||t.top.length>1&&!this.canMoveHorizontally&&this.canMoveVertically)&&("pan"in this.recognizerOpts&&!("enable"in this.recognizerOpts.pan)&&(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ObjectManager::getGridPositions enabling pan gesture"),this.hammertime.get("pan").set({enable:!0})),"swipe"in this.recognizerOpts&&!("enable"in this.recognizerOpts.swipe)&&(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ObjectManager::getGridPositions enabling swipe gesture"),this.hammertime.get("swipe").set({enable:!0})))),this.gridPositions=t,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< ObjectManager::getGridPositions for "+this.containerId+" : "+JSON.stringify(t)),t},this.getNearestGrid=function(t){let i=this.gridPositions;if(i&&i.left&&i.top){let e,n,s={};for(let o=0;o<i.left.length;o++){e=isNaN(i.left[o])?0:i.left[o];for(let o=0;o<i.top.length;o++){let r;n=isNaN(i.top[o])?0:i.top[o],r=parseInt(3*Math.abs(t.top-n)+Math.abs(t.left-e)),s.hasOwnProperty(""+r)?(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"getNearestGrid DOUBLE entry for diff "+r+"old/new"+JSON.stringify({top:n,left:e})+JSON.stringify(s[r])),e<s[r].left&&this.objectManager.isGridPositionFree({top:n,left:e},this)&&(s[r]={top:n,left:e})):this.objectManager.isGridPositionFree({top:n,left:e},this)&&(s[r]={top:n,left:e})}}let o=[];Object.keys(s).forEach((t=>{o.push(parseInt(t))})),o.sort(((t,i)=>t-i));for(let t=0;t<o.length;t++)if(this.objectManager.isGridPositionFree(s[o[t]],this))return s=s[o[t]],l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"getNearestGrid returns "+JSON.stringify(s)),this.notify({id:"gridposition",width:i.left.length,height:i.top.length,x:i.left.indexOf(s.left)+1,y:i.top.indexOf(s.top)+1}),s}},this.moveRight=function(t,i,e){let n=this.getLogicalPosition(),s=this.gridPositions.left,o=1;return s&&(o=s[0]>s[s.length-1]?-1:1),this.moveToLogicalPosition(n.x+o,n.y,t,i,e)},this.moveLeft=function(t,i,e){let n=this.getLogicalPosition(),s=this.gridPositions.left,o=1;return s&&(o=s[0]>s[s.length-1]?-1:1),this.moveToLogicalPosition(n.x-o,n.y,t,i,e)},this.moveDown=function(t,i,e){let n=this.getLogicalPosition(),s=this.gridPositions.top,o=1;return s&&(o=s[0]>s[s.length-1]?-1:1),this.moveToLogicalPosition(n.x,n.y+o,t,i,e)},this.moveUp=function(t,i,e){let n=this.getLogicalPosition(),s=this.gridPositions.top,o=1;return s&&(o=s[0]>s[s.length-1]?-1:1),this.moveToLogicalPosition(n.x,n.y-o,t,i,e)},this.canMoveLeft=function(){let t=this.getLogicalPosition();if(!t)return!1;let i=(this.elementWidthGreaterThanContainment?{width:1}:this.getLogicalDimensions()).width||1,e=this.gridPositions.left,n=1;return e&&(n=e[0]>e[e.length-1]?-1:1),1===n?t.x>=i:t.x<this.gridPositions.left.length-i},this.canMoveRight=function(){let t=this.getLogicalPosition();if(!t)return!1;let i=(this.elementWidthGreaterThanContainment?{width:1}:this.getLogicalDimensions()).width||1,e=this.gridPositions.left,n=1;return e&&(n=e[0]>e[e.length-1]?-1:1),1===n?t.x<this.gridPositions.left.length-i:t.x>=i},this.canMoveDown=function(){let t=this.getLogicalPosition();if(!t)return!1;let i=(this.elementHeightGreaterThanContainment?{height:1}:this.getLogicalDimensions()).height||1,e=this.gridPositions.top,n=1;return e&&(n=e[0]>e[e.length-1]?-1:1),1===n?t.y<this.gridPositions.top.length-i:t.y>=i},this.canMoveUp=function(){let t=this.getLogicalPosition();if(!t)return!1;let i=(this.elementHeightGreaterThanContainment?{height:1}:this.getLogicalDimensions()).height||1,e=this.gridPositions.top,n=1;return e&&(n=e[0]>e[e.length-1]?-1:1),1===n?t.y>=i:t.y<this.gridPositions.top.length-i},this.canMove=function(){return this.canMoveDown()||this.canMoveUp()||this.canMoveLeft()||this.canMoveRight()},this.moveToLogicalPosition=async function(t,i,e,n,o){if(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,`. GestureElement::moveToLogicalPosition ${this.element?this.element.id:"unknown"} to x/y ${t}/${i}`),!this.hasGrid())throw"No grid configured";let r=this.getLogicalPosition();r||(await this.snapToGrid(),r=this.getLogicalPosition());let{x:a,y:h}=r;if(a===t&&h===i)return void(l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ignored, pos is the same"));let{width:c,height:g}=this.getLogicalDimensions();if(this.elementWidthGreaterThanContainment&&(c=1,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ignore logicalDimension width due to viewport-mode")),this.elementHeightGreaterThanContainment&&(g=1,l.LOG_DETAIL&&l.log(l.LOG_DETAIL,". ignore logicalDimension height due to viewport-mode")),g=g||1,c=c||1,t&&(t<0||t>this.gridPositions.left.length-c)||i&&(i<0||i>this.gridPositions.top.length-g))throw"Logical position not available";this.objectManager.freeGridPosition(this);let d=n||"ease";this.moving=!0;let m=this.gridPositions.left[t]-this.xStart-this.x,f=this.gridPositions.top[i]-this.yStart-this.y;this.x+=m,this.y+=f,this.objectManager.occupyGridPosition(this);let p=this.objectManager.grids[this.containerId];this.processItemVisibility(this.x,this.y),this.notify({id:"gridposition",width:p.left.length,height:p.top.length,x:t+1,y:i+1}),this.lastPosition=this.getPosition();let u=s.Promises.promise(((t,i)=>{if(void 0===e||e>=0){let i=-1,n=this.recognizerOpts.pan&&this.recognizerOpts.pan.handler||this.recognizerOpts.swipe&&this.recognizerOpts.swipe.handler;n&&this.options.sendAutoMovementEvents&&(i=setInterval((()=>{n(null,this,this.objectManager)}),20)),this.jElement.transition({x:this.x,y:this.y},e||300,d,(()=>{this.moving=!1,-1!==i&&clearInterval(i),o&&t()}))}else{this.jElement.css({x:this.x,y:this.y});let i=this.recognizerOpts.pan&&this.recognizerOpts.pan.handler||this.recognizerOpts.swipe&&this.recognizerOpts.swipe.handler;i&&this.options.sendAutoMovementEvents&&i(null,this,this.objectManager),o&&t()}}));return o?u:void 0},this.hasGrid=function(){return!!this.grid&&(this.grid.hasOwnProperty("top")||this.grid.hasOwnProperty("left"))},this.hasContainment=function(){return!!this.containment&&this.containment.hasOwnProperty("top")&&this.containment.hasOwnProperty("left")},this.snapToGrid=function(t,i,e,n,o){return s.Promises.promise(((s,r)=>{if(!this.hasGrid())return void r();this.moving=!0;let a=t||this.containment,h=e||"ease",c=i||this.jElement.offset();l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: offset top/left: "+c.top+"/"+c.left);let g;this.elementHeight,a.height;l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: before snap x="+this.x+" y="+this.y);try{g=this.getNearestGrid({top:this.y+this.yStart,left:this.x+this.xStart})}catch(t){return void s(!1)}if(g&&(this.x=g.left-this.xStart,this.y=g.top-this.yStart),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"pos: after snap x="+this.x+" y="+this.y),!g)return void s(!1);this.objectManager.occupyGridPosition(this),n&&this.objectManager.freeGridPosition(this,this.lastPosition),this.lastPosition=this.getPosition(),s(!0),this.processItemVisibility(this.x,this.y),this.handleScrollbars(this.x,this.y,{_doTransition:!0});let d=-1,m=this.recognizerOpts.pan&&this.recognizerOpts.pan.handler||this.recognizerOpts.swipe&&this.recognizerOpts.swipe.handler;m&&this.options.sendAutoMovementEvents&&(d=setInterval((()=>{m(null,this,this.objectManager)}),20)),this.jElement.transition({x:this.x,y:this.y},o||300,h,(()=>{-1!==d&&clearInterval(d),this.moving=!1}))}))},this.getPosition=function(t,i){return{left:this.x+this.xStart+(t||0),top:this.y+this.yStart+(i||0),right:this.x+this.xStart+this.elementWidth+(t||0),bottom:this.y+this.yStart+this.elementHeight+(i||0),width:this.elementWidth,height:this.elementHeight}},this.freeGridPosition=function(){l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> GestureElement::freeGridPosition("+this.element.id+")"),this.objectManager.freeGridPosition(this),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< GestureElement::freeGridPosition")},this.occupyGridPosition=function(){l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"> GestureElement::occupyGridPosition("+this.element.id+")"),this.objectManager.occupyGridPosition(this),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,"< GestureElement::occupyGridPosition")},this.toggleElementSize=function(i,e,n){return s.Promises.promise(((o,r)=>{n=n||t(this.element);let l,a=this.getLogicalDimensions(),h=this.getLogicalPosition(),c=s.Promises.Promise.resolve();1===a.height?(0===h.y?this.objectManager.isColumnFree(h.x,h.y+1,this.containerId,[this])?this._logicalYGridsOccupied=2:(c=this.objectManager.enlargeGridWidth(this,[this],!1),c.then((()=>{this.freeGridPosition(),this._logicalYGridsOccupied=2,this.occupyGridPosition()})).fail(alert.bind(this,"enlargeFailed"))):(c=this.objectManager.enlargeGridWidth(this,[this],!1),c.then((()=>{this.moveUp(),this._logicalYGridsOccupied=2}))),n.hasClass(i)||(l=s.Promises.promise(((t,e)=>{n.addClass(i,250,void 0,t)}))),e&&n.hasClass(e)&&n.removeClass(e)):(this.freeGridPosition(),this._logicalYGridsOccupied=1,this.occupyGridPosition(),n.hasClass(i)&&(l=s.Promises.promise(((t,e)=>{n.removeClass(i,250,void 0,t)}))),e&&!n.hasClass(e)&&n.addClass(e)),s.Promises.Promise.all([c,l]).then((()=>{this.calculateDimensions(),this.objectManager.organizeAll(this.containerId).then(this.objectManager.pack(this.containerId)).then(o)}))}))},this.getLogicalDimensions=function(){if(void 0!==this._logicalXGridsOccupied&&void 0!==this._logicalYGridsOccupied)return{width:this._logicalXGridsOccupied,height:this._logicalYGridsOccupied};let t={width:Math.round(this.elementWidth/this.grid.width),height:Math.round(this.elementHeight/this.grid.height)};return this._logicalXGridsOccupied=t.width,this._logicalYGridsOccupied=t.height,t},this.getLogicalPosition=function(t){return this.objectManager.getLogicalPosition(this,t)},this.dispose=function(){setTimeout((()=>{e&&e.ViewModelContainer?e.ViewModelContainer.whenActivationStarted().then((()=>{this.jElement.css({x:0,y:0}),this.jElement=null})):(this.jElement.css({x:0,y:0}),this.jElement=null)}),1);let i=[];if(this.hammertime.recognizers.forEach((t=>{i=i.concat(t.options.events)})),l.LOG_DETAIL&&l.log(l.LOG_DETAIL,`--- disposing events ${i.join(" ")} of element ${this.element.id}`),this.hammertime.stop(!0),this.hammertime.off(i.join(" ")),Object.keys(this.gestures).forEach((t=>{this.hammertime.remove(t)})),this.grid&&this.objectManager.freeGridPosition(this),this.element=null,this.boundToElement=null,this.hammertime.destroy(),this.hammertime=null,this.scrollbar){let i=this.scrollbar.vertical;i&&(i.mc&&(i.mc.off(g),i.mc.destroy(),i.mc=null),t(i.$element).remove(),i.$element=null,this.scrollbar.vertical=null);let e=this.scrollbar.horizontal;e&&(e.mc&&(e.mc.off(g),e.mc.destroy(),e.mc=null),t(e.$element).remove(),e.$element=null,this.scrollbar.horizontal=null)}this.objectManager=null,this.gestures=null,this.grid=null,this.gridPositions=null,this.lastGesture=null,this.target=null,this.parent=null,this.notificationHandler=null,this.collisionHandler=null,this.recognizerOpts=null}};return d}));