/**
 @preserve
 Copyright (c) 2001-2020 by Wincor Nixdorf International GmbH,
 Heinz-Nixdorf-Ring 1, 33106 Paderborn, Germany

 This software is the confidential and proprietary information
 of Diebold Nixdorf.
 You shall not disclose such Confidential Information and shall
 use it only in accordance with the terms of the license agreement
 you entered into with Diebold Nixdorf.


$MOD$ VirtualKeyboardViewModel.js 4.3.1-210127-21-34ae33df-1a04bc7d

*/
define(["jquery","knockout","code-behind/VirtualKeyboardKeyCodes","extensions","config/Config","lib/hammer.min","basevm","jquery-ui"],(function(e,t,i,s,o,n){"use strict";const a=Wincor.UI.Service.Provider.LogProvider,r=Wincor.UI.Service.Provider.LocalizeService,l="#generalVKInput",h="virtualKeyboardEppSuspendingId",d="EPP_EVENT",u=(new Wincor.UI.AsyncJobQueue).setName("VKAnimationQueue").setConcurrency(!0).setStopOnError(!1);let p;const g="SHOW",c="HIDE",y="BACKSPACE",O="CLEAR",T="ENTER",I="SHIFT",b="FUNCTION",v="SPACE",_="UP",f="DOWN",V="LEFT",m="RIGHT",L="CAPSLOCK",K={8:y,13:T,39:m,37:V,38:_,40:f};Wincor.UI.Content.VirtualKeyboardViewModel=class extends Wincor.UI.Content.BaseViewModel{defaultOptions=o.VIRTUAL_KEYBOARD_CONFIG;language="en-us";initialized=!1;shift=!1;SHIFT_KEY_ID="";capslock=!1;CAPSLOCK_KEY_ID="";OPACITY_DURING_POPUP=1;numerical=!1;hidden=!0;lastFocusedElement=null;lastFocusedInputId="";disabledInputIds=[];keys={};subKeys={};mask=null;jqVKElement=null;jqVKModalOverlay=null;inputTarget=null;viewService=null;hammertime=[];keyData=function(){this.enabled=t.observable(!1),this.visible=t.observable(!1),this.keyCode=0,this.character=t.observable(""),this.selection=null};constructor(){super(),this._mirrorChanged=!1,this.validInputFields=[],this.popupElement=null,this.jMirroredTarget=void 0,this.isPressed=!1,this.inputTarget=void 0,this.jqVKModalOverlay=void 0,this.jqVKElement=void 0,this.inputDirection="ltr",this.numberOfFields=0,this.firstShow=!0,this.hidden=!0,this.keys={},this.subKeys={},this.ignoreFocusIn=!1,this.activeLayout=t.observable(""),this.EPP_COMMANDS={VK_ENTER:{eppKeys:["CONFIRM"],args:["CONFIRM"]},VK_BACKSPACE:{eppKeys:["CLEAR","BACKSPACE"],args:["CLEAR","BACKSPACE"]},VK_1:{eppKeys:["1"],args:"1"},VK_2:{eppKeys:["2"],args:"2"},VK_3:{eppKeys:["3"],args:"3"},VK_4:{eppKeys:["4"],args:"4"},VK_5:{eppKeys:["5"],args:"5"},VK_6:{eppKeys:["6"],args:"6"},VK_7:{eppKeys:["7"],args:"7"},VK_8:{eppKeys:["8"],args:"8"},VK_9:{eppKeys:["9"],args:"9"},VK_0:{eppKeys:["0"],args:"0"}},Object.keys(this.EPP_COMMANDS).forEach((e=>{let t=this.EPP_COMMANDS[e];this.createCommand(e,t.args,t.eppKeys)})),this.cmdRepos.setVisible(this.EPP_COMMANDS,!1),this.options={}}observe(t={}){this.options=e.extend(!0,{},this.defaultOptions,t),this.LAYOUTS=i.KEYMAPPINGS,a.LOG_ANALYSE&&a.log(a.LOG_ANALYSE,"> VirtualKeyboardViewModel::observe(observableArea="+this.options.keyboardElementId+")"),this.enterCallback=this.options.enterCallback,this.disabledInputIds=this.options.disabledInputIds,this.SHIFT_KEY_ID=this.options.shiftKeyId,this.CAPSLOCK_KEY_ID=this.options.capsLockKeyId,this.activeLayout("KEYBOARD"),super.observe(this.options.keyboardElementId),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::observe")}onInitTextAndData(e){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::onInitTextAndData()");let t=new Promise(((e,t)=>{require([`text!content_${o.viewType}/views/components/virtualkeyboard.component.html`],(i=>{i?(this.KEYBOARD_TYPE=i,e()):t(`Could not retrieve text!content_${o.viewType}/views/components/virtualkeyboard.component.html`)}))}));if(e.textKeys.push(t),!this.designMode){r.registerForServiceEvent(r.SERVICE_EVENTS.LANGUAGE_CHANGED,this.onLanguageChanged.bind(this),this.serviceProvider.ViewService.DISPOSAL_TRIGGER_UNLOAD);const t=this.serviceProvider.ViewService;t.registerForServiceEvent(t.SERVICE_EVENTS.CONTENT_UPDATE,this.onContentUpdated.bind(this));const i=this.serviceProvider.ConfigService,s=i.configuration.instanceName+"\\Services\\General",o="BeepingVK",n="Beeping";e.dataKeys.push(i.getConfiguration(s,[o,n]).then((e=>{!0===e[o]&&(this.options.beep=!0),!0===e[n]&&(this.options.beepEpp=!0)})))}return this.vmContainer.whenActivated().then(this.onInteractive.bind(this)),0===Object.keys(this.keys).length&&e.dataKeys.push(this.initKeys()),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::onInitTextAndData"),super.onInitTextAndData(e)}dispatchKeyDownToInputTarget(e){const t=e.keyCode;e.preventDefault(),e.stopPropagation(),t in K?this.onButtonPressed(K[t]):1===e.key.length&&(this.insertInInputTarget(e.key),this.setLeftRightKeys(),this.checkValidity())}installVKInputKeypressHandler(){const t=this;e(l).off("keypress.vk").off("keydown.vk").on("keypress.vk",(e=>{this.dispatchKeyDownToInputTarget(e)})).on("keydown.vk",(e=>{t.options.forbiddenCharCodes&&t.options.forbiddenCharCodes.includes(e.keyCode)?(e.preventDefault(),e.stopPropagation()):this.dispatchKeyDownToInputTarget(e)}))}findInitialInputTarget(){if(a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::findInitialInputTarget()"),this.inputTarget&&e(this.inputTarget).length>0)return void(a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::findInitialInputTarget skip finding a new target,"));let t;const i=[":input[type=","], "];let s="";Object.keys(this.options.skipTypes).forEach((e=>{this.options.skipTypes[e]&&(s+=i[0]+e+i[1])})),s=s.slice(0,-2);const o=e(this.options.inputContainer);if(o.is("iframe")?this.validInputFields=o.contents().find(this.options.validNodeNames.join(",")).not(s):this.validInputFields=o.find(this.options.validNodeNames.join(",")).not(s),this.numberOfFields=this.validInputFields.length,this.validInputFields.length>0){let i=9999999,s=0;for(t=0;t<this.validInputFields.length;t+=1){this.validInputFields[t].tabIndex<i&&(i=this.validInputFields[t].tabIndex,s=t);const o=e(this.validInputFields[t]);o.off("remove.vk"),o.on("remove.vk",this.onValidInputFieldsRemoved.bind(this))}this.inputTarget=this.validInputFields[s]}else a.LOG_INFO&&a.log(a.LOG_INFO,". VirtualKeyboardViewModel::findInitialInputTarget - no input-field found on page "+this.currentView),e("#virtualKeyboardFrameArea").css({top:0,left:0});this.validInputFields.length<2?(this.keys.UP.enabled(!1),this.keys.DOWN.enabled(!1)):(this.keys.UP.enabled(!0),this.keys.DOWN.enabled(!0)),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::findInitialInputTarget found target: "+(this.inputTarget?this.inputTarget.id:"undefined"))}initKeys(){return a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::initKeys()"),this.designMode||(this.language=r.currentLanguage.toLowerCase()),s.Promises.Promise.resolve().then((()=>{if(!this.LAYOUTS[this.options.defaultLanguage.toLowerCase()])return i.loadLayout(this.options.defaultLanguage.toLowerCase())})).then((()=>{if(!this.LAYOUTS[this.language.toLowerCase()])return i.loadLayout(this.language.toLowerCase())})).then((()=>{let e,t;for(t in this.LAYOUTS[this.language][this.options.keyboardType].KEY_CODES)this.LAYOUTS[this.language][this.options.keyboardType].KEY_CODES.hasOwnProperty(t)&&(e=new this.keyData,this.keys[t]=e,e=new this.keyData,this.subKeys[t]=e);this.initialized=!0,this.activateLayout(this.options.keyboardType),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::initKeys")})).catch((function(e){throw a.error(e),e}))}updateLayout(e,t){if(a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::updateLayout(...)"),this.initialized)for(let i in e)if(e.hasOwnProperty(i)){if(("number"==typeof e[i]&&e[i]>=0||"number"!=typeof e[i])&&(!this.mask||this.mask.ACTIVE_KEYS.indexOf(i)>-1)){let s="string"==typeof e[i],o=e[i]instanceof Array,n="object"==typeof e[i];if(o||s||n)if(s||o)this.keys[i].enabled(!0),this.keys[i].visible(!0),this.keys[i].keyCode=0,this.keys[i].character(this.convertToString(e[i])),this.keys[i].selection=null,t&&-1===t[i]||this.mask&&-1===this.mask.ACTIVE_SUB_KEYS.indexOf(i)?(this.subKeys[i].keyCode=0,this.subKeys[i].character(""),this.subKeys[i].selection=null):t&&(this.subKeys[i].keyCode=t[i],this.subKeys[i].character(this.convertToString(t[i])),this.subKeys[i].selection=null);else{let s=!1;Object.keys(e[i]).forEach(function(o){s||(this.keys[i].enabled(!0),this.keys[i].visible(!0),this.keys[i].keyCode=0,this.keys[i].character(this.convertToString(o)),this.keys[i].selection=e[i][o],t&&-1===t[i]||this.mask&&-1===this.mask.ACTIVE_SUB_KEYS.indexOf(i)?(this.subKeys[i].keyCode=0,this.subKeys[i].character(""),this.subKeys[i].selection=null):t&&(this.subKeys[i].keyCode=t[i],this.subKeys[i].character(this.convertToString(t[i])),this.subKeys[i].selection=null)),s=!0}.bind(this))}else"number"==typeof e[i]&&(this.keys[i].enabled(!0),this.keys[i].visible(!0),this.keys[i].keyCode=e[i],this.keys[i].character(this.convertToString(this.keys[i].keyCode)),this.keys[i].selection=null,t&&-1===t[i]||this.mask&&-1===this.mask.ACTIVE_SUB_KEYS.indexOf(i)?this.subKeys[i].character(""):t&&(this.subKeys[i].keyCode=t[i],this.subKeys[i].character(this.convertToString(t[i])),this.subKeys[i].selection=null))}else-2==e[i]?(this.keys[i].enabled(!1),this.keys[i].visible(!1),this.keys[i].character(""),this.subKeys[i].character("")):(this.keys[i].enabled(!1),this.keys[i].character(""),this.subKeys[i].character(""))}this.setLeftRightKeys(),this.checkValidity(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::updateLayout")}convertToString(e){let t,i="";if(e instanceof Array){for(t=0;t<e.length;t+=1)"string"==typeof e[t]?i+=e[t]:i+=String.fromCharCode(e[t]);return i}return"string"==typeof e?e:isNaN(e)?"":String.fromCharCode(e)}onInteractive(){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::onInteractive()"),this._mirror=-1===this.options.moveContainer.distance;let t=e("body");this.jqVKModalOverlay=e("#vkModalOverlay"),0===this.jqVKModalOverlay.length&&(t.append(this.KEYBOARD_TYPE),this.jqVKModalOverlay=e("#vkModalOverlay"),this._mirror||this.deActivateMirror()),this.options.useAppOverlay||this.jqVKModalOverlay.css("visibility","hidden"),this.jqVKElement=e(`#${this.options.keyboardElementId}`),this.jMirroredTarget=e(l),this.inputDirection=this.jMirroredTarget.css("direction"),this.inputTarget||this.findInitialInputTarget(),this.vmContainer.doBind(this.jqVKElement[0]).then((()=>{this.registerTaps(),this.installVKInputKeypressHandler()})),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::onInteractive")}deActivateMirror(){this._mirrorChanged=!0,this._mirror=!1,e("#generalVKInputLabel").css({display:"none"});const t=e(l),i=e("#"+this.options.keyboardElementId);"none"!==t.css("display")&&(t.css({display:"none"}),i.height(i.height()-t.height()))}activateMirror(){this._mirrorChanged=!0,this._mirror=!0,e("#generalVKInputLabel").css({display:""});const t=e(l),i=e("#"+this.options.keyboardElementId);"none"===t.css("display")&&(t.css({display:""}),i.height(i.height()+t.height()))}registerTaps(){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::registerTaps()");const t=this,i=e(this.options.inputContainer);this.hammertime.length>0&&(this.hammertime.forEach((e=>{e.off("tap press")})),this.hammertime=[]),i.contents().find(this.options.validNodeNames.join(",")).length>0&&(i.is("iframe")?i.each((function(){t.hammertime.push(new n(e(this).contents().find("body")[0]))})):this.hammertime.push(new n(document.body)),this.hammertime.forEach((e=>{e.on("tap press",this.onFocusIn.bind(t))}))),a.LOG_INOUT&&a.log(a.LOG_INOUT,`< VirtualKeyboardViewModel::registerTaps registered for ${this.hammertime.length} targets`)}onContentUpdated(){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::onContentUpdated()"),this.findInitialInputTarget(),this.registerTaps(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::onContentUpdated")}onFocusIn(t){if(u.isRunning())a.LOG_INFO&&a.log(a.LOG_INFO,". VirtualKeyboardViewModel::onFocusIn VK animation already running");else{a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::onFocusIn("+t.target.nodeName+")");const i=this;if(i.designMode||i.serviceProvider.ViewService.refreshTimeout(),!i.options.skipTypes[t.target.type]&&!t.target.disabled&&e.inArray(t.target.nodeName,i.options.validNodeNames)>-1&&-1===e.inArray(t.target.id,i.disabledInputIds)){if("function"==typeof i.options.onFocusInHandler){if(i.options.onFocusInHandler(t))return}if(i.inputTarget&&e(i.inputTarget).removeClass("activeInput"),i._mirror=-1===i.options.moveContainer.distance,i._mirror?i.activateMirror():i.deActivateMirror(),i.inputTarget=t.target,i._mirror||(i.jMirroredTarget=e(t.target)),i.inputTarget&&e(i.inputTarget).addClass("activeInput"),i.options.autoDirection){const t=e(i.inputTarget).css("direction");t&&(i.jMirroredTarget.css({direction:t}),i.inputDirection=t)}if(i.copyCurrentValue(),i.setLeftRightKeys(),i.checkValidity(),i.options.autoLayout){let s=e(t.target).attr("data-input-type");s||(s=t.target.type);let o=!0;if(s in i.options.inputType2Layout){const e=i.options.inputType2Layout[s];"string"==typeof e?(i.activateLayout(e),o=!1):Array.isArray(e)&&2===e.length&&(i.activateLayout(e[0]),i.activateKeyMapping(e[1]),o=!1)}o&&i.activateLayout("KEYBOARD")}else i.reset();i.ignoreFocusIn||(i.options.beep&&i.serviceProvider.BeepService.beep(),a.LOG_INFO&&a.log(a.LOG_INFO,"onFocusIn: calling show"),u.add(i._showInternal.bind(i,i.calcTopPositionFromInputTarget()),g)),i.ignoreFocusIn=!1,i.lastFocusedInputId=t.target.id,i.lastFocusedElement=t.target}else a.LOG_DETAIL&&a.log(a.LOG_DETAIL,". pass..."),i.options.skipTypes[t.target.type]&&!i.hidden&&u.add(i.hide.bind(i),c);a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::onFocusIn")}}update(){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::update()");try{let t=this.SHIFT_KEY_ID?e("#"+this.SHIFT_KEY_ID):"",i=this.CAPSLOCK_KEY_ID?e("#"+this.CAPSLOCK_KEY_ID):"";t.length&&(this.shift?t.addClass("pressed"):t.removeClass("pressed")),i.length&&(this.capslock?i.addClass("pressed"):i.removeClass("pressed")),this.numerical?(this.capslock?!this.shift:this.shift)?this.updateLayout(this.LAYOUTS[this.language][this.options.keyboardType].SHIFT_NUMERICAL_KEY_CODES,this.LAYOUTS[this.language][this.options.keyboardType].SHIFT_NUMERICAL_SUB_KEY_CODES):this.updateLayout(this.LAYOUTS[this.language][this.options.keyboardType].NUMERICAL_KEY_CODES,this.LAYOUTS[this.language][this.options.keyboardType].NUMERICAL_SUB_KEY_CODES):(this.capslock?!this.shift:this.shift)?this.updateLayout(this.LAYOUTS[this.language][this.options.keyboardType].SHIFT_KEY_CODES,this.LAYOUTS[this.language][this.options.keyboardType].SHIFT_SUB_KEY_CODES):this.updateLayout(this.LAYOUTS[this.language][this.options.keyboardType].KEY_CODES,this.LAYOUTS[this.language][this.options.keyboardType].SUB_KEY_CODES)}catch(e){let t=`keyboardType: "${this.options.keyboardType}" is unknown for keymapping file "vk_${this.language.toLowerCase()}.json"...`;this.LAYOUTS[this.language][this.options.keyboardType]&&(t=`The keyboardType "${this.options.keyboardType}" for keymapping file "vk_${this.language.toLowerCase()}.json" has no such attribute...`),a.error(`Exception: ${e}!\n ${t}`)}a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::update")}activateLayout(e="KEYBOARD"){a.LOG_INOUT&&a.log(a.LOG_INOUT,`> VirtualKeyboardViewModel::activateLayout(${e})`),this.options.keyboardType=e,this.activeLayout(e),this.reset(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::activateLayout")}activateKeyMapping(e="KEYBOARD"){a.LOG_INOUT&&a.log(a.LOG_INOUT,`> VirtualKeyboardViewModel::activateKeyMapping(${e})`),this.options.keyboardType=e,this.reset(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::activateKeyMapping")}resetPopup(){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::resetPopup()"),this.removePopupHint(),this.popupElement&&(this.popupElement=null),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::resetPopup")}isValidInputField(t){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::isValidInputField()");let i=e(t).attr("type"),s=e(t).attr("disabled"),o=!this.options.skipTypes[i]&&!s;return a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::isValidInputField returns "+o),o}clearInputTarget(){let e=this.getSourceObservable(),t=this.getTargetObservable(),i=this.jMirroredTarget[0];e&&t?(e(""),i.value=t(),this.keys.LEFT.enabled(!1),this.keys.RIGHT.enabled(!1)):(i.value="",this.lastFocusedElement.value=""),this.setInputValid(this.getDataValidObservable()),this.shift=!1}insertInInputTarget(e){let t,i,s,o=this.getSourceObservable(),n=this.getTargetObservable(),a=this._mirror?this.jMirroredTarget[0]:this.inputTarget;if(t=a.selectionStart,i=a.value.substr(0,a.selectionStart),s=a.value.substr(a.selectionEnd,a.length),o&&n){let r=o();r&&r===n()&&this._mirror?(this.keys.LEFT.enabled(!0),this.keys.RIGHT.enabled(!0),o(i+e),o()===n()?(o(o()+s),a.value=n(),a.selectionStart=t+e.length,a.selectionEnd=t+e.length):(a.value=n(),this.setLeftRightKeys())):(o(r+e),a.value=n(),this.setLeftRightKeys())}else null!==t?(a.value=i+e+s,a.selectionStart=t+e.length,a.selectionEnd=t+e.length):a.value=a.value+e,this.inputTarget.value=a.value;this.setInputValid(this.getDataValidObservable()),this.shift=!1}setInputValid(e){null!==e&&this.jMirroredTarget.attr("data-validation-state",t.unwrap(e))}getSourceObservable(){return"function"==typeof this.options.getSourceObservable&&this.inputTarget?this.options.getSourceObservable(this.inputTarget):null}getTargetObservable(){return"function"==typeof this.options.getTargetObservable&&this.inputTarget?this.options.getTargetObservable(this.inputTarget):null}getDataValidObservable(){return"function"==typeof this.options.getDataValidObservable&&this.inputTarget?this.options.getDataValidObservable(this.inputTarget):null}keyPressCallback(e,t,i){let s;if(a.LOG_INOUT&&a.log(a.LOG_INOUT,`> VirtualKeyboardViewModel::keyPressCallback(${e}, ${t} ${i})`),"function"==typeof this.options.keyPressCallback)try{s=this.options.keyPressCallback(e,t,i)}catch(e){a.error("Error calling this.options.keyPressCallback "+JSON.stringify(e))}return a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::keyPressCallback returns "+s),s}calcCenterPosition(){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::calcCenterPosition()");const t=(e(window).width()-this.jqVKElement.width())/2;return a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::calcCenterPosition returns "+t),t}calcTopPositionFromInputTarget(){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::calcTopPositionFromInputTarget()");const t=e(window).height()-e("#virtualKeyboardContainer").height();return a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::calcTopPositionFromInputTarget returns "+t),t}show(e=null){return this.inputTarget=e||this.inputTarget,this.inputTarget&&!this.isValidInputField(this.inputTarget)&&this.activateMirror(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::show()"),this.jqVKElement?(this.update(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::show - isRunning="+u.isRunning()),u.isRunning()?u.mainPromise:u.add(this._showInternal.bind(this,this.calcTopPositionFromInputTarget()),g)):s.Promises.Promise.reject("VirtualKeyboard not ready yet...")}hide(){return this.jqVKElement?u.add(this._hideInternal.bind(this),c):s.Promises.Promise.resolve()}isVisible(){return!this.hidden}setLabel(i){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::setLabel("+i+")"),i?e("#generalVKInputLabel").text(t.unwrap(i)):a.log(a.LOG_ERROR,"VirtualKeyboardViewModel::setLabel called with: "+i),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::setLabel")}setPlaceholder(i){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::setPlaceholder("+i+")"),i?e(l).attr("placeholder",t.unwrap(i)):a.log(a.LOG_ERROR,"VirtualKeyboardViewModel::setPlaceholder called with: "+i),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::setPlaceholder")}moveContainer(){if(this.options.moveContainer.distance>=0){this.inputTarget&&!this.isValidInputField(this.inputTarget)&&this.activateMirror();const t=e("#"+this.options.keyboardElementId);let i,s;const n=e(this.options.moveContainer.targetSelector),r=parseInt(n.css("y"));this.hidden&&(i=t.css("visibility"),s=t.css("rotateX"),t.css({visibility:"hidden",rotateX:0}));const l=e(this.inputTarget||document.activeElement),h=parseInt(t.css("height"));let d=0;e(this.options.inputContainer).is("iframe")&&(d=-r);const u=l.offset().top-d+l.height()-r,p=window.innerHeight-h;if(p<u){a.LOG_DETAIL&&a.log(a.LOG_DETAIL,". VirtualKeyboardViewModel::moveContainer intersectY "+(u-p));let e=-(u-p+this.options.moveContainer.distance);o.VIEW_ANIMATIONS_ON?n.transition({y:e},this.options.moveTime):n.css({y:e})}else o.VIEW_ANIMATIONS_ON?n.transition({y:0},this.options.moveTime):n.css({y:0});this.hidden&&t.css({visibility:i,rotateX:s})}}_showInternal(t,i){if(u.isRunning())return a.LOG_INFO&&a.log(a.LOG_INFO,". VirtualKeyboardViewModel::_showInternal VK animation already running"),s.Promises.Promise.resolve();{a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::_showInternal("+t+")");const n=this;return s.Promises.promise((function(s){if(!n.hidden&&!n._mirrorChanged)return n._mirrorChanged=!1,a.LOG_DETAIL&&a.log(a.LOG_DETAIL,". VirtualKeyboardViewModel::_showInternal VK is not hidden... skip show"),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::_showInternal"),n.moveContainer(),void s();function r(){if(n._mirror){let t=e(window).width(),i=parseInt(n.jMirroredTarget.css("border-left"))+parseInt(n.jMirroredTarget.css("border-right"))+parseInt(n.jMirroredTarget.css("padding-left"))+parseInt(n.jMirroredTarget.css("padding-right"))+parseInt(n.jMirroredTarget.css("margin-left"))+parseInt(n.jMirroredTarget.css("margin-right"));i=t-i,n.jMirroredTarget.css({"max-width":i+"px","min-width":i+"px"}),n.jMirroredTarget.off("focus")}n.firstShow&&(n.firstShow=!1),o.VIEW_ANIMATIONS_ON||(n.jqVKElement.css({top:t+"px",left:i+"px"}),n.jqVKElement.css(n.options.originIn).css(n.options.transitionIn),n.jqVKModalOverlay.css({opacity:1})),n.jqVKElement.css({visibility:"visible"}),n.hidden=!1,a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::_showInternal"),n.options.stateChangedHandler&&n.options.stateChangedHandler({visibility:"visible"}),-1===n.options.moveContainer.distance&&n.jMirroredTarget.focus(),n.cmdRepos.setActive(Object.keys(n.EPP_COMMANDS)),s()}p=n.cmdRepos.cmdIds.filter((e=>null!==n.cmdRepos.get(e).eppKeys&&!Object.keys(n.EPP_COMMANDS).includes(e)));let l=p.indexOf("CANCEL");l>-1&&p.splice(l,1);let d=p.indexOf("CONFIRM");d>-1&&p.splice(d,1),p&&p.length&&n.cmdRepos.suspend(p,h),t=t?""+t:"0",n.jqVKModalOverlay.css({display:"block",opacity:0}),n.copyCurrentValue(!0),e("#flexHeader, #flexMain").attr("data-virtualkeyboard-active",!0),n.options.styleAppContentClass&&e("#flexHeader, #flexMain").addClass(n.options.styleAppContentClass),o.VIEW_ANIMATIONS_ON?n.options.useStandardShowHide?(n.jqVKElement.css({visibility:"visible"}),n.firstShow&&n.jqVKElement.animate({top:[""+(e(window).height()+10),"swing"]},{duration:0,queue:!1}),n.jqVKModalOverlay.css({opacity:1}),n.moveContainer(),n.jqVKElement.animate({opacity:["1","swing"],top:[t,"swing"],left:i},{duration:n.options.moveTime,queue:!1,complete:()=>r()})):(n.moveContainer(),n.firstShow&&n.jqVKElement.css({visibility:"visible"}),n.jqVKElement.animate({top:[t,"swing"],left:i},{duration:1,queue:!1,complete:()=>{n.jqVKModalOverlay.transition({opacity:1},n.options.transitionTime),n.jqVKElement.css(n.options.originOut).transition(n.options.transitionOut,0,(()=>{n.hidden&&n.jqVKElement.css(n.options.originIn).transition(n.options.transitionIn,n.options.transitionTime,r)}))}})):(n.moveContainer(),r())}))}}_hideInternal(t){if(u.isRunning())return a.LOG_INFO&&a.log(a.LOG_INFO,". VirtualKeyboardViewModel::_hideInternal VK animation already running"),s.Promises.Promise.resolve();{a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::_hideInternal()"),this.options.moveContainer.distance>=0&&(o.VIEW_ANIMATIONS_ON&&!t?e(this.options.moveContainer.targetSelector).transition({y:0}):e(this.options.moveContainer.targetSelector).css({y:0}));const i=this;return s.Promises.promise((function(s){function n(){i.jqVKModalOverlay.hide(),i.hidden=!0,e("#flexHeader, #flexMain").attr("data-virtualkeyboard-active",!1),o.VIEW_ANIMATIONS_ON&&!t||i.jqVKElement.css(i.options.originOut).css(i.options.transitionOut),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::_hideInternal"),i.options.stateChangedHandler&&i.options.stateChangedHandler({visibility:"hidden"}),s()}p&&p.length&&(i.cmdRepos.resume(p,h),p=null),i.cmdRepos.setVisible(Object.keys(i.EPP_COMMANDS),!1),i.options.styleAppContentClass&&e("#flexHeader, #flexMain").removeClass(i.options.styleAppContentClass),o.VIEW_ANIMATIONS_ON&&!t?i.options.useStandardShowHide?i.jqVKElement.animate({top:[""+(e(window).height()+10),"swing"]},{duration:i.options.moveTime,queue:!1,complete:()=>{n()}}):(i.jqVKModalOverlay.transition({opacity:0},i.options.transitionTime),i.jqVKElement.css(i.options.originOut).transition(i.options.transitionOut,i.options.transitionTime,(()=>{n()}))):n()}))}}checkValidity(){if(!this.options.validateInput)return!0;let e=!0;return this.inputTarget&&this.inputTarget.checkValidity&&(e=this.inputTarget.checkValidity()),this.keys[T].enabled(e),e}setLeftRightKeys(){let e,t=this.getSourceObservable(),i=this.getTargetObservable();this.setInputValid(this.getDataValidObservable());let s=this.inputTarget&&null!==this.inputTarget.selectionStart;if(!t||!i)return this.keys.LEFT.enabled(s),void this.keys.RIGHT.enabled(s);let o=t();e=i();let n=(!o||o===e)&&this._mirror;this.keys.LEFT.enabled(n),this.keys.RIGHT.enabled(n),!n&&s&&(this.jMirroredTarget[0].selectionStart=this.jMirroredTarget[0].selectionStart=i().length)}copyCurrentValue(t=!1){let i,s=this.getSourceObservable(),o=this.getTargetObservable();if(this.setInputValid(this.getDataValidObservable()),s&&o?(i=o(),this.setLeftRightKeys()):(i=e(this.inputTarget).val(),i="None"===i?"":i),this._mirror){if(this.jMirroredTarget.val(i),this.inputTarget&&this.inputTarget.id){const t=e(this.options.inputContainer);if(t.is("iframe")){let i=t.contents().find('label[for="'+this.inputTarget.id+'"]').html();i&&e("label[for=generalVKInput]").html(i),e(l).attr("placeholder",e(this.inputTarget).attr("placeholder"))}else{let t=e('label[for="'+this.inputTarget.id+'"]').html();t&&e("label[for=generalVKInput]").html(t),e(l).attr("placeholder",e(this.inputTarget).attr("placeholder"))}}t&&setTimeout((()=>{null!=i&&null!==this.jMirroredTarget[0].selectionStart&&(this.jMirroredTarget[0].selectionStart=this.jMirroredTarget[0].selectionEnd=i.length)}),0)}}pasteCurrentValue(){let t=this.getSourceObservable(),i=this.getTargetObservable();if(this.setInputValid(this.getDataValidObservable()),(!t||!i)&&this._mirror){let t=e(this.inputTarget),i=this.jMirroredTarget.val(),s=t.val();t.val(i);let o=t.val();this.jMirroredTarget.val()!==o&&(this.jMirroredTarget.effect("highlight",{},1e3),t.effect("highlight",{},1e3),this.jMirroredTarget.val(s),t.val(s));let n=this.cmdRepos.getCommandByElementId(t.attr("id"));n&&this.cmdRepos.setCmdLabel(n.id,o)}}reset(){this.numerical=!1,this.shift=!1,this.capslock=!1,this.mask=null,this.update();const t=e("#"+this.options.keyboardElementId);t.attr("data-vk-layout",this.activeLayout()),t.attr("data-vk-keymapping",this.options.keyboardType)}intersectX(t,i){let s,o,n,a,r=!1,l=e(t),h=e(i);return 0!==l.length&&0!==h.length&&(s=l.offset().left,n=s+l.width(),o=h.offset().left,a=o+h.width(),(s>o&&s<a||s>o&&n<a||s<o&&n>o)&&(r=!0),r)}intersectY(t,i){let s,o,n,a,r=!1,l=e(t),h=e(i);return 0!==l.length&&0!==h.length&&(s=l.offset().top,n=s+l.height(),o=h.offset().top,a=o+h.height(),(s<o&&n>o||s>o&&n<a||s<a&&n>a)&&(r=!0),r)}intersect(e,t){return this.intersectX(e,t)&&this.intersectY(e,t)}onValidInputFieldsRemoved(){let t;for(a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::onValidInputFieldsRemoved()"),t=0;t<this.validInputFields.length;t+=1){e(this.validInputFields[t]).off("remove.vk")}this.hammertime.forEach((e=>{e.off("tap press")})),this.inputTarget=null,this.validInputFields=[],a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::onValidInputFieldsRemoved")}onLanguageChanged(e){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::onLanguageChanged("+e+")"),e=e.toLowerCase(),this.LAYOUTS.hasOwnProperty(e)?(this.language=e,this.update()):(a.LOG_DETAIL&&a.log(a.LOG_DETAIL,". VirtualKeyboardViewModel::onLanguageChanged: No keyboard layout defined for language "+e+" - trying to load it..."),i.loadLayout(e).then((t=>{a.LOG_DETAIL&&a.log(a.LOG_DETAIL,"* VirtualKeyboardViewModel::onLanguageChanged: successfully loaded keyboard layout for language "+e),this.language=e,this.LAYOUTS=t.KEYMAPPINGS,this.update()})).catch((t=>{a.error("Error loading virtual keyboard data for language "+e+". "+JSON.stringify(t)),this.language=this.options.defaultLanguage.toLowerCase(),this.update()}))),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::onLanguageChanged")}goToNextInputField(t=!1){const i=this;let s;if(this.validInputFields.filter(":enabled").length>1){this.reset(),s=this.validInputFields.index(this.inputTarget);const o=this.validInputFields.length;let n=0;do{n++,t?(s-=1,s<0&&(s=this.validInputFields.length-1)):(s+=1,s>=this.validInputFields.length&&(s=0))}while(!this.isValidInputField(this.validInputFields[s])&&n<o);this.options.moveContainer.distance<0?this.intersect("#"+this.options.keyboardElementId,this.inputTarget)?this._hideInternal().then((()=>{this.ignoreFocusIn=!0,this.onFocusIn({target:this.validInputFields[s]}),e(i.inputTarget).effect(i.options.inputFieldFocusEffect,500,(()=>{this.update(),this._showInternal(i.calcTopPositionFromInputTarget())}))})):(this.onFocusIn({target:this.validInputFields[s]}),e(this.inputTarget).effect(this.options.inputFieldFocusEffect,500)):this.onFocusIn({target:this.validInputFields[s]})}}hasNextInputField(e=!1){let t,i=!1;return this.validInputFields.filter(":enabled").length>1&&(this.reset(),t=this.validInputFields.index(this.inputTarget),e?(t-=1,i=t>=0):(t+=1,i=!(t>=this.validInputFields.length))),i}handleBackspace(e){a.LOG_INOUT&&a.log(a.LOG_INOUT,`> VirtualKeyboardViewModel::handleBackspace(${e})`);let t=!0,i=this._mirror?this.jMirroredTarget[0]:this.inputTarget;if(!i)return void a.error(` VirtualKeyboardViewModel::handleBackspace(${e}) error, unknown target element`);let s=i.value.substr(0,i.selectionStart),o=i.value.substr(i.selectionEnd,i.value.length);null!==i.selectionStart&&null!==i.selectionEnd||(t=!1,s=i.value,o="");const n=this.getSourceObservable(),r=this.getTargetObservable();if(i.selectionStart===i.selectionEnd){if(a.LOG_DETAIL&&a.log(a.LOG_DETAIL,". nothing selected..."),this.setInputValid(this.getDataValidObservable()),""!==s)if(s=s.substring(0,s.length-1),n&&r){const a=n();a&&a===r()?(n(s+o),i.value=r(),t&&(i.selectionStart=e-1,i.selectionEnd=e-1)):(n(a.slice(0,a.length-1)),i.value=r())}else i.value=s+o,t&&(i.selectionStart=e-1,i.selectionEnd=e-1),this.inputTarget.value=i.value}else if(a.LOG_DETAIL&&a.log(a.LOG_DETAIL,". deleting selection..."),i.value=s+o,i.selectionStart=e,i.selectionEnd=e,n&&r){const e=n();e&&e===r()?n(s+o):n(e.slice(0,e.length-1)),i.value=r()}else this.inputTarget.value=i.value;this.setLeftRightKeys(),this.checkValidity(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::handleBackspace")}onEppButtonPressed(e,t){a.LOG_INOUT&&a.log(a.LOG_INOUT,`> VirtualKeyboardViewModel::onEppButtonPressed(${e}, ${t})`),e in this.options.eppKeyMap&&(e=this.options.eppKeyMap[e],a.LOG_INOUT&&a.log(a.LOG_INOUT,`. mapped to <${e}>`));let i="";[!1,!0].forEach((t=>{let s,o,n=Object.keys(this.keys);if(!i)for(o=0;o<n.length;o++)if(s=n[o],t){if(this.keys[s].character()===e){i=s;break}}else if(s===e){i=s;break}if(!i)for(n=Object.keys(this.subKeys),o=0;o<n.length;o++)if(s=n[o],t){if(this.subKeys[s].character()===e){i=s;break}}else if(s===e){i=s;break}})),i&&this.onButtonPressed(i,this,{type:d,key:e}),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::onEppButtonPressed")}onButtonPressed(t,i,s){this.copyCurrentValue(),this.designMode||(this.serviceProvider.ViewService.refreshTimeout(),this.options.beep&&s&&("tap"===s.type||"press"===s.type||"BACKSPACE"===t&&"panstart"===s.type)&&this.serviceProvider.BeepService.beep());if(Object.keys(K).map((e=>K[e])).includes(t)){const e=parseInt(Object.keys(K).filter((e=>K[e]===t))[0]);if(this.options.forbiddenCharCodes&&this.options.forbiddenCharCodes.includes(e))return}a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::onButtonPressed("+t+", "+i+", "+s+")");const o=this.keyPressCallback(t,this,s);if(o)return void(a.LOG_INOUT&&a.log(a.LOG_INOUT,`< VirtualKeyboardViewModel::onButtonPressed keyPressCallback returned ${o} value, skipping standard action`));s&&"press"===s.type&&(this.isPressed=!0);let n=!1,r=!0;try{let i;try{i=this.jMirroredTarget[0].selectionStart}catch(e){i=0}if(t===y)this.handleBackspace(i);else if(t===O)this.clearInputTarget();else if(t===T){n=!0;let e=!0;if(this.options.enterCallback)try{let t;t=this._mirror?this.jMirroredTarget.val():this.inputTarget.value,e=!this.options.enterCallback(t)}catch(e){a.error("VirtualKeyboardViewModel::onButtonPressed enterCallback exception: "+e)}e&&window.setTimeout((()=>{!0===this.options.nextFieldOnEnter&&this.hasNextInputField()?this.goToNextInputField():u.add(this._hideInternal.bind(this),c)}),0)}else if(t===I)n=!0,""===this.SHIFT_KEY_ID&&(this.SHIFT_KEY_ID=s.originalEvent?s.originalEvent.currentTarget.id:s.target.id),this.shift=!this.shift;else if(t===L)n=!0,""===this.CAPSLOCK_KEY_ID&&(this.CAPSLOCK_KEY_ID=s.originalEvent?s.originalEvent.currentTarget.id:s.target.id),this.capslock=!this.capslock;else if(t===b)n=!0,this.numerical=!this.numerical;else if(t===f)n=!0,this.goToNextInputField();else if(t===_)n=!0,this.goToNextInputField(!0);else if(t===V)r=!1,i>0&&(this.jMirroredTarget[0].selectionStart=i-1,this.jMirroredTarget[0].selectionEnd=i-1);else if(t===m)r=!1,null!==i&&i<this.jMirroredTarget[0].value.length&&(this.jMirroredTarget[0].selectionStart=i+1,this.jMirroredTarget[0].selectionEnd=i+1);else if(t===v)this.shift&&(n=!0),this.insertInInputTarget(" ");else{let i,o=this.keys[t];if(s&&s.type===d&&(o={character:()=>s.key}),r=!1,s&&("tap"===s.type||s.type===d)||!o.selection&&s&&"press"===s.type)r=!0,this.resetPopup(),this.shift&&(n=!0),this.insertInInputTarget(o.character());else if(s&&"press"===s.type){let e,t,i='<div id="popupKeysArea">';for(e=0;e<o.selection.length;e+=1)t="vkPopupSmallSquareButton"+e,i+='<button id="'+t+'" class="button keyboardButton '+(0===e?"highlighted":"")+'" ><var class="color03">'+this.convertToString(o.selection[e])+"</var></button>";i+="</div>",this.jqVKElement.transition({opacity:this.OPACITY_DURING_POPUP}),this.showPopupHint(i,this.POPUP_DEFAULT_TYPE,s.originalEvent?s.originalEvent.currentTarget.id:s.target.id,function(e){e.attr("data-virtualkeyboard-hint",!0),this.popupElement=e[0]}.bind(this))}else if(s&&"pressup"===s.type)this.isPressed=!1,this.resetPopup(),o.selection&&(this.insertInInputTarget(this.convertToString(o.selection[0])),r=!0);else if(s&&"panmove"===s.type&&this.popupElement){let t=this.popupElement.offsetTop+this.popupElement.offsetHeight/2;i=document.elementFromPoint(s.srcEvent.pageX,t);try{const t=e(this.popupElement).find(i);t.length>0&&t.hasClass("keyboardButton")&&(e("#popupKeysArea").find('[id^="vkPopupSmallSquareButton"]').removeClass("highlighted"),t.addClass("highlighted"))}finally{}}else if(s&&"panend"===s.type&&this.popupElement)try{const t=e(this.popupElement).find(".highlighted").find(".color03").text();t&&(this.insertInInputTarget(this.convertToString(t)),r=!0)}finally{this.resetPopup()}}n&&this.update(),r&&this.pasteCurrentValue(),this.checkValidity(),this.setLeftRightKeys(),this._mirror?this.jMirroredTarget.focus():this.inputTarget&&this.inputTarget.focus(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::onButtonPressed")}catch(e){a.error("VirtualKeyboardViewModel::onButtonPressed:"+e)}}onDeactivated(){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::onDeactivated()"),this.hidden||this.hidden||this.hide(!0),this.numerical=!1,this.validInputFields=[],this.inputTarget=null,super.onDeactivated(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::onDeactivated")}clean(){a.LOG_INOUT&&a.log(a.LOG_INOUT,"> VirtualKeyboardViewModel::clean()"),e(l).off("keypress.vk").off("keydown.vk"),this.firstShow=!0,this.numberOfFields=0,this.hammertime.length>0&&(this.hammertime.forEach((e=>{e.off("tap press")})),this.hammertime=[]),this.numerical=!1,this.validInputFields=[],this.hidden?this.jqVKModalOverlay.remove():u.add(this._hideInternal.bind(this,!0),c).then((()=>{this.jqVKModalOverlay.remove(),this.inputTarget=null,this.jqVKElement=null,this.jMirroredTarget=null,this.jMirroredTarget=null,this.jqVKModalOverlay=null})),super.clean(),a.LOG_INOUT&&a.log(a.LOG_INOUT,"< VirtualKeyboardViewModel::clean")}createCommand(e,t,i){let s=this.cmdRepos.createCommand(e);s.suspended=!1,s.eppKeys=i,s.viewModel=this,s.initialViewState=this.CMDSTATE.HIDDEN,s.delegates._init(this.onEppButtonPressed,this,t),this.cmdRepos.ensure(e),this.cmdRepos.setVisible(e,!1)}}}));