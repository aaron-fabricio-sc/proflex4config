/**
 @preserve
 Copyright (c) 2001-2020 by Wincor Nixdorf International GmbH,
 Heinz-Nixdorf-Ring 1, 33106 Paderborn, Germany

 This software is the confidential and proprietary information
 of Diebold Nixdorf.
 You shall not disclose such Confidential Information and shall
 use it only in accordance with the terms of the license agreement
 you entered into with Diebold Nixdorf.



$MOD$ StyleResourceResolver.js 4.3.1-210204-21-7f39c59f-1a04bc7d
 */
define(["jquery","knockout","extensions","ui-content","config/Config","code-behind/ViewHelper","lib/jquery.throttle-debounce"],(function(e,t,r,o,n,s){"use strict";const i=Wincor.UI.Service.Provider.LogProvider,l=Wincor.UI.Service.Provider.ViewService,a=Wincor.UI.Service.Provider.ConfigService,c=n.RES_1280X1024,u=n.RES_1024X1280,d=n.RES_1050X1680,f=n.ROOT_DEFAULT,y=n.RVT_DEFAULT_NAME,E=n.viewType,S="softkey"===E?n.CUSTOM_STYLE_RESOURCES_SOFTKEY:n.CUSTOM_STYLE_RESOURCES_TOUCH,p=n.CUSTOM_STYLE_RESOLUTIONS,h=n.IMAGE_FOLDER_NAME,R="_resolution_",g="_vendor_",L="_type_",_={"default/":"default/","mercurydark/":"MercuryDark/","mercurylight/":"MercuryLight/",dnseries:"DNSeries/","adahidescreen/":"ADAHideScreen/","adahighcontrast/":"ADAHighContrast/"},v="GUIDM"===a.configuration.instanceName;let A=[y,n.STYLE_VENDOR,x(n.STYLE_TYPE)],T=!1,O=[],N=!1,m=[],I=[],Y=0;const G={root:n.ROOT_DEFAULT,resolution:y,vendor:n.STYLE_VENDOR,type:x(n.STYLE_TYPE),lastType:"",resourceRepos:[],isExplicitMapping:!1,rvt:""};function P(t){return r.Promises.promise(((r,o)=>{e.ajax({type:"GET",dataType:"text",url:t,global:!1,success:()=>r(t),error:()=>o(t)})}))}function b(e){i.error(`Can't load style resource ${e?e.target.href:""}`)}function w(t,r=!1){i.LOG_DETAIL&&i.log(i.LOG_DETAIL,`StyleResourceResolver::setCustomLink resourceConfig=${JSON.stringify(t)}`);let o=e("head"),n=o.find("link[type='text/css']"),s=!1;if(!r)for(let e=n.length-1;e>=0&&!s;e--){let r=n[e].href;if(r&&r.substr(r.lastIndexOf("/")+1)===t.fileName){s=!0;let o=t.url;-1===r.indexOf(o.substr(o.indexOf(t.root)))&&(n[e].href=o)}}if(!s){let e=function(e){i.LOG_DETAIL&&i.log(i.LOG_DETAIL,`StyleResourceResolver::createLink for ${e.url}`);let t=document.createElement("link");return t.rel="stylesheet",t.type="text/css",t.href=e.url,t.setAttribute("data-style-resource",e.fileName),e.isAdditional&&t.setAttribute("data-additional-style","true"),e.isExplicitMapping&&t.addEventListener&&t.addEventListener("error",b,!1),t}(t);if(n.last().length){let r=t.list;if(r&&r.length){let s=t.url.substr(t.root.length),i=r.indexOf(s);if(-1!==i&&i<r.length-1){let t=D(r[i+1]),s=!1;for(let r=0;r<n.length;r++){let i=n[r];if(-1!==i.href.indexOf(t)){o.find(i).before(e),s=!0;break}}s||n.last().after(e)}else n.last().after(e)}else n.last().after(e)}else o.find("script").first().before(e);t.isExplicitMapping&&e.removeEventListener&&setTimeout((()=>{e.removeEventListener("error",b,!1)}),150)}}function C(){i.LOG_DETAIL&&i.log(i.LOG_DETAIL,". StyleResourceResolver::refreshSessionStorage"),sessionStorage.setItem("currentRVT",A.toString())}function x(e){return e&&(e=-1!==e.lastIndexOf("/")?e:`${e}/`,_[e.toLowerCase()]&&(e=_[e.toLowerCase()])),e}function M(e,t){return`${e.root}${e.resolution}${e.vendor}${e.type}${t}`}function D(e){return e?e.substr(e.lastIndexOf("/")+1):e}function $(e){return e&&e.endsWith("/")?e.substr(0,e.lastIndexOf("/")):e}function U(){return n.STYLE_RESOURCE_MAPPING&&n.STYLE_RESOURCE_MAPPING[E]&&n.STYLE_RESOURCE_MAPPING[E].resolution}function k(){if(N){let t=e("head");for(let e=0;e<O.length;e++)t.find("script").first().before(O[e]);t.find("link[type='text/css']").removeAttr("data-style-removal")}}function W(t=!1,r=""){let o=e("head").find("link[type='text/css']");if(t){m.length=0;for(let t=0;t<o.length;t++){let r=e(o[t]);"true"===r.attr("data-additional-style")&&m.push(r.attr("href"))}o.remove()}else for(let t=0;t<o.length;t++){let n=e(o[t]);"true"===n.attr(r)&&n.remove()}}function V(t,r=!0,o=!1){sessionStorage.setItem(t.fileName,t.url);let n=e(`link[data-style-resource='${t.fileName}']`),s=e(n),l=s.attr("href");if(r=!t.addResource&&r,o=!!t.addResource||o,void 0===l&&r?(i.LOG_DETAIL&&i.log(i.LOG_DETAIL,`. StyleResourceResolver::refreshResourceLink link not exist=${t.url} -try to add link.`),w(t)):r&&l!==t.url?(s.attr({href:t.url}),i.LOG_DETAIL&&i.log(i.LOG_DETAIL,`. StyleResourceResolver::refreshResourceLink link=${t.url} updated.`)):!1===r&&(o||s.remove(),w(t,!0)),t.order){let r=e("head"),o=r.find("link[type='text/css']"),n=!1;for(let s=0;s<o.length&&!n;s++){let i=o[s].href;if(i&&i.substr(i.lastIndexOf("/")+1)===t.fileName){let i;n=!0,e(o[s]).remove(),i=t.order<=o.length?e(r.find("link[type='text/css']")[s>t.order?t.order-1:t.order-2]):r.find("link[type='text/css']").last(),e(o[s]).insertAfter(i)}}}}function H(e,t){if(e&&Array.isArray(t))for(let r=0;r<t.length;r++){let o;if("string"==typeof t[r])o=t[r];else if("object"==typeof t[r]){o=t[r].url;try{e.order=parseInt(t[r].order),e.order=e.order>0?e.order:1}catch(t){i.error(`Config::STYLE_RESOURCE_MAPPING contains misconfigured order attribute ${t}`),e.order=null}finally{isNaN(e.order)&&(i.error(`Config::STYLE_RESOURCE_MAPPING contains misconfigured order attribute: ${e.order}`),e.order=null),void 0===o&&(i.error("Config::STYLE_RESOURCE_MAPPING contains misconfigured url attribute is undefined"),o="")}}e.addResource=o&&o.includes(":add"),o=e.addResource?o.substring(0,o.lastIndexOf(":")):o,"string"==typeof t[r]?t[r]=o:t[r].url=o,e.fileName=D(o),e.url=`${G.root}${o}`,e.list=t,V(e,!0,!1),e.order=null}else"object"==typeof t&&(t[e.type]||t[$(e.type)])?(H(e,t[e.type]||t[$(e.type)]),e.typeIsReady=!0):t&&i.error(`Config::STYLE_RESOURCE_MAPPING contains misconfigured vendor configuration regarding the type: Current type=${e.type} \n            not found for vendor=${e.vendor} and resolution=${e.resolution}.\n            In the case the vendor is 'default/' please add the missing 'default/' attribute to the vendor configuration with 'default/': [].\n            In any other case please add the name for the vendor and type, which is mentioned in this message.`)}let F={resolution:t.observable(y),vendor:t.observable(n.STYLE_VENDOR),type:t.observable(x(n.STYLE_TYPE)),imageRootPath:null,EVENTS:{RESIZE_WINDOW:"RESIZE_WINDOW"},shutdown:()=>{G.resourceRepos=null,e(window).resize(null),I=null},addStyleSheet:(e,t="")=>{w({root:G.root,resolution:G.resolution,vendor:G.vendor,type:G.type,fileName:e,url:`${t}${e}`,isAdditional:!0})},removeStyleSheet:t=>{!function(t){let r=e("head").find("link[type='text/css']");for(let o=0;o<r.length;o++){let n=e(r[o]);n.attr("href").includes(t)&&n.remove()}}(t)},getStyleResourceConfig:function(){return G},addEventListener:function(e){return"function"==typeof e&&I?(Y++,I.push({id:Y,func:e}),Y):-1},removeEventListener:function(e){if("number"==typeof e&&I){let t=I.findIndex((t=>t.id===e));-1!==t&&I.splice(t,1)}},fireEvent:function(e,t){e in this.EVENTS&&I&&I.forEach((r=>{try{r.func(e,t)}catch(e){}}))},process:async function(){if(i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,"> StyleResourceResolver::process()"),sessionStorage.clear(),G.root=n.ROOT_DEFAULT,G.vendor=n.STYLE_VENDOR,G.type=x(n.STYLE_TYPE),A=[y,n.STYLE_VENDOR,G.type],!o.designMode){let e=G.type;l.currentStyleType=e.endsWith("/")?e.substring(0,e.lastIndexOf("/")):e}try{await this.collectStyleResources()}catch(e){i.error(`StyleResourceResolver collectStyleResources failed: ${e}`)}C();try{await this.refreshResolution()}catch(e){i.error(`StyleResourceResolver refreshResolution failed: ${e}`)}this.imageRootPath=t.computed((()=>f+this.resolution()+h)),i.LOG_INOUT&&i.log(i.LOG_INOUT,"< StyleResourceResolver::process"),o.designMode||(o.designModeExtended&&"true"===localStorage.getItem("keepStyleTypeOn")&&(localStorage.getItem("currentStyleType")||localStorage.setItem("currentStyleType",x(n.STYLE_TYPE))),l.registerForServiceEvent(l.SERVICE_EVENTS.STYLE_TYPE_CHANGED,(e=>{i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,`. StyleResourceResolver::process event ${l.SERVICE_EVENTS.STYLE_TYPE_CHANGED} received with type=${e}`),null!=e?(""===e&&(e=x(n.STYLE_TYPE),i.LOG_DATA&&i.log(i.LOG_DATA,`. StyleResourceResolver::event style type was empty, setting back to initial from config which is ${x(n.STYLE_TYPE)}`)),(e="/"===e.substring(e.length-1)?e:e+"/")!==G.type?this.setType(e):i.LOG_DATA&&i.log(i.LOG_DATA,". StyleResourceResolver::event style type has been ignored due to same type as current.")):i.LOG_DATA&&i.log(i.LOG_DATA,". StyleResourceResolver::event style type has been ignored due to invalid.")}),l.DISPOSAL_TRIGGER_SHUTDOWN))},refreshResolution:async function(){i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,". StyleResourceResolver::refreshResolution");const t=e(window);let r,n=window.innerWidth,l=window.innerHeight;async function a(e,t){let r=!1;if(p.length>0){let o,n,s,i=0;try{for(;i<p.length;i++)if(s=p[i].toLowerCase().split("x"),o=parseInt(s[0]),n=parseInt(s[1]),e===o&&t===n){await F.setResolution(p[i]),r=!0;break}}catch(e){throw`Wrong resolution folder name ${p[i]} can't be parsed to number for width & height (expected something like: '1050x1680'): ${e}`}}if(!r)switch(!0){case e>=1920:await F.setResolution(c);break;case e>=1366:await F.setResolution(y);break;case e>=1280&&t>900&&t<1200:await F.setResolution(c);break;case 1050===e&&t>1200:await F.setResolution(d);break;case 1024===e&&t>=1280&&t<=1300:await F.setResolution(u);break;default:await F.setResolution(y)}}v&&(i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,". StyleResourceResolver::refreshResolution we are GUIDM instance."),n=screen.width,l=screen.height),await a(n,l),G.resolution===y&&await this.updateResources(),v||t.resize(e.debounce(50,(()=>{e("html").fadeOut("fast",(async()=>{n=window.innerWidth,l=window.innerHeight,o.applicationMode&&console.clear();try{await a(n,l),F.fireEvent(F.EVENTS.RESIZE_WINDOW,{winX:n,winY:l})}catch(e){i.error(e)}o.designMode&&(console.log(`${n}x${l}`),T&&s.isPopupHintActive()?r&&r.length&&(r.css({opacity:1,top:10,left:10}),r.html(`${n}x${l}`)):(T=!0,r=s.showPopupHint(`${n}x${l}`,s.POPUP_INFO_TYPE,"applicationHost",null),r.css({opacity:1,top:10,left:10}),setTimeout((()=>{T=!1,s.removePopup()}),5e3))),e("html").fadeIn("fast")}))})))},collectStyleResources:async function(){i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,". StyleResourceResolver::collectStyleResources()");let t=G.resourceRepos,r=e("link[data-style-resource]");if(r.length)r.each(((o,n)=>{let s=e(n).attr("data-style-resource");if(s&&(t[o]=s,o===r.length-1)){for(let e=S.length-1;e>=0;e--)-1===t.indexOf(S[e])&&t.push(S[e]);i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,`. StyleResourceResolver::collectStyleResources styleResourceConfig=${JSON.stringify(G)}`)}}));else{if(!U())throw"No style resources configured neither in index.html or explicit in config.STYLE_RESOURCE_MAPPING!";{let e=[];if(n.STYLE_RESOURCE_MAPPING[E].resolution[G.resolution])e=n.STYLE_RESOURCE_MAPPING[E].resolution[G.resolution].base;else{if(!Array.isArray(n.STYLE_RESOURCE_MAPPING[E].resolution)||!n.STYLE_RESOURCE_MAPPING[E].resolution[$(G.resolution)])throw"No style resources configured neither in index.html or no 'base' attribute found in config.STYLE_RESOURCE_MAPPING!";e=n.STYLE_RESOURCE_MAPPING[E].resolution[$(G.resolution)].base}t.length=0;for(let r=0;r<e.length;r++)t[r]=D(e[r])}}},setResolution:async function(t){if(i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,`. StyleResourceResolver::setResolution resolution=${t}`),t=-1!==t.lastIndexOf("/")?t:t+"/",G.resolution!==t){this.resolution(t),G.resolution=t,G.rvt=R,A[0]=t,t=$(t),o.designMode||(l.currentResolution=t);try{await this.updateResources(),e("body",parent.document).attr("data-style-resolution",t),e("body").attr("data-style-resolution",t)}catch(e){i.error(e)}}},setVendor:async function(e){i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,`. StyleResourceResolver::setVendor vendor=${e}`),e=-1!==e.lastIndexOf("/")?e:e+"/",G.vendor!==e&&(this.vendor(e),G.vendor=e,G.rvt=g,A[1]=e,o.designMode||(l.currentVendor=$(e)),await this.updateResources())},setType:async function(t){if(i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,`. StyleResourceResolver::setType type=${t}`),t){if(t=x(t),G.type!==t){this.type(t),G.lastType=G.type,G.type=t,G.rvt=L,A[2]=t,(o.designMode||o.designModeExtended&&"true"===localStorage.getItem("keepStyleTypeOn"))&&localStorage.setItem("currentStyleType",t);try{await this.updateResources(),o.designMode||(l.currentStyleType=$(t),o.designModeExtended||localStorage.setItem("currentStyleType",t),e("body",parent.document).attr("data-style-type",l.currentStyleType),e("body").attr("data-style-type",l.currentStyleType)),"ADAHideScreen/"!==t&&(s.isWaitSpinnerActive()&&(s.removeWaitSpinner(),setTimeout((()=>s.showWaitSpinner()),5)),s.forceElementsRedraw("object"),s.forceElementsRedraw("#svgDef_slot"),s.forceElementsRedraw("#svgDef_slot_in"))}catch(e){i.error(e)}}}else i.error("StyleResourceResolver::setType Wrong argument 'type' which is invalid!")},updateResources:async function(){i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,". StyleResourceResolver::updateResources"),C();let t=U(),r=null;if(t&&n.STYLE_RESOURCE_MAPPING[E].resolution[G.resolution]?r=n.STYLE_RESOURCE_MAPPING[E].resolution[G.resolution]:t&&(r=n.STYLE_RESOURCE_MAPPING[E].resolution[$(G.resolution)]),r){let t;G.isExplicitMapping=!0;const o={root:G.root,resolution:G.resolution,vendor:G.vendor,type:G.type,lastType:G.lastType,typeIsReady:!1,isExplicitMapping:G.isExplicitMapping,rvt:G.rvt,fileName:"",url:"",order:void 0,addResource:!1};if(!(r.base&&r.vendor&&r.vendor.type))throw"Parameter 'STYLE_RESOURCE_CONFIG' missing configuration attribute(s): Expected at least 'base', 'vendor' and 'vendor.type' per 'resolution' of viewset (touch/softkey). Please check content/Config.json or content/Config.js";try{let n=[];if(!N&&function(){if(!N){let t=e("head").find("link[type='text/css']");for(let e=0;e<t.length;e++)O.push(t[e]);N=!0}}(),W(!0),k(),n=n.concat(r.base),H(o,r.base),r.vendor&&(t=r.vendor[G.vendor]||r.vendor[$(G.vendor)],H(o,t),n=n.concat(t)),!o.typeIsReady&&r.vendor&&r.vendor.type){if(t=r.vendor.type[G.type]||r.vendor.type[$(G.type)],t&&t.length){t=[].concat(t);let e=r.vendor.type[G.lastType]||r.vendor.type[$(G.lastType)];(function(e,t){let r=null;return Array.isArray(t)&&(r=t.find((t=>t.includes("[")&&$(e.type)===$(t.substring(1,t.indexOf("]")))))),r})(o,e)&&(t.forEach(((e,r)=>{e.includes(":")?t[r]:t[r]=`${e}:add`})),t=e.concat(t)),t=function(e){return e.filter((e=>!e.includes("[")))}(t)}H(o,t),n=n.concat(t)}H(o,r.additional),r.additional&&r.additional.length&&(n=n.concat(r.additional)),function(t,r){if(r.length){let o=e("head").find("link[type='text/css']");for(let n=0;n<o.length;n++){let s=e(o[n]);if("true"!==s.attr("data-additional-style")){let e=s.attr("href");e=e?.substr(t.root.length),r.includes(e)||s.attr("data-style-removal","true")}}}}(o,n),setTimeout((()=>{W(!1,"data-style-removal")}),25);for(let e=0;e<m.length;e++)this.addStyleSheet(m[e])}catch(e){throw`Problem during style resource resolving for Config::STYLE_RESOURCE_MAPPING: ${e}`}}else{G.isExplicitMapping&&(G.isExplicitMapping=!1,W(!0),k());let e=0,t=G.resourceRepos;try{for(let r=t.length-1;r>=0;r--){V(await this.findResource(t[r])),++e===t.length&&i.LOG_ANALYSE&&i.log(i.LOG_ANALYSE,`. StyleResourceResolver::updateResources styleResourceConfig=${JSON.stringify(G)}`)}for(let e=0;e<m.length;e++)this.addStyleSheet(m[e])}catch(e){throw e}}},findResource:function(e){return i.LOG_DETAIL&&i.log(i.LOG_DETAIL,`. StyleResourceResolver::findResource fileName=${e}`),r.Promises.promise(((t,r)=>{let o={root:G.root,resolution:G.resolution,vendor:G.vendor,type:G.type,fileName:e,url:""},n=M(o,e);function s(e){o.url!==e&&(o.url=e),t(o)}P(n).then((e=>s(e))).catch((()=>{o.type=y,n=M(o,e),P(n).then((e=>s(e))).catch((()=>{o.vendor=y,o.type=G.type,n=M(o,e),P(n).then((e=>s(e))).catch((()=>{o.type=y,n=M(o,e),P(n).then((e=>s(e))).catch((()=>{o.resolution=y,o.vendor=G.vendor,o.type=G.type,n=M(o,e),P(n).then((e=>s(e))).catch((()=>{o.type=y,n=M(o,e),P(n).then((e=>s(e))).catch((()=>{o.vendor=y,o.type=G.type,n=M(o,e),P(n).then((e=>s(e))).catch((()=>{o.type=y,n=M(o,e),P(n).then((e=>s(e))).catch((()=>{i.error(`error StyleResourceResolver::findResource style resource not found fileName=${e}`),r()}))}))}))}))}))}))}))}))}))}};return s.setStyleResolver(F),Wincor.UI.Content.StyleResourceResolver=F,Wincor.UI.Content.StyleResourceResolver}));