/**
 @preserve
 Copyright (c) 2001-2021 by Wincor Nixdorf International GmbH,
 Heinz-Nixdorf-Ring 1, 33106 Paderborn, Germany

 This software is the confidential and proprietary information
 of Diebold Nixdorf.
 You shall not disclose such Confidential Information and shall
 use it only in accordance with the terms of the license agreement
 you entered into with Diebold Nixdorf.

$MOD$ UICommanding.js 4.3.1-210521-21-5b4bc154-1a04bc7d
 */
define(["jquery","knockout","ui-content","extensions","lib/hammer.min","config/Config"],(function(e,t,i,s,a,n){"use strict";const d=Wincor.UI.Service.Provider.LogProvider,l=Wincor.UI.Service.Provider.EppService,o=Wincor.UI.Service.Provider.AdaService,r=Wincor.UI.Service.Provider.ConfigService;let m=2e4;try{m=i.designMode?2e4:r.configuration[r.configuration.instanceName].TimeoutActivate}catch(e){}const c=m?.5*m:2e4;let g,u=0,h=o.state;i.designMode||o.registerForServiceEvent(o.SERVICE_EVENTS.STATE_CHANGED,(async e=>{if(e===h)return;h=e,await g.whenActivationStarted();const t=Wincor.UI.Content.Commanding.commands;Object.keys(t).filter((e=>!Number.isNaN(parseInt(t[e].adaKey))&&t[e].isActive.value())).map((i=>{e===o.STATE_VALUES.SPEAK?p.claimKeys(t[i],!0):p.releaseKeys(t[i],!0)}))}),o.DISPOSAL_TRIGGER_SHUTDOWN);const p=new function(){const e="CLAIM",t="RELEASE";function a(e,t){if(Wincor.UI.Content.Commanding._processing)return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,". UICommanding::EppHandler::onEppEvent commanding is processing currently... skipping event"),!1;if(e.isActive.value()){let i;return e.triggeredByEpp=!0,e&&(i=e.element&&e.element.nodeName?e.element.nodeName.toUpperCase():"",d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. UICommanding::onEppKeyPressedEvent triggering key ${e.element&&e.element.id} - nodeName ${i}`),i&&"INPUT"!==i?!e.suspended&&e.isActive.value()&&Wincor.UI.Content.ViewModelHelper.triggerEvent("uicommandautomation",{object:e.element.id,eppKey:t,viewModel:e.viewModel}):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. UICommanding::onEppKeyPressedEvent manually executing command ${e.id}`),e.delegates._execute({eppKey:t}))),!0}}function n(e,t,i){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`> UICommanding::onEppClaimStatusChangedEvent received change: ${t}=${i}`);const s=Wincor.UI.Content.Commanding;try{let a;const n=i!==l.CLAIMSTATUS_ENABLED;d.LOG_DETAIL&&d.log(d.LOG_DETAIL,". UICommanding::onEppClaimStatusChangedEvent - "+(n?"suspend ":"resume ")+t),a=s.getByEppKey([t.toString()]),a.length>0?n?s.suspend(a,e.viewModel.observableAreaId,!1):s.resume(a,e.viewModel.observableAreaId):d.LOG_ANALYSE&&d.log(d.LOG_ANALYSE,`. UICommanding::onEppClaimStatusChangedEvent - no command associated with '${t}', please check this!`),Wincor.UI.Content.Ada._adaEnabled&&Wincor.UI.Content.Ada.mixAda()}catch(t){this.handleError(t,"UICommanding::onEppClaimStatusChangedEvent for cmd"+e.id)}d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< UICommanding::onEppClaimStatusChangedEvent")}async function r(e,t=!1){const i=-1===e.claimIdAda&&e.adaKey&&!Number.isNaN(parseInt(e.adaKey))&&Wincor.UI.Content.Ada._adaModeConventional&&o.state===o.STATE_VALUES.SPEAK,s=-1===e.claimId&&e.eppKeys&&e.eppKeys.length>0;if(s&&(e.claimId=0),i&&(e.claimIdAda=0),s||i)try{await g.whenActivationStarted()}catch(t){throw d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* EppHandler::claimKeys for "+e.id+" cancelled before activationStarted... "),e.claimId=-1,t}if(s&&!t){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* UICommanding::EppHandler::claimKeys eppkeys:"+e.eppKeys+" for "+e.id);const t=e.eppKeys.slice();if(e.viewModel){let i=await l.claimKeys(t,-1,void 0,a.bind(null,e),n.bind(null,e));d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* EppHandler::claimKeys for ${e.id} returned ${JSON.stringify(i,null," ")}`),e.claimId=i.claimId,t.forEach((t=>{i[t]===l.CLAIMSTATUS_DISABLED&&n(e,t,i[t])}))}else d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* EppHandler::claimKeys for "+e.id+" ViewModel is not alive anymore... "),e.claimId=-1}if(i){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* UICommanding::EppHandler::claimKeys adakey:"+e.adaKey+" for "+e.id);if(e.viewModel){let t=await l.claimKeys([String(e.adaKey)],-1,void 0,a.bind(null,e),n.bind(null,e));d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* EppHandler::claimKeys for ${e.id} returned ${JSON.stringify(t,null," ")}`),e.claimIdAda=t.claimId,t[e.claimIdAda]===l.CLAIMSTATUS_DISABLED&&n(e,e.claimIdAda,t[e.claimIdAda])}else d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* EppHandler::claimKeys for "+e.id+" ViewModel is not alive anymore... "),e.claimIdAda=-1}}function m(e,t=!1){return s.Promises.promise((async(i,s)=>{!t&&e.claimId>=0&&e.eppKeys&&e.eppKeys.length>0&&(await l.releaseKeys(e.claimId,void 0),e&&e.id&&e.claimId?(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* EppHandler::releaseKeys for "+e.id+" with claimId "+e.claimId+" finished"),e.claimId=-1):d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* EppHandler::releaseKeys for "+e.id+" command already destroyed...")),e.claimIdAda>=0&&(await l.releaseKeys(e.claimIdAda,void 0),e&&e.id&&e.claimIdAda?(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* EppHandler::releaseKeys for "+e.id+" with claimIdAda "+e.claimIdAda+" finished"),e.claimIdAda=-1):d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* EppHandler::releaseKeys for "+e.id+" command already destroyed...")),i()}))}this.asyncJobQueue=(new s.Promises.AsyncJobQueue).setName("EppHandler").setStopOnError(!1).setConcurrency(!0),this.claimKeys=function(t,s=!1){if(!i.designMode){let a=this.asyncJobQueue.add(r.bind(null,t,s),e,c,"Commanding::claimKeys for "+t.id,g.whenActivationStarted());i.ViewModelContainer.addActivationDelay(a)}},this.releaseKeys=function(e,s=!1){i.designMode||this.asyncJobQueue.add(m.bind(null,e,s),t,c,"Commanding::releaseKeys for "+e.id)}};function L(e){return e.eppKeys&&e.eppKeys.length>0||!Number.isNaN(e.adaKey)}function A(t,i){try{d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* Commanding updateStatesFromViewStateChange "+t.id+" val: "+i),i=isNaN(parseInt(i))?-1:parseInt(i);let s=!1,a=!1,l=_[t.isActive.value()][t.isVisible.value()][t.isPressed.value()];if(i===l)return void(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* Commanding updateStatesFromViewStateChange skip! newValue === oldValue"));if(i>=0&&i<=5){switch(i){case 0:3===l&&e(t.element).removeAttr("disabled");const i=e(t.element),d=t.element&&t.element.hasAttribute("disabled");"none"!==i.css("display")&&"hidden"!==i.css("visibility")||i.css({display:"",visibility:""}),s=!t.isVisible.value()&&L(t),t.isActive.value(!0),t.isVisible.value(!0),t.isPressed.value(!1),n.VIEW_ANIMATIONS_ON&&n.BORDER_DRAWING_ON&&!d&&3===t.initialViewState&&i.hasClass("borderDrawing")&&(i.closest("#flexFooter").length&&n.FOOTER_ANIMATIONS_ON||g.whenActivated().then((()=>{g.viewHelper.borderDrawing.prepare(i),g.viewHelper.borderDrawing.draw(i)})));break;case 1:s=!t.isActive.value()&&L(t),t.isActive.value(!0),t.isVisible.value(!0),t.isPressed.value(!0);break;case 2:s=!t.isActive.value()&&L(t),t.isActive.value(!1),t.isVisible.value(!0),t.isPressed.value(!1);break;case 3:a=t.isVisible.value()&&L(t),t.isActive.value(!1),t.isVisible.value(!1),t.isPressed.value(!1);break;case 5:s=!t.isActive.value()&&L(t),t.isActive.value(!0),t.isVisible.value(!0),t.isPressed.value(!1)}d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* updateStatesFromViewStateChange command="+t.id+" state changed to "+i),s&&(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* Commanding updateStatesFromViewStateChange enqueuing claim for "+t.id),p.claimKeys(t)),a&&(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* Commanding updateStatesFromViewStateChange enqueuing release for "+t.id+" with claimId: "+t.claimId),p.releaseKeys(t)),t.listeners._notifyStateChangeListeners()}else d.error("UICommanding::updateStatesFromViewStateChange received invalid values on command '"+t.id+"' ! Value tried to set: "+i)}catch(e){Wincor.UI.Content.designMode?d.error("UICommanding::updateStatesFromViewStateChange exception!\n"+e):Wincor.UI.Service.Provider.propagateError("UICommanding::updateStatesFromViewStateChange","OTHER",e)}}function E(e,t,i,s){let a,n,l=0===(t=Array.isArray(t)?t:void 0!==t?"object"==typeof t?Object.keys(t):[t]:e.cmdIds).length;for(let o=t.length-1;o>=0;o--)n=t[o],void 0!==n?(e.commands.hasOwnProperty(n)||(d.error("UICommanding::makeActiveOrVisible - WARNING\nCommand "+n+" is not available yet/anymore!\nBe sure to ask for a command or defer your operation!\n(see functions 'hasCommand'/'whenAvailable')"),e.createCommand(n)),e.commands.hasOwnProperty(n)&&e.commands[n].hasOwnProperty("id")&&(a=e.commands[n],5===a.initialViewState||!l&&a.id!==t[t.indexOf(n)]||(s?a.suspended?a.suspendMap.__viewStateToResume=i?0:2:a.isActive.update(i):a.suspended?a.suspendMap.__viewStateToResume=i?2:3:a.isVisible.update(i)))):d.error("UICommand:makeActiveOrVisible - key is undefined")}const _={true:{true:{true:1,false:0},false:{true:3,false:3}},false:{true:{true:2,false:2},false:{true:3,false:3}}};class I{constructor(e){this.id=e,this.resolve=function(){},this.reject=function(){},this.dispose=function(){this.reject(),this.resolve=null,this.reject=null,this.promise=null,this.dispose=null},this.promise=s.Promises.promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class y{constructor(e){let i=this,a=!0,n=!0,l=!0;this.ensured=!1,this.initialViewState=-1,this.viewModel=null,this.commanding=e,this.id="";let o=null;Object.defineProperty(this,"element",{get:function(){return o},set:function(e){Object.values(i.commanding.commands).reduce(((t,i)=>t&&(!i.element||!e||i.element.id!==e.id)),!0)||(null!==i.commanding.getCommandByElementId(e.id)?d.error(`ERROR! UICommand: assigning dom element '${e.id}' to command '${i.id}' duplicates command '${i.commanding.getCommandByElementId(e.id).id}'!!!`):d.error(`ERROR! UICommand: assigning dom element '${e.id}' to command '${i.id}' duplicates command with id=null!!!`)),o=e}}),this.type="",this.label=null,this.eppKeys=null,this.adaText=null,this.adaTextPost=null,this.adaMacroResolved=t.observable(""),this.adaKey=null,this.adaType="",this.textKey=null,this._viewStateSubscription=null,this.suspended=!1,this.suspendMap={__viewStateToResume:5},this.ignoreState=!1,this._suspendId=0,this.claimId=-1,this.claimIdAda=-1,this.triggeredByEpp=!1,this.setInitialViewState=function(e){return-1===this.initialViewState&&(this.initialViewState=e,this.suspendMap.__viewStateToResume=e,!0)},this.suspend=function(e,t=!0){let i;"boolean"==typeof e&&!0===t&&(t=e,e=null);const s=this.isActive.value();return this.suspended||(this.suspendMap.__viewStateToResume=this.viewState.value()),e?"string"==typeof e?(this.suspendMap[e]=!0,i=e):d.error("UICommand::suspend: Explicit suspendId is of wrong type "+typeof e):(this._suspendId+=1,this.suspendMap[this._suspendId]=!0,i=this._suspendId),i&&(s&&this.isActive.update(!1),this.eppKeys&&t&&p.releaseKeys(this),this.suspended=!0),i},this.resume=function(e){let t=!0;if(this.suspended){e&&this.suspendMap.hasOwnProperty(e)&&(this.suspendMap[e]=!1);for(let e in this.suspendMap)if("__viewStateToResume"!==e&&this.suspendMap.hasOwnProperty(e)&&this.suspendMap[e]){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`UICommand::resume ${this.id} stays suspended due to suspension of ${e}`),t=!1;break}if(t){this.suspended=!1;let e=this.suspendMap.__viewStateToResume;this.viewState.update(e),this.isVisible.value()&&this.eppKeys&&p.claimKeys(this)}}else d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`UICommand::resume ${this.id} was not suspended`),t=!1;return t},this.setArgs=function(e){Array.isArray(e)?(e.push(this.id),this.delegates._args=e):this.delegates._args=[e,this.id]},this.setAda=function(e,t,i,s){e&&(this.adaType=e),t&&(this.adakey=t),i&&(this.adaText=i),s&&(this.adaTextPost=s)},this.isActive={value:t.observable(!1),update:function(e){(this.value()!==e||a)&&(i.viewState.update(e?0:2),a=!1)}},this.isVisible={value:t.observable(!1),update:function(e){(this.value()!==e||n)&&(i.viewState.update(e?2:3),n=!1)}},this.isPressed={value:t.observable(!1),update:function(e){if(this.value()!==e||l){this.value(e);let t=i.isActive.value(),s=i.isVisible.value();i.viewState.update(e?1:_[t][s][e]),l=!1}}},this.viewState={self:this,value:function(){let e=t.observable(-1);return i._viewStateSubscription=e.subscribe(A.bind(i,i)),e}(),update:function(e){if(i.suspended)i.suspendMap.__viewStateToResume=e;else if(!t.isComputed(this.value)||t.isWriteableObservable(this.value))this.value(parseInt(e));else{let e=function e(i){let s=null;for(let a=0;a<i.length;a++){let n=i[a];if(!t.isComputed(n)){s=n;break}if(s=e(n.getDependencies()),!t.isComputed(s))break}return s}(this.value.getDependencies());e&&e.valueHasMutated()}},key:"",redirect:function(e){return t.isObservable(e)&&(A(i,e()),i._viewStateSubscription&&(i._viewStateSubscription.dispose(),i._viewStateSubscription=null),i._viewStateSubscription=e.extend({notify:"always"}).subscribe((e=>{i.suspended?(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* commanding -> redirected state of ${i.id} (suspended) changed to ${e} - setting viewStateToResume`),i.suspendMap.__viewStateToResume=e):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* commanding -> redirected state of ${i.id} changed to ${e}`),A(i,e))})),this.value=e),this.value}},this.listeners={_stateChangeListeners:[],_actionListeners:[],addStateChangeListener:function(e,t){e&&i.listeners._stateChangeListeners.push([e,t])},_notifyStateChangeListeners:function(){let e={id:i.id,viewState:i.viewState.value(),isActive:i.isActive.value(),isVisible:i.isVisible.value(),isPressed:i.isPressed.value()};i.listeners._stateChangeListeners.forEach((function(t){try{t[0]&&t[0].call(t[1],e)}catch(e){Wincor.UI.Content.designMode?d.error(`Exception on UICommand._notifyStateChangeListener() id: ${i.id} error: ${e}`):Wincor.UI.Service.Provider.propagateError("UICommand::listeners::_notifyStateChangeListener","OTHER",e)}}))},addActionListener:function(e,t){e&&i.listeners._actionListeners.push([e,t])},_notifyActionListeners:function(e){let t={id:i.id};e&&(t=Object.assign({},t,e)),i.listeners._actionListeners.forEach((function(e){try{e[0]&&e[0].call(e[1],t)}catch(e){Wincor.UI.Content.designMode?d.error(`Exception on UICommand._notifyActionListeners() id: ${i.id} error: ${e}`):Wincor.UI.Service.Provider.propagateError("UICommand::listeners::_notifyActionListeners","OTHER",e)}}))}},this.delegates={_delegates:[],_prioDelegates:[],_action:void 0,_context:null,_args:null,add:function(e,t,i){return u>=Number.MAX_SAFE_INTEGER&&(u=0),u++,t?(this.delegates._prioDelegates.push([e,i||this.delegates._context,u]),u):(this.delegates._delegates.push([e,i||this.delegates._context,u]),u)}.bind(this),_init:function(e,t,i){this.delegates._action=e,this.delegates._context=t,i.push?this.delegates._args=i:this.delegates._args=[i],this.delegates._args.push(this.id)}.bind(this),_execute:function(e){if(this.commanding._processing)return void(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* commanding -> _execute for '${this.commanding._processing}' currently processing! Skipping ${this.id}`));let t=this.viewState.value();if(!this.suspended&&(0===t||1===t||5===t)){let t="__command_PCEFlexUI_DoRestore",i=t,a=!0,n=[];if(this.commanding._processing=this.id,this.eppKeys&&this.eppKeys.length>1&&e&&e.eppKey){if(this.delegates._args.length-1===this.eppKeys.length){let t=this.eppKeys.indexOf(e.eppKey);-1!==t&&this.delegates._args.length-1>t?(i=this.delegates._args[0],this.delegates._args[0]=this.delegates._args[t],a=!1):-1===t&&e.eppKey===this.adaKey&&(i=this.delegates._args[0],a=!1)}a&&(i=this.delegates._args[0],this.delegates._args[0]=e.eppKey)}let l,o=!1;this.delegates._prioDelegates.concat(this.delegates._delegates).forEach(function(e){if(e&&(!e[1]||!e[1].vmContainer||g.isViewModelActive(e[1])))try{l=e[0].apply(e[1],this.delegates._args),n.push(l)}catch(t){d.error(`Exception on (prio) delegate of UICommand._execute() id: ${this.id} error: ${t.message}\r\nDelegate function: ${e[0]} context: ${e[1]} args: ${this.delegates._args}`)}}.bind(this)),s.Promises.Promise.all(n).then(function(e){for(let t=0;!o&&t<e.length;t++)!0===e[t]&&(o=!0);if(o||!this.delegates._action||this.delegates._context.vmContainer&&!g.isViewModelActive(this.delegates._context))this.listeners._notifyActionListeners({actionCalled:!1,args:null});else try{this.delegates._action.apply(this.delegates._context,this.delegates._args),this.listeners._notifyActionListeners({actionCalled:!0,args:this.delegates._args})}catch(e){d.error(`Exception on UICommand._execute() during promise.all, id: ${this.id} error: ${e.message}`)}i!==t&&this.delegates._args&&(this.delegates._args[0]=i),Wincor.UI.Content.Commanding._processing="",this.triggeredByEpp=!1}.bind(this))}}.bind(this),isExisting:function(e,t,i){if(-1!==t.toString().indexOf("[native code]"))return!1;if(Object.is(this.delegates._action,t)&&Object.is(this.delegates._context,i))return!0;for(let i=e.length-1;i>=0;i--)if(Object.is(e[i][0],t))return!0;return!1}.bind(this)},this.asJson=function(){return{id:this.id,elementId:this.element?this.element.id:null,adaType:this.adaType,adaKey:this.adaKey,adaText:this.adaText,label:t.isObservable(this.label)?this.label():this.label,labelKey:this.textKey,viewStateKey:this.viewState.key,viewState:t.isObservable(this.viewState.value)?this.viewState.value():this.viewState.value}}}}return Wincor.UI.Content.Commanding=new class{commands=null;DELEGATE_MARKER="__ProFlex4UI_CommandingDelegateIds";LISTENER_MARKER="__ProFlex4UI_CommandingListenerIds";_omitSingleRemove=!1;_processing="";deferredAvailabilityMap={};cmdIds=[];CMDSTATES={ENABLED:0,PRESSED:1,DISABLED:2,HIDDEN:3,NONE:5};CMDTYPES={BUTTON:"Button",TEXT:"Text",FIELD:"Field",CHECKBOX:"Checkbox",RADIOBUTTON:"Radiobutton",ITEM:"Item",OTHER:"Other"};constructor(){this.commands={}}asJson(){let e,t=[];for(let i in this.commands)this.commands.hasOwnProperty(i)&&"asJson"in(e=this.commands[i])&&t.push(e.asJson());return{commands:t}}createCommands(e){if(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* createCommands: ids = '"+JSON.stringify(e)+"'"),e.constructor===Object){let t=[];for(let i in e)e.hasOwnProperty(i)&&t.push(i);e=t}let t=(e=Array.isArray(e)?e:[]).length;for(let i=0;i<t;i++)this.createCommand(e[i]);return this.commands}removeDelegate(e){let t=typeof e,i={};if(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> Commanding::removeDelegate "),Array.isArray(e)?i[this.DELEGATE_MARKER]=e:"number"===t?i[this.DELEGATE_MARKER]=[e]:"object"===t&&(i=e),!i[this.DELEGATE_MARKER]||!Array.isArray(i[this.DELEGATE_MARKER]))return void(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< Commanding::removeDelegate context is not marked: "+i));let s=i[this.DELEGATE_MARKER].length;Object.keys(this.commands).forEach((e=>{i[this.DELEGATE_MARKER].forEach((t=>{this.commands[e].delegates._delegates=this.commands[e].delegates._delegates.filter((e=>e[2]!==t)),this.commands[e].delegates._prioDelegates=this.commands[e].delegates._prioDelegates.filter((e=>e[2]!==t))}))})),delete i[this.DELEGATE_MARKER],d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`< Commanding::removeDelegate removed <${s}> delegates`)}addDelegate(e){let t,i,s=!1,a=e.delegate,n=e.priority,l=e.context,o=e.id,r=e.typeFilter,m=[];if(!a||"function"!=typeof a)return d.error("addDelegate received invalid delegate: "+a),!1;if(!l||"object"!=typeof l)return d.error("addDelegate received invalid context: "+l),!1;if(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> command addDelegate func: "+(e.delegate.name||"[anonymous]")),Array.isArray(o)||"object"!=typeof o||(o=this.getCommandsByViewModel(o).map((function(e){return e.id}))),!o||Array.isArray(o)){let e=o||this.cmdIds,c=!1;for(let s=e.length-1;s>=0;s--)t=this.commands[e[s]],r&&!r.includes(t.type)||(i=t.delegates,n?(c=i.isExisting(i._prioDelegates,a,l),c?d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command addDelegate: skip adding delegate to '"+t.id+"' - delegate already exists!"):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command addDelegate: adding delegate to '"+t.id+"'"),m.push(i.add(a,n,l)))):(c=i.isExisting(i._delegates,a,l),c?d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command addDelegate: skip adding delegate to '"+t.id+"' - delegate already exists!"):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command addDelegate: adding delegate to '"+t.id+"'"),m.push(i.add(a,n,l)))));s=!0}else if(o in this.commands){let e=!1;t=this.commands[o],i=t.delegates,n?(e=i.isExisting(i._prioDelegates,a,l),e?d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command addDelegate: skip adding delegate to '"+t.id+"' - delegate already exists!"):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command addDelegate: adding delegate to '"+t.id+"'"),m.push(i.add(a,n,l)))):(e=i.isExisting(i._delegates,a,l),e?d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command addDelegate: skip adding delegate to '"+t.id+"' - delegate already exists!"):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command addDelegate: adding delegate to '"+t.id+"'"),m.push(i.add(a,n,l)))),s=!0}return m.length>0&&(e.delegateIds=m.slice(),l[this.DELEGATE_MARKER]&&Array.isArray(l[this.DELEGATE_MARKER])?l[this.DELEGATE_MARKER]=l[this.DELEGATE_MARKER].concat(m):l[this.DELEGATE_MARKER]=m.slice()),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< command addDelegate"),s}registerForStateChange(e){let t,i,s=!1,a=!1,n=!1,l="registerForStateChange",o=e.context,r=["_stateChangeListeners"];if(!o||"object"!=typeof o)return d.error("addDelegate received invalid context: "+o),!1;if(arguments.length>1&&"_action"===arguments[arguments.length-1]&&(r=["_actionListeners"],n=!0,l="registerForAction"),!e.listener||"function"!=typeof e.listener)return d.error("registerForStateChange received invalid delegate: "+e.listener),!1;if(!e.id||Array.isArray(e.id)){let o,m=e.id?e.id:this.cmdIds;for(t=m.length-1;t>=0;t--){for(a=!1,o=this.commands[m[t]],i=o.listeners[r].length-1;i>=0&&!a;i--)Object.is(o.listeners[r][i][0],e.listener)&&Object.is(o.listeners[r][i][1],e.context)&&(a=!0);a?d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command "+l+": skip adding listener to '"+o.id+"' - listener already exists!"):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command "+l+": adding listener to '"+o.id+"'"),n?o.listeners.addActionListener(e.listener,e.context):o.listeners.addStateChangeListener(e.listener,e.context))}s=!0}else if(e.id in this.commands){let t=this.commands[e.id];for(i=t.listeners[r].length-1;i>=0&&!a;i--)Object.is(t.listeners[r][i][0],e.listener)&&Object.is(t.listeners[r][i][1],e.context)&&(a=!0);a?d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command "+l+": skip adding listener to '"+t.id+"' - listener already exists!"):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command "+l+": adding listener to '"+t.id+"'"),n?t.listeners.addActionListener(e.listener,e.context):t.listeners.addStateChangeListener(e.listener,e.context)),s=!0}return s}registerForAction(e){return this.registerForStateChange(e,"_action")}getByAdaType(e){let t=[],i=!0;for(let s=this.cmdIds.length-1;s>=0;s--)if(this.commands[this.cmdIds[s]].adaType===e){let e=this.commands[this.cmdIds[s]];i&=null!==e.adaKey,t.push(e)}return i?t.sort(((e,t)=>e.adaKey-t.adaKey)):t.reverse()}getByEppKey(e){let t,i=[];"string"==typeof e?e=[e]:Array.isArray(e)||d.error("UICommanding::getByEppKey parameter 'eppKeys' should by type Array but is: "+typeof e);for(let s=this.cmdIds.length-1;s>=0;s--){t=this.commands[this.cmdIds[s]];for(let s=e.length-1;s>=0;s--)(t.eppKeys&&t.eppKeys.includes(e[s])||t.adaKey&&t.adaKey.toString()===e[s]&&!i.includes(t))&&i.push(t)}return i}setViewModelContainer(e){g=e}suspend(e,t,i=!0){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> UICommanding::suspend("+e+", "+t+")");let s,a,n,l={},o=typeof e;if("string"===o){if(e in this.commands){s=this.commands[e];let a=s.viewModel;n=i&&s.eppKeys&&(!a||a.lifeCycleMode!==a.vmContainer.LIFE_CYCLE_MODE.STATIC),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. UICommanding::suspend id="${s.id}" of "${a.observableAreaId}" lifecycleMode:"${a.lifeCycleMode}"`),l[s.id]=s.suspend(t,n)}}else if(e&&Array.isArray(e))if(0===e.length){for(a=this.cmdIds.length-1;a>=0;a--)if(s=this.commands[this.cmdIds[a]],s){let e=s.viewModel;n=i&&s.eppKeys&&(!e||e.lifeCycleMode!==e.vmContainer.LIFE_CYCLE_MODE.STATIC),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. UICommanding::suspend id="${s.id}" of "${e?e.observableAreaId:"<null>"}" lifecycleMode:"${e?e.lifeCycleMode:"<null>"}"`),l[s.id]=s.suspend(t,n)}}else if(o=typeof e[0],"string"===o){for(a=e.length-1;a>=0;a--)if(s=this.commands[e[a]],s){let e=s.viewModel;n=i&&s.eppKeys&&(!e||e.lifeCycleMode!==e.vmContainer.LIFE_CYCLE_MODE.STATIC),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. UICommanding::suspend id="${s.id}" of "${e?e.observableAreaId:"<null>"}" lifecycleMode:"${e?e.lifeCycleMode:"<null>"}"`),l[s.id]=s.suspend(t,n)}}else if("object"===o)for(a=e.length-1;a>=0;a--)if(e[a].id&&e[a].suspend){let s=e[a].viewModel;n=i&&e[a].eppKeys&&(!s||s.lifeCycleMode!==s.vmContainer.LIFE_CYCLE_MODE.STATIC),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. UICommanding::suspend id="${e[a].id}" of "${s?s.observableAreaId:"<null>"}" lifecycleMode:"${s?s.lifeCycleMode:"<null>"}"`),l[e[a].id]=e[a].suspend(t,n)}return"vmc:deact"===t&&this.removeDeferredAvailability(Object.keys(this.deferredAvailabilityMap).filter((e=>!this.hasCommand(e)))),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< UICommanding::suspend returns "+JSON.stringify(l,null," ")),l}resume(e,t){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> UICommanding::resume("+e+", "+t+")");let i,s,a={},n=typeof e;if("undefined"!==n&&t&&Array.isArray(e))if(e.length>0){if(n=typeof e[0],"string"===n)for(s=e.length-1;s>=0;s--)i=this.commands[e[s]],i&&(a[i.id]=i.resume(t));else if("object"===n)for(s=e.length-1;s>=0;s--)e[s].id&&e[s].suspend&&(a[e[s].id]=e[s].resume(t))}else for(s=this.cmdIds.length-1;s>=0;s--)i=this.commands[this.cmdIds[s]],i&&(a[i.id]=i.resume(t));else if("string"===n&&t)for(s=this.cmdIds.length-1;s>=0;s--)i=this.commands[this.cmdIds[s]],i&&(a[i.id]=i.resume(t));else if(e&&"object"===n)for(s in e)e.hasOwnProperty(s)&&this.hasCommand(s)&&(a[s]=this.commands[s].resume(e[s]));else d.error("UICommanding::resume - invalid arguments suspendIds: "+e+", explicitSuspendId: "+t);return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< UICommanding::resume returns "+JSON.stringify(a,null," ")),a}setCmdLabel(e,t){return!(!this.commands.hasOwnProperty(e)||!this.commands[e].label)&&(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. UICommanding::setCmdLabel set cmd=${e} label text=${t}`),this.commands[e].label(t),!0)}getCmdLabel(e){return this.commands.hasOwnProperty(e)?t.isObservable(this.commands[e].label)?this.commands[e].label():this.commands[e].label:""}ensure(e,t){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`> Commanding::ensure(${JSON.stringify(e)}, ${JSON.stringify(t)})`);let i,s={},a=!0;Array.isArray(e)||(e=[e]),t&&!Array.isArray(t)&&(t=[t]);for(let n=e.length-1;n>=0;n--)i=this.commands[e[n]],i&&(i.ensured=!0),this.deferredAvailabilityMap[e[n]]?(this.deferredAvailabilityMap[e[n]].resolve.apply(this,t),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* command ensuring ${e[n]}`),s[e[n]]=!0):(a=!1,s[e[n]]=!1);return s.success=a,d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`< Commanding::ensure returns ${JSON.stringify(s)}`),s}isEnsured(e){return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command isEnsured "+e+" -> "+(this.commands[e]&&this.commands[e].ensured)),this.commands[e]&&this.commands[e].ensured}createCommand(e){if(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`> command createCommand: id= '${e}'`),e in this.commands)d.error(`Warning! Command id '${e}' already exists! Use unique command id's only!`);else{let t=new y(this);t.id=e,this.commands[e]=t,this.cmdIds.push(e),e in this.deferredAvailabilityMap||(this.deferredAvailabilityMap[e]=new I(e))}return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< command createCommand"),this.commands[e]}resetViewStates(e,t,i){Array.isArray(e)||"object"!=typeof e?"string"==typeof e&&(e=[e]):e=this.getCommandsByViewModel(e).map((e=>e.id));for(let s=this.cmdIds.length-1;s>=0;s--){let a,n=this.commands[this.cmdIds[s]];!n||-1===n.initialViewState||e&&!e.includes(n.id)||t&&t.includes(n.id)||(i&&n.id in i?(a=i[n.id],d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* command resetting viewstate of ${n.id} to commandconfig ${a}`)):(a=n.initialViewState,d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* command resetting viewstate of ${n.id} to initialViewState ${a}`)),isNaN(a)||(n.suspended?n.suspendMap.__viewStateToResume=a:n.viewState.update(a)))}}getViewState(e){return e&&this.commands.hasOwnProperty(e)?this.commands[e].viewState.value():-1}setViewState(e,t){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`> Commanding::setViewState(${e}, ${t})`);let i=!1;if(this.commands.hasOwnProperty(e)&&void 0!==t){let s=this.commands[e];s.suspended?(s.suspendMap.__viewStateToResume=parseInt(t),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,". command is suspended, only setting state for resume")):(s.viewState.update(t),i=!0)}return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< Commanding::setViewState"),i}setActive(e,t){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> Commanding::setActive("+e+", "+t+")"),"boolean"==typeof e&&void 0===t&&(t=e,e=[]),E(this,e,void 0===t||t,!0),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< Commanding::setActive")}isActive(e){return!!this.commands.hasOwnProperty(e)&&(!this.commands[e].suspended&&this.commands[e].isActive.value())}setVisible(e,t){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> Commanding::setVisible("+e+", "+t+")"),E(this,e,void 0!==t&&t,!1),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< Commanding::setVisible")}isVisible(e){return!!this.commands.hasOwnProperty(e)&&this.commands[e].isVisible.value()}setPressed(e,t){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> Commanding::setPressed("+e+", "+t+")");for(let i=(e=Array.isArray(e)?e:[e]).length-1;i>=0;i--)this.commands[e[i]].isPressed.update(t),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command setting "+e[i]+" pressed "+t);d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< Commanding::setPressed")}isPressed(e){return!!this.commands.hasOwnProperty(e)&&this.commands[e].isPressed.value()}getCmdAdaText(e,i){return this.commands.hasOwnProperty(e)?i?t.isObservable(this.commands[e].adaTextPost)?this.commands[e].adaTextPost():this.commands[e].adaTextPost:t.isObservable(this.commands[e].adaText)?this.commands[e].adaText():this.commands[e].adaText:""}getCommandsByViewModel(e){if(!["object","string"].includes(typeof e))return[];let t="object"==typeof e;return Object.keys(this.commands).map((e=>this.commands[e])).filter((i=>t?i&&e===i.viewModel:i&&i.viewModel&&e===i.viewModel.observableAreaId))}getBoundElement(e){return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command getBoundElement("+e+")"),this.commands.hasOwnProperty(e)?(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command getBoundElement, element='"+this.commands[e].element+"'"),this.commands[e].element):null}hasCommand(e){return e in this.commands}whenAvailable(e){Array.isArray(e)||(e=[e]);let t=[];for(let i=e.length-1;i>=0;i--)e[i]in this.deferredAvailabilityMap||(this.deferredAvailabilityMap[e[i]]=new I(e[i])),t.push(this.deferredAvailabilityMap[e[i]].promise);return s.Promises.Promise.race([s.Promises.Promise.all(t),s.Promises.promise(((e,t)=>{g?g.whenDeactivated().then(t):t()}))]).catch((t=>(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* command ${e} whenAvailable rejected with reason: ${t}`),s.Promises.Promise.reject(t||`* command ${e} whenAvailable rejected due to deactivation`))))}getCommandsByViewStateKey(e){let t=[];for(let i=this.cmdIds.length-1;i>=0;i--){let s=this.commands[this.cmdIds[i]];s.viewState.key===e&&t.push(s)}return t}getCommandByElementId(e){let t=document.getElementById(e);return t&&t.__commandId_PCEFlexUI?this.commands[t.__commandId_PCEFlexUI]:null}get(e){return e in this.commands?this.commands[e]:null}execute(e){e in this.commands&&this.commands[e].delegates._execute()}removeDeferredAvailability(e){let t;e||(t=Object.keys(this.deferredAvailabilityMap)),t=t||(Array.isArray(e)?e:[e]),t=t.map((e=>"object"==typeof e?e.id:e)),t.forEach((e=>{this.deferredAvailabilityMap[e]&&(this.deferredAvailabilityMap[e].dispose(),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* command rejecting deferred availability for ${e}`),this.deferredAvailabilityMap[e]=null,delete this.deferredAvailabilityMap[e])}))}isUICommand(e){return e instanceof y}removeListeners(e){let t,i;d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> Commanding::removeListeners(...)"),"object"!=typeof e||this.isUICommand(e)||(i=e),e&&!i||(t=Object.keys(this.commands).map((e=>this.commands[e]))),t=t||(Array.isArray(e)?e:[e]),t=t.map((e=>"string"==typeof e?this.get(e):e)),t.forEach((e=>{d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. Commanding::removeListeners for ${e.id}`);let t,s=e.listeners._stateChangeListeners,a=e.listeners._actionListeners;for(t=s.length-1;t>=0;t--)(!i||i&&Object.is(i,s[t][1]))&&(s[t][0]=null,s[t][1]=null,s[t]=null,s.splice(t,1));for(t=a.length-1;t>=0;t--)(!i||i&&Object.is(i,a[t][1]))&&(a[t][0]=null,a[t][1]=null,a[t]=null,a.splice(t,1))})),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< Commanding::removeListeners")}removeCommand(e){let t=Array.isArray(e);t||"object"!=typeof e?t||(e=[e]):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* command removing commands for vm ${e.observableAreaId}`),e=this.getCommandsByViewModel(e).map((function(e){return e.id})),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* command removing commands: ${e.join(", ")}`));for(let t=e.length-1;t>=0;t--){let i=this.commands[e[t]];if(i){try{(i.claimId>=0&&i.eppKeys||i.claimIdAda>=0)&&(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* Commanding::removeCommand releaseKeys:${i.eppKeys} / adaKey: ${i.adaKey} for ${i.id}`),p.releaseKeys(i)),i.viewModel=null;let e=i.delegates.handlers;"object"==typeof e&&Object.keys(e).forEach((function(t){e[t]=null,delete e[t]}))}catch(e){}try{i.delegates.hammer&&(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* command removing gesture tap from "+e[t]),i.delegates.hammer.stop(!0),i.delegates.hammer.off("tap"),i.delegates.hammer.off("pressup"),i.delegates._execute=void 0,i.delegates.hammer.remove("Tap"),i.delegates.hammer.remove("Press"),i.delegates.hammer.destroy(),i.delegates.hammer.input=null,i.delegates.hammer.options.inputTarget=null,i.delegates.hammer=null)}catch(e){}let s,a=i.delegates._delegates,n=i.delegates._prioDelegates;for(s=a.length-1;s>=0;s--)a[s][0]=null,a[s][1]=null;for(s=n.length-1;s>=0;s--)n[s][0]=null,n[s][1]=null;i.delegates._action=null,i.delegates._context=null,i.delegates._args=null,i.delegates._execute=null,i.delegates._init=null,this.removeDeferredAvailability(i),this.removeListeners(i),i.label=null,i.isActive.value=null,i.isActive.update=null,i.isActive=null,i.isVisible.value=null,i.isVisible.update=null,i.isVisible=null,i.isPressed.value=null,i.isPressed.update=null,i.isPressed=null,i.viewState.value=null,i.viewState=null,i.element&&i.element.__commandId_PCEFlexUI&&(i.element.__commandId_PCEFlexUI=null,delete i.element.__commandId_PCEFlexUI),i.element=null,i.commanding=null,i._viewStateSubscription&&i._viewStateSubscription.dispose(),this._omitSingleRemove||(this.cmdIds.splice(this.cmdIds.indexOf(e[t]),1),delete this.commands[e[t]])}}}whenEppProcessingDone(){return p.asyncJobQueue.mainPromise}cancelEppProcessing(){return p.asyncJobQueue.cancel("Commanding::cancelEppQueue")}dispose(){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* commanding dispose"),this._omitSingleRemove=!0,this.removeCommand(this.cmdIds),this.deferredAvailabilityMap={},this._omitSingleRemove=!1,this._processing="",this.cmdIds=[],this.commands={}}toString(){let e="commands=[",t=this.cmdIds.length,i=this;return e=t>0?e:"[]",this.cmdIds.forEach(((s,a)=>{e+=`${s}(state=${i.commands[s].viewState.value()}, key=${i.commands[s].viewState.key})`,e+=a<t-1?", ":"]"})),e}},Wincor.UI.Content.Commanding}));