/**
 @preserve
 Copyright (c) 2001-2020 by Wincor Nixdorf International GmbH,
 Heinz-Nixdorf-Ring 1, 33106 Paderborn, Germany

 This software is the confidential and proprietary information
 of Diebold Nixdorf.
 You shall not disclose such Confidential Information and shall
 use it only in accordance with the terms of the license agreement
 you entered into with Diebold Nixdorf.


$MOD$ ViewModelHelper.js 4.3.1-210201-21-63dc475c-1a04bc7d
 */
define(["jquery","knockout","ui-content","vm-container","vm-util/UICommanding","code-behind/ViewHelper","vm-util/Ada","plugins/router","extensions"],(function(e,t,i,o,n,r,s,p,a){"use strict";let l={};const d=Wincor.UI.Diagnostics.LogProvider,u=Wincor.UI.Service.Provider.ViewService,c=Wincor.UI.Service.Provider.ControlPanelService,h=Wincor.UI.Service.Provider.AdaService,g=Wincor.UI.Service.Provider.JournalService,T={8364:128,8218:130,402:131,8222:132,8230:133,8224:134,8225:135,710:136,8240:137,352:138,8249:139,338:140,381:142,8216:145,8217:146,8220:147,8221:148,8226:149,8211:150,8212:151,732:152,8482:153,353:154,8250:155,339:156,382:158,376:159};let I="*";function L(e){let t=e;return e>255&&T.hasOwnProperty(e)&&(t=T[e],d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* windows1252ToUnicodeMapping converting\nbinary: "+(e>>>0).toString(2)+" -> "+(t>>>0).toString(2)+"\nchar  : ["+String.fromCharCode(e)+"] -> ["+String.fromCharCode(t)+"]\nhex   : 0x"+(e>>>0).toString(16)+" -> 0x"+(t>>>0).toString(16)+"\ndez:  : "+(e>>>0).toString(10)+" -> "+(t>>>0).toString(10))),t}r.setEvent(l);return Wincor.UI.Content.ViewModelHelper=new function(){this.isPopupActive=t.observable(!1),this.isTimeoutPopupActive=function(){return Boolean(this.isPopupActive()&&this.popupOptions.type.includes("TIMEOUT")&&this.getTimerInfo(this.popupOptions.type))},this.popupOptions={type:""},this.viewModelEvent=l,this.suspendedCommandViewStates={};let T=[],m=[],w=-1;this.shutdown=()=>{l=null,this.viewModelEvent=null,this.popupOptions=null,this.suspendedCommandViewStates=null,this.clearTimer()},this.addTimerId=function(e,t="",i=-1,o=null){return T.includes(e)?-1:(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. ViewModelHelper::addTimerId id=${e}`),T.push(e),m.push({id:e,name:t,timeLen:i,timeoutCallback:o}),e)},this.getTimerIds=function(){return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. ViewModelHelper::getTimerIds timerIds=[${T}]`),T},this.getTimerInfo=function(e=this.popupOptions.type){let t=m.find((t=>t.name===e));return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. ViewModelHelper::getTimerInfo timerInfo=${t?JSON.stringify(t):`with name=${e} not existing!`}`),t},this.refreshTimer=function(e,t){let i=m.find((e=>e.name===t));if(i){const o=i.timeoutCallback;return this.clearTimer(i.id),this.startTimer(e,t).onTimeout(o),r.stopTimeoutProgressBar(),r.runTimeoutProgressBar(e),i=m.find((e=>e.name===t)),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. ViewModelHelper::refreshTimer name=${t} has been refreshed, new timerInfo=${JSON.stringify(i)}`),i}return d.LOG_WARNING&&d.log(d.LOG_WARNING,`. ViewModelHelper::refreshTimer name=${t} no timer found with this name to refresh!`),null},this.clearTimer=function(e){if(e>=0){clearTimeout(e);let t=T.indexOf(e);-1!==t&&(T.splice(t,1),m.splice(t,1)),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. ViewModelContainer::clearTimer timer with given id=${e} cleared.`)}else(T.length&&!Number.isInteger(e)||m.length)&&(T.forEach((e=>{clearTimeout(e),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. ViewModelContainer::clearTimer timer with id=${e} internally cleared.`)})),T.length=0,m.length=0)},this.startTimer=function(e,t=""){return!i.designMode&&e>=3e3&&c.newTimerStarted(e),this.startTimer.onTimeout=i=>{if(i&&"function"==typeof i){if(e>0){let o=this.addTimerId(setTimeout((()=>{let e=T.indexOf(o);-1!==e&&(T.splice(e,1),m.splice(e,1)),i()}),e),t,e,i);return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`. ViewModelHelper::startTimer timer with name=${t}, id=${o} and time=${e} started.`),o}return d.LOG_WARNING&&d.log(d.LOG_WARNING,"ViewModelHelper::startTimer Warning: Has been called with timer length <= 0 which may be an issue."),-1}return d.LOG_WARNING&&d.log(d.LOG_WARNING,". ViewModelHelper::startTimer no timer started, due to no timer callback given."),-1},this.startTimer},this.timeoutQuestion=function(){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> ViewModelHelper::timeoutQuestion()");let e=!1,t=!1,i={type:"TIMEOUT_POPUP",onContinue:function(){o.dispatch("onContinue",[this.type])}};if(o.dispatch("onTimeout",[],(function(i){void 0!==i&&(e=!0,t|=i)})),!e&&u.getTimeoutValue()!==u.immediateTimeout){let e=u.viewContext.viewConfig;d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* ViewModelHelper::timeoutQuestion beeping ADA state = "+h.state),h.state!==h.STATE_VALUES.SPEAK&&e&&!0===e.popup.beepontimeout&&(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* ViewModelHelper::timeoutQuestion - beeping: 8 (CCSELFW_SIU_WARNING)!"),Wincor.UI.Service.Provider.BeepService.beep(8,null)),this.showPopupMessage("messagepopup.component.html",i,(e=>{e?d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* ViewModelHelper::timeoutQuestion - successfully loaded popup"):d.error("* ViewModelHelper::timeoutQuestion - error loading popup: messagepopup.component.html")})),t=!0}return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< ViewModelHelper::timeoutQuestion returns handled/implRet = "+e+"/"+t),t},this.cancelQuestion=function(){let e={type:"CANCEL_POPUP",onContinue:function(){o.dispatch("onContinue",[this.type])}};this.showPopupMessage("messagepopup.component.html",e,(e=>{e?d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* ViewModelHelper::cancelQuestion - successfully loaded popup"):d.error("* | VIEW ViewModelHelper::cancelQuestion - error loading popup: messagepopup.component.html")})),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< | VIEW ViewModelHelper::cancelQuestion")},this.cancelView=async function(){d.LOG_INOUT&&d.log(d.LOG_INOUT,"> ViewModelHelper::cancelView");let e=u.viewContext.viewID,t=!1,n=!1;if(!i.designMode&&"GUIAPP"===Wincor.UI.Service.Provider.getInstanceName())try{await h.switchToApp()}catch(e){}d.LOG_WARNING&&d.log(d.LOG_WARNING,"! ViewModelHelper::cancelView ... org viewID:'"+e+"' actual viewID:'"+u.viewContext.viewID+"'."),e===u.viewContext.viewID?(o.dispatch("onCancel",[],(e=>{void 0!==e&&(t=!0,n=n||e)})),t?n||u.endView(u.UIRESULT_CANCEL_USER,"CANCEL"):u.viewContext.viewConfig&&u.viewContext.viewConfig.popup.oncancel?this.cancelQuestion():u.endView(u.UIRESULT_CANCEL_USER,"CANCEL")):d.LOG_WARNING&&d.log(d.LOG_WARNING,"! ViewModelHelper::cancelView ... org view is gone ... ignoring this."),d.LOG_INOUT&&d.log(d.LOG_INOUT,"< ViewModelHelper::cancelView")},this.showPopupMessage=async function(t,r,p){let a;d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`> ViewModelHelper::showPopupMessage(component=${t}, options=${JSON.stringify(r)})`);let l=t=>{d.LOG_DETAIL&&d.log(d.LOG_DETAIL,`* | VIEW ViewModelHelper::showPopupMessageCallbackInternal(success=${t})`),t?(e("[data-view-key]").first().attr("data-popup-type",r.type),Object.keys(a).forEach((e=>{n.get(e).isActive.value()&&(this.suspendedCommandViewStates[e]=n.getViewState(e),n.setViewState(e,n.CMDSTATES.DISABLED))})),u.viewContext&&u.viewContext.viewConfig&&-1===u.viewContext.viewConfig.timeout&&(w=this.startTimer(parseInt(u.inputTimeout),r.type).onTimeout((()=>{this.hidePopupMessage()})))):n.resume([],r.type),this.isPopupActive(t),p&&p(t)};return this.isPopupActive()&&(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,". ViewModelHelper::showPopupMessage PopupMessage is active, hiding it first..."),await this.hidePopupMessage()),a=n.suspend([],r.type),(async()=>{if(!i.designMode&&"GUIAPP"===Wincor.UI.Service.Provider.getInstanceName())try{await h.switchToApp()}catch(e){}!i.designMode&&s._adaEnabled&&h.speak(" ",2,10,null),r&&r.type?(this.popupOptions=Object.assign(r,{}),this.popupOptions.hasOwnProperty("type")||d.error(` | VIEW Popup options lack 'type' attribute for component: ${t}`),o.preserve(),e(this.viewModelEvent).trigger("uipopupmessage",{component:t,callback:l}),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< ViewModelHelper::showPopupMessage")):this.handleError(null,`'options' parameter incorrect, options=${JSON.stringify(r)}`)})()},this.hidePopupMessage=function(){return d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> | VIEW ViewModelHelper::hidePopupMessage()"),this.isPopupActive()?(this.clearTimer(w),w=-1,a.Promises.Promise.resolve().then((()=>a.Promises.promise((t=>{let r={promise:{}};o.isPreserved()&&o.cleanNodes(!1,!1),e(this.viewModelEvent).trigger("uiremovepopupmessage",{result:r}),r.promise.then((()=>{if(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* | VIEW hidePopupMessage removed from DOM"),e("[data-view-key]").first().removeAttr("data-popup-type"),this.popupOptions.onContinue)try{this.popupOptions.onContinue()}catch(e){d.error(`* ViewModelHelper::hidePopupMessage - error calling 'onContinue' - popupOptions: ${JSON.stringify(this.popupOptions,null," ")}`)}o.isPreserved()&&(o.deactivateViewModels(),o.clean(!1,!1),o.remove(void 0,!1),o.restore()),Object.keys(this.suspendedCommandViewStates).forEach((e=>{n.getViewState(e)===n.CMDSTATES.DISABLED&&n.setViewState(e,this.suspendedCommandViewStates[e])})),n.resume([],this.popupOptions.type),this.isPopupActive(!1),this.popupOptions={type:""},this.suspendedCommandViewStates={},!i.designMode&&u.firePopupNotification&&n.whenEppProcessingDone().then((()=>{u.firePopupNotification(!1,this.popupOptions.type)})),this.notifyViewUpdated(),t()})).catch((e=>{i.designMode?d.error("EXCEPTION in ViewModelHelper::hidePopupMessage -> "+e):Wincor.UI.Service.Provider.propagateError("ViewModelHelper::hidePopupMessage","POPUP",e)})),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< | VIEW ViewModelHelper::hidePopupMessage")}))))):(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< | VIEW ViewModelHelper::hidePopupMessage no popup active"),a.Promises.Promise.resolve())},this.onButtonPressedBeepHandling=function(e){d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* ViewModelHelper.onButtonPressedBeepHandling(args: "+e+")");let t=arguments[arguments.length-1],i=n.get(t),o={viewKey:u.viewContext.viewKey,viewId:u.viewContext.viewID},r=u.viewContext.viewConfig.privateInput;i.eppKeys&&i.eppKeys.length>1?(u.EVENT_UIRESULT.UILastButtonPressedEPPKey=[e],o.action=r?"*":e,o.eppKeyCmd=!0):(u.EVENT_UIRESULT.UILastButtonPressedEPPKey=i.eppKeys,o.action=r?"*":t),g.write(g.MSG_NUMBERS.MSG_VIEW_INTERACTION,null,JSON.stringify(o),u.viewContext.viewID,u.viewContext.viewKey,t),i.triggeredByEpp||h.state===h.STATE_VALUES.SPEAK||Wincor.UI.Service.Provider.BeepService.beep(2,null)},this.setViewKey=function(e){I=e},this.getViewKey=function(){return I},this.notifyViewUpdated=function(e,t,o){if(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"> ViewModelHelper::notifyViewUpdated("+e+", "+t+")"),e&&-1===e.indexOf("_",e.length-1)&&(e+="_",d.LOG_DETAIL&&d.log(d.LOG_DETAIL,". ViewModelHelper::notifyViewUpdated modified keyPrefix to "+e)),!i.designMode&&(n.whenEppProcessingDone().then((()=>{u.fireContentUpdated(e)})),s._adaEnabled)){s.reset(!0);let i=Object.keys(s._adaInputFieldSubscriptions);for(let e=0;e<i.length;e++){let t=i[e];s._adaInputFieldSubscriptions[t].dispose()}s._adaInputFieldSubscriptions={},s.prepareAda(!1,function(){if(d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* ViewModelHelper::notifyViewUpdated prepareAdaCallback"),!e||t)s.mixAda(),h.speak(" ",1,10,(function(){""!==s._adaTextMap.repeatOnContentChangeResolved().trim()&&(s.postponeViewTimeoutUntilSpeakingStopped(),h.speak(s._adaTextMap.repeatOnContentChangeResolved(),0,10,null))}));else if(Array.isArray(e)){s.mixAda(),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"* ViewModelHelper::notifyViewUpdated prepareAdaCallback - speaking "+e);let t="";for(let i=0;i<e.length;i++){switch(e[i]){case s.ADA_TYPE.HEADLINE:t+=`${s._adaTextMap.headline()} `;break;case s.ADA_TYPE.INSTRUCTION:t+=`${s._adaTextMap.instruction()} `;break;case s.ADA_TYPE.MESSAGE:t+=`${s._adaTextMap.messageResolved()} `;break;case s.ADA_TYPE.STANDARD_KEY:t+=`${s._adaTextMap.standardKeysTextResolved()} `;break;case s.ADA_TYPE.SELECTION_KEY:t+=`${s._adaTextMap.selectionKeysTextResolved()} `;break;case s.ADA_TYPE.FUNCTION_KEY:t+=`${s._adaTextMap.functionKeysTextResolved()} `;break;case s.ADA_TYPE.INPUTFIELD:t+=`${s._adaTextMap.inputTextResolved()} `;break;case s.ADA_TYPE.DYNAMIC_VALUE:t+=`${s._adaTextMap.dynamicTextResolved()} `;break;case s.ADA_TYPE.CHECKBOX:t+=`${s._adaTextMap.checkboxTextResolved()} `}}h.speak(" ",1,10,(function(){""!==t.trim()&&(s.postponeViewTimeoutUntilSpeakingStopped(),h.speak(t,0,10,null))}))}else s.speakAda()}.bind(this),e)}const r=p.activeItem();r.compositionUpdated&&r.compositionUpdated(o),d.LOG_DETAIL&&d.log(d.LOG_DETAIL,"< ViewModelHelper::notifyViewUpdated")},this.triggerEvent=function(t,i){e(this.viewModelEvent).trigger(t,i)},this.handleError=function(e,t){i.designMode?d.error("ViewModelHelper::handleError: "+(t||"")+": "+e):Wincor.UI.Service.Provider.propagateError("ViewModelHelper::handleError "+(t?"\n"+t:""),"OTHER",e)},this.sortByKey=function(e,t,i=!1,o=!0){return e.sort(((e,n)=>{let r=9999,s=9999;return void 0!==e[t]&&(r=i?parseInt(e[t]):e[t]),void 0!==n[t]&&(s=i?parseInt(n[t]):n[t]),o?r<s?-1:r>s?1:0:r>s?-1:r<s?1:0}))},this.convertByExponent=function(e,t){return e*Math.pow(10,t)},this.convertToBoolean=function(e){return!!e&&(!0===e||(isNaN(e)?"true"===e.toLowerCase():parseInt(e)>0))},this.convertToInt=function(e,t=0){let i=parseInt(e??t);return Number.isInteger(i)?i:t},this.convertUTF16toUTF8=function(e){if(!e)return e;let t,i,o="",n=e.length;for(t=0;t<n;t++)i=e.charCodeAt(t),i>=1&&i<=127?o+=e.charAt(t):i>2047?(o+=String.fromCharCode(224|i>>12&15),o+=String.fromCharCode(128|i>>6&63),o+=String.fromCharCode(128|i>>0&63)):(o+=String.fromCharCode(192|i>>6&31),o+=String.fromCharCode(128|i>>0&63));return o},this.convertUTF8toUTF16=function(e){if(!e)return e;let t,i,o,n="",r=0,s=e.length;for(;r<s;)switch(t=L(e.charCodeAt(r++)),t>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:n+=e.charAt(r-1);break;case 12:case 13:i=e.charCodeAt(r++),i=L(i),n+=String.fromCharCode((31&t)<<6|63&i);break;case 14:i=e.charCodeAt(r++),i=L(i),o=e.charCodeAt(r++),o=L(o),n+=String.fromCharCode((15&t)<<12|(63&i)<<6|(63&o)<<0)}return n},this.getPropertyValue=function(e,t){if(arguments[2]=arguments[2]||[],arguments[2][0])return arguments[2][0];if(e){e=Array.isArray(e)?e:[e];for(let i of e)if(i){let e=Object.keys(i);if(e.includes(t))arguments[2].push(i[t]);else for(let o of e)"string"!=typeof i[o]&&"object"==typeof i[o]&&"function"!=typeof i[o]&&this.getPropertyValue(i[o],t,arguments[2])}}return arguments[2][0]},this.getObjectByValue=function(e,t,i){if(e)for(let t=(e=Array.isArray(e)?e:[e]).length-1;t>=0;t--)if(e[t]===i)return e[t]},this.isPropertyAvailable=function(e,t){return void 0!==this.getPropertyValue(e,t)}},o.viewModelHelper=Wincor.UI.Content.ViewModelHelper,Wincor.UI.Content.ViewModelHelper}));