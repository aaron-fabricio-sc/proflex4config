/**
 @preserve
 Copyright (c) 2001-2020 by Wincor Nixdorf International GmbH,
 Heinz-Nixdorf-Ring 1, 33106 Paderborn, Germany

 This software is the confidential and proprietary information
 of Diebold Nixdorf.
 You shall not disclose such Confidential Information and shall
 use it only in accordance with the terms of the license agreement
 you entered into with Diebold Nixdorf.


$MOD$ DesignTimeRunner.js 4.3.1-210205-21-b2828380-1a04bc7d

*/
define(["jquery","knockout","durandal/system","plugins/router","ui-content","code-behind/ViewHelper","config/Config","vm-container","extensions","vm-util/UIMovements","vm-util/StyleResourceResolver","vm-util/UICommanding","vm-util/ViewModelHelper","lib/jquery.throttle-debounce"],(function(e,n,i,t,o,r,a,l,s,d,c,u,g){"use strict";const m=Wincor.UI.Service.Provider.LogProvider,f=Wincor.UI.Service.Provider;let p=!1,v="",w=null,y=null,h=null,T={},b=[],_=[],A=!1;const $={VIEWKEY_KEY:"viewkey",getUrlParam:e=>{var n=window.location.href.split("?");for(let i=0;i<n.length;i++){let t=n[i].split("=");if(t[0]===e)return t[1]}return null},getViewConfig:()=>h,retrieveJSONData:a.retrieveJSONData};function E(e,n){return null!==e&&n?`${e}?${$.VIEWKEY_KEY}=${n}`:""}function x(e){if(o.designModeExtended)return;let n={type:"HELP_POPUP",message:e},i=l.getMainViewModels()[0];i&&i.showPopupMessage("messagepopup.component.html",n)}function O(e){return Array.isArray(e)?e.includes(v):e===v}function D(){return w}function R(e,n,i){if(e){let t=null,o=7;for(let r=0;r<e.length;r++){let a=e[r].action,l=e[r].from;if(a===n)if(i&&l){if(!l.viewkey&&l.context&&l.context.resultfromproperty&&!l.context.logicalandexpression&&o>5)o=5,t=e[r];else if(!l.viewkey&&l.context&&l.context.resultfromproperty&&l.context.logicalandexpression&&o>4)o=4,t=e[r];else if(i===l.viewkey&&!l.context&&o>3)o=3,t=e[r];else if(i===l.viewkey&&l.context&&l.context.resultfromproperty&&!l.context.logicalandexpression&&o>2)o=2,t=e[r];else if(i===l.viewkey&&l.context&&l.context.resultfromproperty&&l.context.logicalandexpression&&o>1){o=1,t=e[r];break}}else 7===o&&(o=6,t=e[r])}return o<7?m.log(m.LOG_DATA,`DesignTimeRunner::seek found a prio='${o}' action=${JSON.stringify(t)}`):m.log(m.LOG_DATA,`DesignTimeRunner::seek no action found better than prio='${o}'`),{candidate:t,priority:o}}return{candidate:null,priority:7}}function I(e,n){let i=!1;function t(e,i){let t=e===i;if(i&&-1!==i.indexOf("EX:"))switch(i=i.substr("EX:".length)){case"SET":case"!EMPTY":t=null!=e&&""!==e;break;case"EMPTY":t=""===e;break;case"!SET":t=null===e;break;default:t=-1!==i.indexOf("![")?e!==(i=(i=i.substr("![".length)).substr(0,i.length-1)):0===i.indexOf("[")?e===(i=(i=i.substr("[".length)).substr(0,i.length-1)):e===n}return t}if(Array.isArray(e)&&Array.isArray(n))for(let o=0;o<e.length&&(i=t(e[o],n[o]),i);o++);else i=t(e,n);return i}async function M(e,n,i){let t,r,a=[],l=e.flow;if(l){for(let e=0;e<l.length;e++)l[e].from&&l[e].from.context&&(r=l[e].from.context,t=r.property,t&&void 0!==r.ifvalue&&(Array.isArray(t)?t.forEach((e=>{a.includes(e)||a.push(e)})):a.includes(t)||a.push(t)));if(a.length&&o.designModeExtended){let e=await f.DataService.getValues(a,null,null);for(let n=0;n<l.length;n++)if(l[n].from&&l[n].from.context&&(r=l[n].from.context,t=r.property,t&&void 0!==r.ifvalue)){let n;if(Array.isArray(t)){n=[];for(let i=0;i<t.length;i++)n.push(e[t[i]])}else n=e[t],null==n&&(n=f.DataService.getPropertyString({propertyName:t}));try{r.resultfromproperty=I(n,r.ifvalue),r.resultfromproperty&&Array.isArray(n)&&(r.logicalandexpression=!0)}catch(e){m.error(`Error while evaluating context property value=${n} expression=${r.ifvalue} error=${e}`),r.resultfromproperty=!1}}}}let s,d=`a. individual lookup with action='${i}'`;s=R(e.flow,i,w),s.candidate||(d=`b. individual lookup with wildcard action='*', original action='${i}'`,s=R(e.flow,"*",w),s.candidate||(d=`c. default action lookup with '${i}'`,s=n.DEFAULT_ACTIONS?R(n.DEFAULT_ACTIONS.flow,i,w):null));let c=s&&s.candidate?"":` NOT FOUND - no match in flow array - please check 'FlowConfig.json/FlowConfigCustom.json' section '${e.name}'!`;return s&&s.candidate?m.log(m.LOG_DATA,`+++++ DesignTimeRunner::getFlowAction flow name: '${e.name}', viewKey=${w}, viewName=${v} found flow action with prio=${s.priority}, used strategy: (${d}), destination: ${JSON.stringify(s.candidate.dest)},\n whole flow action=${JSON.stringify(s.candidate)}`):m.log(m.LOG_DATA,`+++++ DesignTimeRunner::getFlowAction flow name: '${e.name}', viewKey=${w}, viewName=${v}, used strategy: (${d}) failed, destination: ${c}, flow action NOT AVAILABLE`),s?s.candidate:null}function S(e){m.log(m.LOG_INOUT,`> DesignTimeRunner::navigateFromFlowAction flowAction=${JSON.stringify(e)}`),w=e.dest&&e.dest.viewkey?e.dest.viewkey:null,!w&&e.dest&&e.dest.view&&(w=e.dest.view.viewkey);let n=e.dest&&e.dest.viewkey?E("",e.dest.viewkey||""):"",i=l.getMainViewModels()[0];function r(){v="string"==typeof e.dest.view?e.dest.view:e.dest.view.name;const i=t.navigationModel();let r=!1;for(let e=0;e<i.length;e++)if("special"!==i[e].type&&O(i[e].name)){r=!0,$.navigateToRoute(i[e],n);break}r||(o.designMode?(m.error(`DesignTimeRunner::navigateFromFlowAction(force) no route found for view name='${v}' force 'welcome' instead!`),$.navigateToRoute(i[i.findIndex((e=>"welcome"===e.name))],n)):(m.error(`DesignTimeRunner::navigateFromFlowAction(force) no route found for view name='${v}' force 'IdleLoopPresentation' instead!`),w="IdleLoopPresentation",$.navigateToRoute(i[i.findIndex((e=>"idlepresentation"===e.name))],w)))}e.waitconf&&e.waitconf.wait?function(e,n,i){i.showPopupMessage("pleasewait.component.html",{type:"waitpopup"}),window.setTimeout(n,e.waitconf.time)}(e,(()=>{if(i.hidePopupMessage(),e.dest&&e.dest.view)r();else{const n=`DesignTimeRunner::navigateFromFlowAction Warning: No destination object for=${JSON.stringify(e)}`;m.error(n),x(n)}}),i):e.dest&&e.dest.view?r():"BACK"===e.action||m.error("No flow action available to determine what to do next."),m.log(m.LOG_INOUT,"< DesignTimeRunner::navigateFromFlowAction")}function k(){m.log(m.LOG_INOUT,`> DesignTimeRunner::onRouterNavigationComplete currentViewKey=${w}`),$.getFlowActionPlugIn().then((e=>{let n={currentViewKey:D.bind(this),config:a,container:l,serviceProvider:f};if(e[0].onActivateReady)try{e[0].onActivateReady(n).then((i=>{m.log(m.LOG_DATA,`. DesignTimeRunner::onRouterNavigationComplete ${e[1]}.onActivateReady ready, next=${i||""}`),i&&"string"==typeof i?$.navigate(i):i&&(m.error(`Error during 'onActivateReady' in plugin ${e[1]} for viewkey ${w}, cause: No context action set!`),$.navigate(n.action))})).catch((n=>m.error(`Error during 'onActivateReady' in plugin ${e[1]}, cause: ${n}`)))}catch(n){m.error(`Script error during onActivateReady plugin ${e[1]}, cause: ${n}`)}else m.log(m.LOG_DETAIL,`. DesignTimeRunner::onRouterNavigationComplete plugin: ${e[1]} does not contain 'onActivateReady' function.`);m.log(m.LOG_INOUT,"< DesignTimeRunner::onRouterNavigationComplete")})).catch((e=>m.error(`Error loading flow action plugin cause: ${e}`)))}function N(){c.addStyleSheet("design-time-runner.css","../../content/config/");let i=!0;const r=a.viewType,s=e("body").append("<div id='dtr_menu' class='dtr_menu'></div>"),d=e("#dtr_menu"),u=e(window);s.append("<div id='dtr_options_menu' class='dtr_menu'></div>"),s.append(`<div id="dtr_menu_activator" class="dtr_menu_activator" data-bind="click: activateMenu"><svg id="activator_icon" data-bind="svguse: { name: '${a.DSM_MENU_ICON.name}'}"</svg></div>`);let p=e("#dtr_menu_activator");p.css("top",u.innerHeight()/2+"px"),o.designMode?(d.append("<var class='color03-dtr'>Filter: </var><input type='text' placeholder='type view key in' id='generalInputMenu'            class='generalInput' data-bind='value: filterField, valueUpdate: \"afterkeydown\"'/>"),d.append("<ul id='dtr_menu_items' data-bind='foreach: navigationModel'><li class='color04-dtr'>\x3c!-- ko if: $data.name !== 'separator_line' --\x3e<div class='button dtr_menu_item' tabindex='1' data-bind='click: $parent.navigateTo.bind($data, $data)'><var class='dtr_menu_item color03-dtr' data-bind='html: $data.name'></var></div>\x3c!-- /ko --\x3e</li></ul>")):(d.append("<var class='color03-dtr'>Filter: </var><input type='text' placeholder='type view key in' id='generalInputMenu'            class='generalInput' data-bind='value: filterField, valueUpdate: \"afterkeydown\"'/>"),d.append("<ul id='dtr_menu_items' data-bind='foreach: navigationModel'><li class='color04-dtr'>\x3c!-- ko if: $data.name !== 'separator_line' --\x3e<div class='button dtr_menu_item dtr_menu_item_ext' tabindex='1' data-bind='click: $parent.navigateTo.bind($data, $data)'><var class='dtr_menu_item color03-dtr tooltip' data-bind='html: $data.name, attr: {\"data-item-name\": $parent.resolveUrl($data)}'></var></div>\x3c!-- /ko --\x3e</li></ul>"));const v=e("#dtr_options_menu");let y;if(v.append("<ul id='dtr_more_items'  data-bind='foreach: moreOptions'><li class='color04-dtr'><div class='button dtr_menu_item' data-bind='click: $parent.itemAction.bind($data, $data)'><var class='dtr_menu_item color03-dtr' data-bind='html: $data.name'></var></div></li></ul>"),v.css({height:"100px"}),O(o.designMode?0:250),o.designModeExtended){let e=n.observableArray([]),i=f.ViewService.viewContext.viewKeyList,t=null,o=null;g.sortByKey(i,"name");for(let n=0;n<i.length;n++)t=i[n].name.charAt(0),null!==o&&t!==o&&e.push({name:"separator_line"}),("touch"===a.viewType&&-1===i[n].name.indexOf("Ada")||"softkey"===a.viewType)&&e.push(i[n]),o=t;e.splice(0,0,{name:"<span class=color06-dtr>more options</span>",type:"special"}),y={navigationModel:n.observableArray(e.slice(0)),navigateTo:function(e){D(!1,"main_menu"),"special"!==e.type?(f.ViewService.cancel(null),$.navigateToRoute(e,e.url)):D(!0,"context_menu")},filterField:n.observable(""),resolveUrl:function(e){if(!e||!e.url)return"";const n=f.DataService,i=-1!==e.url.indexOf("[&")?n.propResolver(e.url,n.businessData):e.url;return-1===i.indexOf(".html")?`${i}.html`:i}},y.filterField.subscribe((n=>{let i;-1!==n.indexOf("view:")||-1!==n.indexOf("view=")?(i=I(n.substr(5).trim()),y.navigationModel(e().filter((e=>"special"===e.type||!!e.url&&e.url.match(i))))):(i=I(n),y.navigationModel(e().filter((e=>"special"===e.type||e.name.match(i)))))}),null,"change"),n.applyBindings(y,d[0]),_.push(d[0])}else{let i=e.grep(t.navigationModel(),(e=>!e.viewType||e.viewType&&e.viewType===r));t.navigationModel(i),i.push({name:"<span class=color06-dtr>more options</span>",type:"special"}),t.navigationModel.sort(((e,n)=>e.name===n.name?0:e.name<n.name?-1:1)),y={navigationModel:n.observableArray(t.navigationModel().slice(0)),navigateTo:function(e){D(!1,"main_menu"),"special"!==e.type?$.navigateToRoute(e,""):D(!0,"context_menu")},filterField:n.observable("")},y.filterField.subscribe((e=>{let n=I(e);y.navigationModel(t.navigationModel().filter((e=>"special"===e.type||e.name.match(n))))}),null,"change"),n.applyBindings(y,d[0]),_.push(d[0])}const h=e.grep(a.OPTIONS_MENU_ITEMS,(e=>!e.param.viewType||e.param.viewType&&e.param.viewType===r));n.applyBindings({moreOptions:h,itemAction:function(e){D(!1,"context_menu"),e.param.target&&(a[e.param.target]=e.param.value),e.param.action&&e.param.action(l,c,e)}},v[0]),_.push(v[0]),n.applyBindings({activateMenu:function(){"none"===d.css("display")?D(!0,"main_menu"):D(!1,"main_menu")}},p[0]),_.push(p[0]);let T=!1;s.mousemove(e.debounce(700,(e=>{if(T)return;let n=e.pageX;n>=0&&n<=20&&"none"===p.css("display")?(R(!0),window.setTimeout((()=>{"none"===d.css("display")&&R(!1)}),3e3)):("block"===p.css("display")&&n>p.width()||0===n)&&R(!1),"block"===d.css("display")&&n>d.width()&&D(!1,"main_menu"),"block"===v.css("display")&&n>v.width()&&D(!1,"context_menu")})));-1!==navigator.userAgent.indexOf("Mozilla/5.0 (iPad")&&window.setTimeout((function(){let e={name:"IdleLoopPresentation",url:"idlepresentation.html"};w=e.name,$.navigateToRoute(e,e.name)}),1e3);const b=e("#dtr_menu_items");b.find(".button").each(((n,i)=>e(i).attr("tabindex",(n+1).toString())));const A={},E=a.HOTKEY_TOGGLE_MENU[0],x=a.HOTKEY_TOGGLE_MENU[1];function O(e){let n=u.innerWidth(),i=u.innerHeight()-40;d.hide(),v.hide(),d.css("height",i+"px"),v.css("height",i+"px"),n<1200&&(d.css("width",420+e+"px"),v.css("width",420+e+"px")),n>1200&&n<1600?(d.css("width",450+e+"px"),v.css("width",420+e+"px")):n>=1600&&(d.css("width",550+e+"px"),v.css("width",550+e+"px")),p.css("top",i/2+"px")}function D(e,n){let t="main_menu"===n?d:v;e&&!i?t.toggle({effect:"slide",easing:"easeOutExpo",duration:750,complete:()=>{t.css("display","block"),d.find("#generalInputMenu").focus()}}):"block"===t.css("display")&&t.hide({effect:"clip",duration:350,easing:"easeInSine",complete:()=>t.css("display","none")})}function R(e){e?"none"===v.css("display")&&p.toggle({effect:"slide",easing:"easeOutExpo",duration:750,complete:()=>p.css("display","block")}):"block"===p.css("display")&&p.hide({effect:"slide",duration:350,easing:"easeInSine",complete:()=>p.css("display","none")})}function I(e){let n;e&&((e.indexOf("*")>0||-1===e.indexOf("*"))&&(e="^"+e),e.indexOf("*")>-1&&(e=e.replace(/\*/g,".*")));try{n=new RegExp(e,"gi")}catch(n){m.error(`Warning: Can't create a reg expression for the filter field value=${e} please check your text content.`)}return n}u.keydown(e.debounce(50,(function(e){let n=e.which;n===E&&(A[n]=n),n===x&&(A[n]=n);let i=Object.keys(A);if(parseInt(i[0])===E&&parseInt(i[1])===x)T=!T,"none"===d.css("display")?D(!0,"main_menu"):D(!1,"main_menu");else if(13===n){let e=b.find(":focus");e.length>0&&e.click()}}))),u.keyup((e=>delete A[e.which])),u.resize(e.debounce(500,(()=>O(o.designMode?0:250)))),i=!1}return $.getDefaultText=(e,n)=>{const i=a.VIEWS;for(let t of Object.keys(i))if(O(i[t].name)&&(i[t].viewkey===w||O(i[t].name))&&i[t].texts){let o=i[t].texts[e.toLowerCase()];if(o)return o[n.toLowerCase()]}return"N/A"},$.isNavigationInProgress=()=>A,$.getFlowActionPlugIn=()=>s.Promises.promise(((e,n)=>{if(o.designModeExtended){let i=T.defaultPlugIn;T.registeredPlugins.includes(w)&&(i=w),m.log(m.LOG_DATA,`. DesignTimeRunner::getFlowActionPlugIn name=${i}`),require([`core/servicemocks/flowactionplugins/${i}`],(n=>e([n,n.__moduleId__])),(e=>n(e)))}else n("DesignTimeRunner::getFlowActionPlugIn is not within extended design mode.")})),$.onHardwareTriggerAction=(e,n)=>{if(m.log(m.LOG_DATA,`. DesignTimeRunner::onHardwareTriggerAction action=${n}, viewKey=${e}`),o.toolingEDM)return void m.log(m.LOG_DATA,". DesignTimeRunner::onHardwareTriggerAction bypassed in toolingEDM mode.");let i=u.suspend([]);o.designModeExtended?"undefined"===e||e===D()?$.getFlowActionPlugIn().then((e=>{let t={currentViewKey:D.bind(this),config:a,action:n,container:l,serviceProvider:f};if(e[0].onHardwareEvent)try{e[0].onHardwareEvent(t).then((e=>{e=e||t.action,m.log(m.LOG_DATA,`. DesignTimeRunner::onHardwareTriggerAction onHardwareEvent ready after hardware trigger action=${"string"==typeof e?e:JSON.stringify(e)}`),"string"==typeof e?(f.ViewService.endView(f.ViewService.UIRESULT_OK,e),u.resume(i)):"object"==typeof e&&e.dest&&(S(e),u.resume(i))})).catch((n=>m.error(`Error during 'onHardwareEvent' in plugin ${e[1]}, cause: ${n}`)))}catch(n){m.error(`Script error during onActivateReady plugin ${e[1]}, cause:${n}`)}else m.log(m.LOG_DETAIL,`. DesignTimeRunner::onHardwareTriggerAction plugin: ${e[1]} does not contain 'onHardwareEvent' function.`),f.ViewService.endView(f.ViewService.UIRESULT_OK,n),u.resume(i)})).catch((e=>m.error(`Error loading flow action plugin cause: ${e}`))):m.log(m.LOG_INFO,". DesignTimeRunner::onHardwareTriggerAction Trigger not called, because of a conditional media ID configured for viewKey="+e+" must be the current view key."):($.navigate(n),u.resume(i))},$.navigate=e=>{if(A)return void m.log(m.LOG_ANALYSE,". DesignTimeRunner::navigate, a navigation is currently in progress, no navigation allowed!");if(o.toolingEDM)return void m.log(m.LOG_DATA,". DesignTimeRunner::navigate, toolingEDM, do not navigate (bypassed).");let n;if(m.log(m.LOG_DATA,`. DesignTimeRunner::navigate action=${e}`),!e){if(n="DesignTimeRunner::navigate No 'action' given !",m.error(n),o.designMode)return void x(n);e="CANCEL"}if(o.designMode||o.designModeExtended){A=!0;try{"*"!==w&&null!==w||(w=l.currentViewKey);const i=a.FLOW;let t,r=!1;for(let e of Object.keys(i))if(t=i[e],t.view){const e=window.location.href;let n,i,a,l;if(l=-1===e.indexOf("#")?`${t.view.name}.html`:t.view.name,Array.isArray(l)&&(l=l[l.indexOf(v)]),n=e.indexOf(l),o.designMode&&-1!==n){if(a=e.substring(n-1,n),(n-1<0||"/"===a||"#"===a)&&(i=n+l.length,i===e.length||"?"===e.substring(i,i+1))){r=!0;break}}else if(O(t.view.name)){r=!0;break}}m.log(m.LOG_DATA,`. DesignTimeRunner::navigate flowFound=${r}`),r||i.DEFAULT_ACTIONS?(r||(t=i.DEFAULT_ACTIONS),o.designModeExtended?$.getFlowActionPlugIn().then((o=>{let r={currentViewKey:D.bind(this),currentFlow:t.flow,action:e,config:a,container:l,serviceProvider:f};if(o[0].onGuiResult)try{o[0].onGuiResult(r).then((o=>{m.LOG_DATA&&m.log(m.LOG_DATA,`. DesignTimeRunner::navigate to next=${"object"==typeof o?JSON.stringify(o):o}`),o?"object"==typeof o&&o.dest?S(o):"object"==typeof o&&o.name&&o.route&&$.navigateToRoute(o):M(t,i,e).then((i=>{i?S(i):(n=`DesignTimeRunner::navigate Warning:<br>No flow available, no action found or even view name not found for view:<br><i>${v}</i><br> view key:${w} with action = '<b>${e}</b>'`,m.error(n),x(n))})).catch((e=>{A=!1,m.error(`Error getFlowAction by onGuiResult cause: ${e}`)}))})).catch((e=>{A=!1,m.error(`Error while processing flow action plugin ${o[1]}, cause: ${e}`)}))}catch(e){A=!1,m.error(`Script error while processing flow action plugin ${o[1]}, cause: ${e}`)}else m.error(`Plugin ${o[1]} doesn't contain expected function 'onGuiResult' -> now try to get flow from action configuration...`),M(t,i,e).then((e=>{e?S(e):A=!1}))})).catch((e=>{A=!1,m.error(`Error loading flow action plugin cause: ${e}`)})):M(t,i,e).then((i=>{i?S(i):(A=!1,n=`DesignTimeRunner::navigate Warning:<br>No flow available, no action found or even view name not found for view:<br><i>${v}</i><br> view key:${w} with action = '<b>${e}</b>'`,m.error(n),x(n))})).catch((e=>{A=!1,m.error(`Error getFlowAction cause: ${e}`)}))):(A=!1,n=`DesignTimeRunner::navigate Warning:<br>View name not found in config view list for view:<br><i>${l.getMainViewModels()[0]?l.getMainViewModels()[0].currentView:v}</i><br>with action='<b>${e}</b>'`,m.error(n),x(n))}catch(i){A=!1,n="DesignTimeRunner::navigate Error for action = '<i>"+e+"</i>'<br>exception="+i,m.error(n),x(n)}}else A=!1,n=`DesignTimeRunner::navigate Warning !<br><i>${l.getMainViewModels()[0]?l.getMainViewModels()[0].currentView:v}</i> tries to navigate for '<i>${e}</i>'<br>which is not allowed in application mode !`,m.error(n)},$.action=$.navigate,$.navigateToRoute=(e,n)=>{m.log(m.LOG_INOUT,`> DesignTimeRunner::navigateToRoute target=${JSON.stringify(e)}`);try{if(w&&void 0!==n&&""!==n||(w=a.getViewKey(e.name),w=""!==w?w:"*",n=E("",w)),e.url){let n=e.url;-1!==n.indexOf("[")?e.url=n.substr(0,n.indexOf("[")):-1!==n.indexOf(".")&&(e.url=n.substr(0,n.indexOf("."))),l.setViewId(e.url),v=e.url,w=e.name}else l.setViewId(e.name),v=e.name;l.setViewKey(w||"*"),o.designModeExtended?f.ViewService.display({viewKey:w,viewURL:v}):o.designMode&&(y&&y.route===e.route?l.refresh().then((()=>r.removeWaitSpinner())):(l.suspend(),l.cleanNodes(),l.deactivate().then((()=>{l.clean(),l.remove(),t.navigate(e.route+n)})))),y=e}catch(n){const i=`DesignTimeRunner::navigateToRoute Error for route= '<em>${e.name}</em>'<br>exception=${n}`;m.error(i),x(i)}finally{A=!1}m.log(m.LOG_INOUT,"< DesignTimeRunner::navigateToRoute")},$.shutdown=()=>{T=null,e(window).keydown(null),e(window).keyup(null),e(window).resize(null),_.forEach((i=>{n.cleanNode(i),e(i).mousemove(null),e(i).remove()})),_=null,h=null,t.off("router:navigation:composition-complete",null,this),t.off("router:navigation:composition-update",null,this),b.forEach((e=>f.ViewService.deregisterFromServiceEvent(e))),b=null},$.initialize=()=>{const e=f.ViewService;if(w=$.getUrlParam($.VIEWKEY_KEY),m.log(m.LOG_DATA,`. DesignTimeRunner::initialize: _currentViewKey = ${w}.`),l.setViewKey(w||"*"),o.designModeExtended){let n;n=e.registerForServiceEvent(e.SERVICE_EVENTS.VIEW_CLOSING,(function(n){"object"==typeof n&&(n.resultCode!==e.UIRESULT_CANCEL_SW?(m.log(m.LOG_DATA,`. DesignTimeRunner::init VIEW_CLOSING event received next action=${n.resultDetail} for resultCode=${n.resultCode}`),(n.resultCode===e.UIRESULT_TIMEOUT_USER&&!n.resultDetail||!n.resultCode&&!n.resultDetail)&&(n.resultDetail="CANCEL"),window.setTimeout((()=>$.navigate(n.resultDetail)),1)):m.log(m.LOG_DETAIL,". DesignTimeRunner::init VIEW_CLOSING event received because of software cancel"))}),e.DISPOSAL_TRIGGER_SHUTDOWN),b.push(n),n=e.registerForServiceEvent(e.SERVICE_EVENTS.NAVIGATE_SPA,(function(e){w=e.viewKey,v=e.routeName}),!0),b.push(n),o.toolingEDM?m.log(m.LOG_DATA,". DesignTimeRunner::init: no router navigation in toolingEDM mode."):(t.on("router:navigation:composition-complete").then(k.bind(this),this),t.on("router:navigation:composition-update").then(k.bind(this),this))}return s.Promises.promise(((e,n)=>{o.designMode?a.retrieveJSONData("ViewConfigData").then((n=>{h=n,e()})).catch((n=>{h={},m.error("Problem to load file ViewConfigData.json "+n),e()})):a.retrieveJSONData("plugins","../../core/servicemocks/flowactionplugins/").then((n=>{T=n,e()})).catch((e=>{n(e)}))}))},$.setDesignModeInteractions=(n,r=!1)=>{if(m.log(m.LOG_ANALYSE,". DesignTimeRunner::setDesignModeInteractions"),o.designMode||o.designModeExtended){if(!p){p=!0,o.toolingEDM||N.call(this),w=$.getUrlParam($.VIEWKEY_KEY),l.setViewKey(w||"*"),v=t.activeItem().name;let e=window.location.hash;if(e){let n=e.indexOf("?");-1!==n&&(v=e.substring(e.lastIndexOf("/")+1,n),-1!==v.indexOf("#")&&(v=a.initialRoute))}l.setViewId(v),i.updateViewId(),y=a.findRouteByName(v)}if(n&&!o.toolingEDM){const i=e(n),t=a.VIEWS;for(let n of Object.keys(t))if(O(t[n].name)){let o=t[n].mediaIds||t[n].mediaids;if(o){let n,t,a=o.length;for(let l=0;l<a;l++)if(n=o[l],"object"==typeof n&&(t=n.viewkey,n=n.id),!u.hasCommand(n)||r){let o;if(o=i.attr("id")===n?i:i.find(`#${n}`),o.length||(o=i.find(`.${n}`)),r)try{let i=Object.keys(u.commands),t=u.get(n);for(let r=0;r<i.length;r++)if(t&&n!==i[r]){let n=u.commands[i[r]],a=n.element;o.children().each(((i,o)=>{0===n.viewState.value()&&e(o).find(a).length&&(t.viewState.update(2),m.log(m.LOG_INFO,`. DesignTimeRunner::setDesignModeInteractions interaction trigger command with id=${t.id} has been disabled, because at least one of the child elements has an enabled command with id=${n.id} !`))}))}}catch(e){m.error(`DesignTimeRunner::setDesignModeInteractions problem to check command element is child of the mediaId container: ${e}`)}if(o.length&&!r){let e=o.attr("data-bind"),i=`command: {id: '${n}', state: $root.CMDSTATE.NONE, action: $root.designTimeRunner.onHardwareTriggerAction.bind(this,'${t}')}`;e?-1===e.indexOf("command")&&o.attr("data-bind",`${e}, ${i}`):o.attr("data-bind",i)}}}break}}}},$}));